<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>60 / Architecture Diagrams V2</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>
  <style>
    :root {
      --bg: #0a0a0a;
      --surf: #111111;
      --surf2: #1a1a1a;
      --surf3: #222222;
      --bdr: #2a2a2a;
      --bdr2: #333333;
      --acc: #6366f1;
      --acc2: #8b5cf6;
      --txt: #ededed;
      --txt2: #a0a0a0;
      --txt3: #666666;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: var(--bg);
      color: var(--txt);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-size: 14px;
      -webkit-font-smoothing: antialiased;
    }

    /* ── Header ── */
    header {
      background: var(--surf);
      border-bottom: 1px solid var(--bdr);
      height: 56px;
      padding: 0 24px;
      display: flex;
      align-items: center;
      gap: 12px;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .logo {
      width: 28px; height: 28px; border-radius: 6px;
      background: linear-gradient(135deg, var(--acc), var(--acc2));
      display: flex; align-items: center; justify-content: center;
      font-weight: 800; font-size: 12px; color: #fff;
      letter-spacing: -0.5px;
      flex-shrink: 0;
    }
    .header-title {
      display: flex;
      align-items: baseline;
      gap: 8px;
    }
    .lt {
      font-size: 14px;
      font-weight: 600;
      color: var(--txt);
      letter-spacing: -0.2px;
    }
    .ls {
      font-size: 12px;
      color: var(--txt3);
      font-weight: 400;
    }
    .hsep {
      width: 1px; height: 20px;
      background: var(--bdr2);
      flex-shrink: 0;
    }
    .header-right {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .hbg {
      font-size: 11px;
      color: var(--txt3);
      background: var(--surf2);
      border: 1px solid var(--bdr);
      padding: 3px 10px;
      border-radius: 20px;
      font-family: 'JetBrains Mono', monospace;
      letter-spacing: 0.01em;
    }

    /* ── Version toggles ── */
    .ver-toggle { display: flex; align-items: center; gap: 4px; }
    .ver-btn {
      font-size: 11px;
      font-weight: 500;
      padding: 4px 10px;
      border-radius: 5px;
      cursor: pointer;
      border: 1px solid var(--bdr2);
      background: transparent;
      color: var(--txt3);
      transition: all .12s;
      font-family: inherit;
      letter-spacing: 0.01em;
    }
    .ver-btn:hover { color: var(--txt2); border-color: var(--bdr2); background: var(--surf2); }
    .ver-btn.act { background: var(--acc); color: #fff; border-color: var(--acc); }
    .hl-btn {
      font-size: 11px;
      font-weight: 500;
      padding: 4px 10px;
      border-radius: 20px;
      cursor: pointer;
      border: 1px solid var(--bdr2);
      background: transparent;
      color: var(--txt3);
      transition: all .12s;
      display: flex;
      align-items: center;
      gap: 5px;
      font-family: inherit;
    }
    .hl-btn:hover { color: var(--txt2); background: var(--surf2); }
    .hl-btn.act { background: rgba(34,197,94,.1); color: #4ade80; border-color: rgba(34,197,94,.4); }
    .hl-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }

    /* ── Tabs bar ── */
    .tabs {
      background: var(--surf);
      border-bottom: 1px solid var(--bdr);
      padding: 0 24px;
      display: flex;
      overflow-x: auto;
      scrollbar-width: none;
    }
    .tabs::-webkit-scrollbar { display: none; }
    .tab {
      padding: 0 14px;
      height: 42px;
      font-size: 12px;
      font-weight: 500;
      color: var(--txt3);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all .12s;
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      flex-shrink: 0;
      letter-spacing: 0.01em;
    }
    .tab:hover { color: var(--txt2); }
    .tab.act { color: var(--txt); border-bottom-color: var(--acc); }
    .td {
      width: 5px; height: 5px;
      border-radius: 50%;
      background: var(--txt3);
      transition: background .12s;
    }
    .tab.act .td { background: var(--acc); }

    /* ── Main content ── */
    main { padding: 24px; }
    .tp { display: none; }
    .tp.act { display: block; }
    .stl {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 4px;
      letter-spacing: -0.3px;
      color: var(--txt);
    }
    .sds {
      font-size: 12px;
      color: var(--txt3);
      line-height: 1.6;
      max-width: 680px;
    }

    /* ── Pills ── */
    .pills {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin: 16px 0;
    }
    .pill {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 5px 11px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid var(--bdr2);
      background: transparent;
      color: var(--txt3);
      transition: all .12s;
      user-select: none;
      letter-spacing: 0.01em;
    }
    .pill:hover { color: var(--txt2); border-color: var(--bdr2); background: var(--surf2); }
    .pill.act { color: #fff; border-color: transparent; }
    .pill[data-f="overview"].act    { background: #374151; }
    .pill[data-f="frontend"].act    { background: #1d4ed8; }
    .pill[data-f="copilot"].act     { background: #6d28d9; }
    .pill[data-f="skills"].act      { background: #0369a1; }
    .pill[data-f="recording"].act   { background: #0f766e; }
    .pill[data-f="backend"].act     { background: #b45309; }
    .pill[data-f="ai"].act          { background: #be185d; }
    .pill[data-f="integrations"].act { background: #166534; }
    .pill[data-f="cmdcentre"].act   { background: #7c3aed; }
    .pill[data-f="autonomy"].act    { background: #059669; }
    .pill[data-f="proactive"].act   { background: #dc2626; }
    .pill[data-f="slackcopilot"].act { background: #4338ca; }
    .pill[data-f="demo"].act        { background: #a16207; }
    .pill[data-f="credits"].act     { background: #e11d48; }
    .pill[data-f="autopilot"].act   { background: #0e7490; }
    .pill[data-f="orchestrator"].act { background: #c2410c; }
    .pill[data-f="memory"].act       { background: #7e22ce; }
    .pill[data-f="emailsend"].act    { background: #0891b2; }
    .pill[data-f="relgraph"].act     { background: #15803d; }
    .pill[data-f="dailylogs"].act    { background: #b91c1c; }
    .pill[data-f="controlroom"].act  { background: #6d28d9; }

    /* ── Diagram card ── */
    .card {
      background: var(--surf);
      border: 1px solid var(--bdr);
      border-radius: 10px;
      overflow: hidden;
    }
    .cbar {
      padding: 8px 12px;
      border-bottom: 1px solid var(--bdr);
      background: var(--bg);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .dot { width: 10px; height: 10px; border-radius: 50%; }
    .dr { background: #ff5f57; }
    .dy { background: #ffbd2e; }
    .dg { background: #28c840; }
    .cfn {
      font-size: 11px;
      color: var(--txt3);
      margin-left: 4px;
      font-family: 'JetBrains Mono', monospace;
      letter-spacing: 0.01em;
    }

    /* ── Zoom controls ── */
    .zc { margin-left: auto; display: flex; align-items: center; gap: 4px; }
    .zb {
      background: var(--surf2);
      border: 1px solid var(--bdr2);
      color: var(--txt2);
      width: 22px; height: 22px;
      border-radius: 4px;
      font-size: 13px;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all .1s;
      font-family: inherit;
    }
    .zb:hover { background: var(--surf3); color: var(--txt); }
    .zp {
      font-size: 10px;
      color: var(--txt3);
      min-width: 34px;
      text-align: center;
      font-family: 'JetBrains Mono', monospace;
      background: var(--surf2);
      border: 1px solid var(--bdr);
      border-radius: 4px;
      padding: 2px 4px;
    }
    .fsb {
      background: transparent;
      border: 1px solid var(--bdr2);
      color: var(--txt3);
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 10px;
      cursor: pointer;
      margin-left: 4px;
      transition: all .1s;
      font-family: inherit;
      letter-spacing: 0.01em;
    }
    .fsb:hover { color: var(--txt); border-color: var(--bdr2); background: var(--surf2); }

    /* ── Diagram body ── */
    .cbody {
      overflow: hidden;
      background: var(--surf);
      cursor: grab;
      position: relative;
      height: calc(100vh - 260px);
      min-height: 320px;
    }
    .cbody:active { cursor: grabbing; }
    .dstage {
      display: inline-block;
      padding: 28px 24px;
      transform-origin: 0 0;
      min-width: 100%;
    }
    .dstage svg { display: block; max-width: none !important; }

    /* ── Feature view headers ── */
    .fv { display: none; }
    .fv.vis { display: block; }
    .fvh {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }
    .fv-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .fvb {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 10px;
      border-radius: 5px;
      font-size: 11px;
      font-weight: 600;
      color: #fff;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }
    .fvt {
      font-size: 14px;
      font-weight: 600;
      color: var(--txt);
      letter-spacing: -0.2px;
    }
    .fvd {
      font-size: 11px;
      color: var(--txt3);
      margin-top: 2px;
      line-height: 1.5;
    }

    /* ── Fullscreen overlay ── */
    .fso { display: none; position: fixed; inset: 0; z-index: 9999; background: var(--bg); flex-direction: column; }
    .fso.open { display: flex; }
    .fsh {
      background: var(--surf);
      border-bottom: 1px solid var(--bdr);
      padding: 0 18px;
      height: 48px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .fstl { font-size: 12px; font-weight: 600; color: var(--txt); }
    .fscl {
      margin-left: auto;
      background: transparent;
      border: 1px solid var(--bdr2);
      color: var(--txt2);
      padding: 4px 12px;
      border-radius: 5px;
      font-size: 11px;
      cursor: pointer;
      transition: all .1s;
      font-family: inherit;
    }
    .fscl:hover { color: var(--txt); background: var(--surf2); }
    .fsbd {
      flex: 1;
      overflow: hidden;
      cursor: grab;
      padding: 32px;
      display: flex;
      align-items: flex-start;
    }
    .fsbd:active { cursor: grabbing; }
    .fsst { transform-origin: 0 0; display: inline-block; }
    .fszb {
      background: var(--surf);
      border-top: 1px solid var(--bdr);
      padding: 8px 18px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* ── Legend ── */
    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 24px;
      margin-top: 16px;
      padding: 14px 18px;
      background: var(--surf);
      border: 1px solid var(--bdr);
      border-radius: 8px;
    }
    .lgt {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: var(--txt3);
      margin-bottom: 6px;
    }
    .lgi { display: flex; align-items: center; gap: 7px; font-size: 11px; color: var(--txt2); margin-bottom: 4px; }
    .lgc { width: 10px; height: 10px; border-radius: 3px; flex-shrink: 0; }

    /* ── Component tables ── */
    table.kt {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 16px;
      background: var(--surf);
      border: 1px solid var(--bdr);
      border-radius: 8px;
      overflow: hidden;
    }
    table.kt th {
      background: var(--bg);
      padding: 9px 14px;
      text-align: left;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .07em;
      color: var(--txt3);
      border-bottom: 1px solid var(--bdr);
    }
    table.kt td {
      padding: 9px 14px;
      border-bottom: 1px solid var(--bdr);
      color: var(--txt2);
      vertical-align: top;
    }
    table.kt tr:nth-child(even) td { background: rgba(255,255,255,.015); }
    table.kt tr:last-child td { border-bottom: none; }
    table.kt td:first-child {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: var(--acc);
      white-space: nowrap;
    }
    .b { display: inline-block; font-size: 10px; padding: 1px 6px; border-radius: 4px; font-weight: 500; }
    .bp { background: rgba(99,102,241,.12); color: #a5b4fc; }
    .bb { background: rgba(59,130,246,.12); color: #93c5fd; }
    .bg { background: rgba(34,197,94,.12); color: #86efac; }
    .by { background: rgba(234,179,8,.12); color: #fde047; }
    .bx { background: rgba(100,116,139,.12); color: #94a3b8; }

    /* ── States ── */
    .loading { color: var(--txt3); font-size: 12px; padding: 60px; text-align: center; font-family: 'JetBrains Mono', monospace; }
    .merr { color: #f87171; font-size: 11px; padding: 20px; font-family: 'JetBrains Mono', monospace; white-space: pre-wrap; background: #1a0a0a; border-radius: 8px; margin: 20px; border: 1px solid rgba(248,113,113,.2); }

    /* ── V2 badge ── */
    .v2-badge {
      display: inline-block;
      font-size: 9px;
      padding: 1px 5px;
      border-radius: 3px;
      background: rgba(34,197,94,.12);
      color: #4ade80;
      font-weight: 600;
      margin-left: 4px;
      vertical-align: middle;
      letter-spacing: .04em;
      text-transform: uppercase;
    }

    /* ── V1/V2 visibility system ── */
    .v2-only { display: none; }
    .show-v2 .v2-only { display: block; }
    .show-v2 .tab.v2-only { display: flex; }
    .show-v2 .pill.v2-only { display: flex; }
    .show-v2 .fv.v2-only { display: none; }
    .show-v2 .fv.v2-only.vis { display: block; }
    .show-v2 .tp.v2-only { display: none; }
    .show-v2 .tp.v2-only.act { display: block; }
    body.v2-exclusive .v1-content { display: none !important; }
    body.v2-exclusive .tp.v1-content { display: none !important; }
    body.hl-v2 .v2-card { box-shadow: 0 0 0 2px #22c55e, 0 0 20px rgba(34,197,94,.15); }
    body.hl-v2 .v2-badge { animation: v2pulse 1.5s ease-in-out infinite; }
    body.hl-v2 .v2-row { background: rgba(34,197,94,.05); }
    body.hl-v2 .pill.v2-only { box-shadow: 0 0 0 1px rgba(34,197,94,.5); }
    body.hl-v2 .tab.v2-only { box-shadow: inset 0 -2px 0 #22c55e; }
    @keyframes v2pulse { 0%,100% { opacity: 1; } 50% { opacity: .4; } }
  </style>
</head>
<body>

<header>
  <div class="logo">60</div>
  <div class="header-title">
    <span class="lt">Architecture</span>
    <span class="ls">use60.com</span>
  </div>
  <div class="hsep"></div>
  <div class="ver-toggle">
    <button class="ver-btn" onclick="setVer('v1',this)">V1</button>
    <button class="ver-btn act" onclick="setVer('v2',this)">V2</button>
    <button class="ver-btn" onclick="setVer('v2only',this)">V2 Only</button>
  </div>
  <button class="hl-btn" id="hl-btn" onclick="toggleHL()"><span class="hl-dot"></span> Highlight V2</button>
  <div class="header-right">
    <a href="feature_list.html" style="font-size:12px;color:#6366f1;text-decoration:none;padding:4px 12px;border-radius:6px;border:1px solid #2a2a2a;transition:all .15s;" onmouseover="this.style.borderColor='#6366f1';this.style.background='#1a1a1a'" onmouseout="this.style.borderColor='#2a2a2a';this.style.background='transparent'">Feature Catalogue</a>
    <span class="hbg">staging &middot; Feb 2026 &middot; PRD v4 &middot; HITL v2</span>
  </div>
</header>

<div class="tabs">
  <div class="tab act" data-tab="system"    onclick="switchTab('system')"   ><span class="td"></span>System Architecture</div>
  <div class="tab v1-content" data-tab="copilot"   onclick="switchTab('copilot')"  ><span class="td"></span>Copilot Lifecycle</div>
  <div class="tab v1-content" data-tab="recording" onclick="switchTab('recording')"><span class="td"></span>Recording Pipeline</div>
  <div class="tab v1-content" data-tab="skills"    onclick="switchTab('skills')"   ><span class="td"></span>Skills System</div>
  <div class="tab v2-only" data-tab="cmdcentre" onclick="switchTab('cmdcentre')"><span class="td"></span>Command Centre <span class="v2-badge">V2</span></div>
  <div class="tab v2-only" data-tab="autonomy"  onclick="switchTab('autonomy')" ><span class="td"></span>Autonomy System <span class="v2-badge">V2</span></div>
  <div class="tab v2-only" data-tab="proactive" onclick="switchTab('proactive')"><span class="td"></span>Proactive Agents <span class="v2-badge">V2</span></div>
  <div class="tab v2-only" data-tab="credits"   onclick="switchTab('credits')"  ><span class="td"></span>Credit Governance <span class="v2-badge">V2</span></div>
  <div class="tab v2-only" data-tab="autopilot" onclick="switchTab('autopilot')"><span class="td"></span>Autopilot Engine <span class="v2-badge">V2</span></div>
  <div class="tab v2-only" data-tab="orchestrator" onclick="switchTab('orchestrator')"><span class="td"></span>Orchestrator Waves <span class="v2-badge">V2</span></div>
  <div class="tab v2-only" data-tab="emailpipe" onclick="switchTab('emailpipe')"><span class="td"></span>Email Send Pipeline <span class="v2-badge">V2</span></div>
  <div class="tab v2-only" data-tab="relgraph" onclick="switchTab('relgraph')"><span class="td"></span>Relationship Graph <span class="v2-badge">V2</span></div>
  <div class="tab v2-only" data-tab="agentmem" onclick="switchTab('agentmem')"><span class="td"></span>Agent Memory <span class="v2-badge">V2</span></div>
</div>

<main>

<!-- TAB 1: System Architecture -->
<div id="tab-system" class="tp act">
  <div class="stl">System Architecture</div>
  <div class="sds">Full platform overview. Click a feature pill to see a focused diagram for that subsystem.</div>

  <div class="pills">
    <div class="pill act v1-content" data-f="overview"     onclick="showF('overview')"    >Overview</div>
    <div class="pill v1-content"     data-f="frontend"     onclick="showF('frontend')"    >Frontend</div>
    <div class="pill v1-content"     data-f="copilot"      onclick="showF('copilot')"     >Copilot AI</div>
    <div class="pill v1-content"     data-f="skills"       onclick="showF('skills')"      >Skills System</div>
    <div class="pill v1-content"     data-f="recording"    onclick="showF('recording')"   >Recording Pipeline</div>
    <div class="pill v1-content"     data-f="backend"      onclick="showF('backend')"     >Supabase Backend</div>
    <div class="pill v1-content"     data-f="ai"           onclick="showF('ai')"          >AI Providers</div>
    <div class="pill v1-content"     data-f="integrations" onclick="showF('integrations')">Integrations</div>
    <div class="pill v2-only" data-f="cmdcentre"    onclick="showF('cmdcentre')"   >Command Centre <span class="v2-badge">V2</span></div>
    <div class="pill v2-only" data-f="autonomy"     onclick="showF('autonomy')"    >Autonomy <span class="v2-badge">V2</span></div>
    <div class="pill v2-only" data-f="proactive"    onclick="showF('proactive')"   >Proactive Fleet <span class="v2-badge">V2</span></div>
    <div class="pill v2-only" data-f="slackcopilot" onclick="showF('slackcopilot')">Slack Copilot <span class="v2-badge">V2</span></div>
    <div class="pill v2-only" data-f="demo"         onclick="showF('demo')"        >Demo Experience <span class="v2-badge">V2</span></div>
    <div class="pill v2-only" data-f="credits"      onclick="showF('credits')"     >Credit Governance <span class="v2-badge">V2</span></div>
    <div class="pill v2-only" data-f="autopilot"    onclick="showF('autopilot')"   >Autopilot Engine <span class="v2-badge">V2</span></div>
    <div class="pill v2-only" data-f="orchestrator" onclick="showF('orchestrator')">Orchestrator <span class="v2-badge">V2</span></div>
    <div class="pill v2-only" data-f="memory"       onclick="showF('memory')"      >Agent Memory <span class="v2-badge">V2</span></div>
    <div class="pill v2-only" data-f="emailsend"    onclick="showF('emailsend')"   >Email Send <span class="v2-badge">V2</span></div>
    <div class="pill v2-only" data-f="relgraph"     onclick="showF('relgraph')"    >Relationship Graph <span class="v2-badge">V2</span></div>
    <div class="pill v2-only" data-f="dailylogs"    onclick="showF('dailylogs')"   >Daily Logs <span class="v2-badge">V2</span></div>
    <div class="pill v2-only" data-f="controlroom"  onclick="showF('controlroom')" >Control Room <span class="v2-badge">V2</span></div>
  </div>

  <div id="fv-overview" class="fv vis v1-content">
    <div class="card">
      <div class="cbar"><div class="dot dr"></div><div class="dot dy"></div><div class="dot dg"></div><span class="cfn">system-overview.mermaid</span><div class="zc"><button class="zb" onclick="zD('ov',-0.15)">-</button><span class="zp" id="ov-pct">100%</span><button class="zb" onclick="zD('ov',0.15)">+</button><button class="zb" onclick="rD('ov')">R</button><button class="fsb" onclick="openFS('ov','System Overview')">Fullscreen</button></div></div>
      <div class="cbody" id="ov-body"><div class="dstage" id="ov-stage"><div id="ov-container"><div class="loading">Rendering diagram...</div></div></div></div>
    </div>
  </div>

  <div id="fv-frontend" class="fv v1-content">
    <div class="fvh"><div class="fvb" style="background:#1d4ed8">Frontend</div><div><div class="fvt">React 18 + TypeScript + Vite + Tailwind</div><div class="fvd">Component hierarchy, state layers, core feature pages</div></div></div>
    <div class="card">
      <div class="cbar"><div class="dot dr"></div><div class="dot dy"></div><div class="dot dg"></div><span class="cfn">frontend.mermaid</span><div class="zc"><button class="zb" onclick="zD('fe',-0.15)">-</button><span class="zp" id="fe-pct">100%</span><button class="zb" onclick="zD('fe',0.15)">+</button><button class="zb" onclick="rD('fe')">R</button><button class="fsb" onclick="openFS('fe','Frontend')">Fullscreen</button></div></div>
      <div class="cbody" id="fe-body"><div class="dstage" id="fe-stage"><div id="fe-container"><div class="loading">Rendering diagram...</div></div></div></div>
    </div>
  </div>

  <div id="fv-copilot" class="fv v1-content">
    <div class="fvh"><div class="fvb" style="background:#6d28d9">Copilot AI</div><div><div class="fvt">3-Mode Copilot with Smart Routing</div><div class="fvd">Autonomous (Claude), Regular (Gemini), 3-step skill discovery</div></div></div>
    <div class="card">
      <div class="cbar"><div class="dot dr"></div><div class="dot dy"></div><div class="dot dg"></div><span class="cfn">copilot-system.mermaid</span><div class="zc"><button class="zb" onclick="zD('cp',-0.15)">-</button><span class="zp" id="cp-pct">100%</span><button class="zb" onclick="zD('cp',0.15)">+</button><button class="zb" onclick="rD('cp')">R</button><button class="fsb" onclick="openFS('cp','Copilot AI')">Fullscreen</button></div></div>
      <div class="cbody" id="cp-body"><div class="dstage" id="cp-stage"><div id="cp-container"><div class="loading">Rendering diagram...</div></div></div></div>
    </div>
  </div>

  <div id="fv-skills" class="fv v1-content">
    <div class="fvh"><div class="fvb" style="background:#0369a1">Skills System</div><div><div class="fvt">30 Skills - 18 Atomic + 12 Sequences</div><div class="fvd">SKILL.md files synced, compiled per org, embedded, discovered at runtime</div></div></div>
    <div class="card">
      <div class="cbar"><div class="dot dr"></div><div class="dot dy"></div><div class="dot dg"></div><span class="cfn">skills-system.mermaid</span><div class="zc"><button class="zb" onclick="zD('sk',-0.15)">-</button><span class="zp" id="sk-pct">100%</span><button class="zb" onclick="zD('sk',0.15)">+</button><button class="zb" onclick="rD('sk')">R</button><button class="fsb" onclick="openFS('sk','Skills System')">Fullscreen</button></div></div>
      <div class="cbody" id="sk-body"><div class="dstage" id="sk-stage"><div id="sk-container"><div class="loading">Rendering diagram...</div></div></div></div>
    </div>
  </div>

  <div id="fv-recording" class="fv v1-content">
    <div class="fvh"><div class="fvb" style="background:#0f766e">Recording Pipeline</div><div><div class="fvt">4-Phase Recording Pipeline</div><div class="fvd">Bot deploy → S3 upload → Transcription → AI processing</div></div></div>
    <div class="card">
      <div class="cbar"><div class="dot dr"></div><div class="dot dy"></div><div class="dot dg"></div><span class="cfn">recording-simple.mermaid</span><div class="zc"><button class="zb" onclick="zD('rf',-0.15)">-</button><span class="zp" id="rf-pct">100%</span><button class="zb" onclick="zD('rf',0.15)">+</button><button class="zb" onclick="rD('rf')">R</button><button class="fsb" onclick="openFS('rf','Recording Pipeline')">Fullscreen</button></div></div>
      <div class="cbody" id="rf-body"><div class="dstage" id="rf-stage"><div id="rf-container"><div class="loading">Rendering diagram...</div></div></div></div>
    </div>
  </div>

  <div id="fv-backend" class="fv v1-content">
    <div class="fvh"><div class="fvb" style="background:#b45309">Supabase Backend</div><div><div class="fvt">PostgreSQL + Edge Functions + RLS</div><div class="fvd">Auth, CRM tables, copilot storage, skills DB, edge functions, CORS</div></div></div>
    <div class="card">
      <div class="cbar"><div class="dot dr"></div><div class="dot dy"></div><div class="dot dg"></div><span class="cfn">backend.mermaid</span><div class="zc"><button class="zb" onclick="zD('be',-0.15)">-</button><span class="zp" id="be-pct">100%</span><button class="zb" onclick="zD('be',0.15)">+</button><button class="zb" onclick="rD('be')">R</button><button class="fsb" onclick="openFS('be','Supabase Backend')">Fullscreen</button></div></div>
      <div class="cbody" id="be-body"><div class="dstage" id="be-stage"><div id="be-container"><div class="loading">Rendering diagram...</div></div></div></div>
    </div>
  </div>

  <div id="fv-ai" class="fv v1-content">
    <div class="fvh"><div class="fvb" style="background:#be185d">AI Providers</div><div><div class="fvt">Multi-Provider AI Architecture</div><div class="fvd">Anthropic Claude, Google Gemini, OpenAI embeddings, OpenRouter workflow nodes</div></div></div>
    <div class="card">
      <div class="cbar"><div class="dot dr"></div><div class="dot dy"></div><div class="dot dg"></div><span class="cfn">ai-providers.mermaid</span><div class="zc"><button class="zb" onclick="zD('ai',-0.15)">-</button><span class="zp" id="ai-pct">100%</span><button class="zb" onclick="zD('ai',0.15)">+</button><button class="zb" onclick="rD('ai')">R</button><button class="fsb" onclick="openFS('ai','AI Providers')">Fullscreen</button></div></div>
      <div class="cbody" id="ai-body"><div class="dstage" id="ai-stage"><div id="ai-container"><div class="loading">Rendering diagram...</div></div></div></div>
    </div>
  </div>

  <div id="fv-integrations" class="fv v1-content">
    <div class="fvh"><div class="fvb" style="background:#166534">Integrations</div><div><div class="fvt">External Service Integrations</div><div class="fvd">Fathom, MeetingBaaS, Google Calendar, HubSpot, Attio, Instantly, Slack</div></div></div>
    <div class="card">
      <div class="cbar"><div class="dot dr"></div><div class="dot dy"></div><div class="dot dg"></div><span class="cfn">integrations.mermaid</span><div class="zc"><button class="zb" onclick="zD('ig',-0.15)">-</button><span class="zp" id="ig-pct">100%</span><button class="zb" onclick="zD('ig',0.15)">+</button><button class="zb" onclick="rD('ig')">R</button><button class="fsb" onclick="openFS('ig','Integrations')">Fullscreen</button></div></div>
      <div class="cbody" id="ig-body"><div class="dstage" id="ig-stage"><div id="ig-container"><div class="loading">Rendering diagram...</div></div></div></div>
    </div>
  </div>

  <div id="fv-cmdcentre" class="fv v2-only">
    <div class="fvh"><div class="fvb" style="background:#7c3aed">Command Centre <span class="v2-badge">V2</span></div><div><div class="fvt">Proactive Inbox + Autonomy Gate</div><div class="fvd">8 source agents → enrich → prioritise → autonomy resolver → action paths</div></div></div>
    <div class="card v2-card">
      <div class="cbar"><div class="dot dr"></div><div class="dot dy"></div><div class="dot dg"></div><span class="cfn">command-centre.mermaid</span><div class="zc"><button class="zb" onclick="zD('cc',-0.15)">-</button><span class="zp" id="cc-pct">100%</span><button class="zb" onclick="zD('cc',0.15)">+</button><button class="zb" onclick="rD('cc')">R</button><button class="fsb" onclick="openFS('cc','Command Centre')">Fullscreen</button></div></div>
      <div class="cbody" id="cc-body"><div class="dstage" id="cc-stage"><div id="cc-container"><div class="loading">Rendering diagram...</div></div></div></div>
    </div>
  </div>

  <div id="fv-autonomy" class="fv v2-only">
    <div class="fvh"><div class="fvb" style="background:#059669">Autonomy System <span class="v2-badge">V2</span></div><div><div class="fvt">4-Tier Autonomy with Promotion/Demotion</div><div class="fvd">disabled → suggest → approve → auto, with trust signals and preset configs</div></div></div>
    <div class="card v2-card">
      <div class="cbar"><div class="dot dr"></div><div class="dot dy"></div><div class="dot dg"></div><span class="cfn">autonomy-system.mermaid</span><div class="zc"><button class="zb" onclick="zD('au',-0.15)">-</button><span class="zp" id="au-pct">100%</span><button class="zb" onclick="zD('au',0.15)">+</button><button class="zb" onclick="rD('au')">R</button><button class="fsb" onclick="openFS('au','Autonomy System')">Fullscreen</button></div></div>
      <div class="cbody" id="au-body"><div class="dstage" id="au-stage"><div id="au-container"><div class="loading">Rendering diagram...</div></div></div></div>
    </div>
  </div>

  <div id="fv-proactive" class="fv v2-only">
    <div class="fvh"><div class="fvb" style="background:#dc2626">Proactive Fleet <span class="v2-badge">V2</span></div><div><div class="fvt">8-Agent Proactive Fleet</div><div class="fvd">Morning Brief, EOD, Meeting Prep, Deal Risk, Re-Engagement, Coaching, Competitive, Email Signals</div></div></div>
    <div class="card v2-card">
      <div class="cbar"><div class="dot dr"></div><div class="dot dy"></div><div class="dot dg"></div><span class="cfn">proactive-fleet.mermaid</span><div class="zc"><button class="zb" onclick="zD('pf',-0.15)">-</button><span class="zp" id="pf-pct">100%</span><button class="zb" onclick="zD('pf',0.15)">+</button><button class="zb" onclick="rD('pf')">R</button><button class="fsb" onclick="openFS('pf','Proactive Fleet')">Fullscreen</button></div></div>
      <div class="cbody" id="pf-body"><div class="dstage" id="pf-stage"><div id="pf-container"><div class="loading">Rendering diagram...</div></div></div></div>
    </div>
  </div>

  <div id="fv-slackcopilot" class="fv v2-only">
    <div class="fvh"><div class="fvb" style="background:#4338ca">Slack Copilot <span class="v2-badge">V2</span></div><div><div class="fvt">In-Channel Copilot with Intent Classification</div><div class="fvd">8 query types, thread memory, assertive messaging, interactive buttons</div></div></div>
    <div class="card v2-card">
      <div class="cbar"><div class="dot dr"></div><div class="dot dy"></div><div class="dot dg"></div><span class="cfn">slack-copilot.mermaid</span><div class="zc"><button class="zb" onclick="zD('sc',-0.15)">-</button><span class="zp" id="sc-pct">100%</span><button class="zb" onclick="zD('sc',0.15)">+</button><button class="zb" onclick="rD('sc')">R</button><button class="fsb" onclick="openFS('sc','Slack Copilot')">Fullscreen</button></div></div>
      <div class="cbody" id="sc-body"><div class="dstage" id="sc-stage"><div id="sc-container"><div class="loading">Rendering diagram...</div></div></div></div>
    </div>
  </div>

  <div id="fv-demo" class="fv v2-only">
    <div class="fvh"><div class="fvb" style="background:#a16207">Demo Experience <span class="v2-badge">V2</span></div><div><div class="fvt">5-Act Progressive Demo Narrative</div><div class="fvd">Before 60 → Onboarding → Day 1 (10 scenes) → Week 2 → Month 1</div></div></div>
    <div class="card v2-card">
      <div class="cbar"><div class="dot dr"></div><div class="dot dy"></div><div class="dot dg"></div><span class="cfn">demo-experience.mermaid</span><div class="zc"><button class="zb" onclick="zD('dm',-0.15)">-</button><span class="zp" id="dm-pct">100%</span><button class="zb" onclick="zD('dm',0.15)">+</button><button class="zb" onclick="rD('dm')">R</button><button class="fsb" onclick="openFS('dm','Demo Experience')">Fullscreen</button></div></div>
      <div class="cbody" id="dm-body"><div class="dstage" id="dm-stage"><div id="dm-container"><div class="loading">Rendering diagram...</div></div></div></div>
    </div>
  </div>

  <div id="fv-credits" class="fv v2-only">
    <div class="fvh"><div class="fvb" style="background:#e11d48">Credit Governance <span class="v2-badge">V2</span></div><div><div class="fvt">AI Credit Metering + Budget Enforcement</div><div class="fvd">Model router, credit ledger, budget service, fleet throttle, circuit breakers</div></div></div>
    <div class="card v2-card">
      <div class="cbar"><div class="dot dr"></div><div class="dot dy"></div><div class="dot dg"></div><span class="cfn">credit-governance.mermaid</span><div class="zc"><button class="zb" onclick="zD('cg',-0.15)">-</button><span class="zp" id="cg-pct">100%</span><button class="zb" onclick="zD('cg',0.15)">+</button><button class="zb" onclick="rD('cg')">R</button><button class="fsb" onclick="openFS('cg','Credit Governance')">Fullscreen</button></div></div>
      <div class="cbody" id="cg-body"><div class="dstage" id="cg-stage"><div id="cg-container"><div class="loading">Rendering diagram...</div></div></div></div>
    </div>
  </div>

  <div id="fv-autopilot" class="fv v2-only">
    <div class="fvh"><div class="fvb" style="background:#0e7490">Autopilot Engine <span class="v2-badge">V2</span></div><div><div class="fvt">Signal Learning + Confidence Scoring</div><div class="fvd">Record signals → recalculate confidence → evaluate → propose → promote/demote</div></div></div>
    <div class="card v2-card">
      <div class="cbar"><div class="dot dr"></div><div class="dot dy"></div><div class="dot dg"></div><span class="cfn">autopilot-overview.mermaid</span><div class="zc"><button class="zb" onclick="zD('apo',-0.15)">-</button><span class="zp" id="apo-pct">100%</span><button class="zb" onclick="zD('apo',0.15)">+</button><button class="zb" onclick="rD('apo')">R</button><button class="fsb" onclick="openFS('apo','Autopilot Engine')">Fullscreen</button></div></div>
      <div class="cbody" id="apo-body"><div class="dstage" id="apo-stage"><div id="apo-container"><div class="loading">Rendering diagram...</div></div></div></div>
    </div>
  </div>

  <div id="fv-orchestrator" class="fv v2-only">
    <div class="fvh"><div class="fvb" style="background:#c2410c">Orchestrator <span class="v2-badge">V2</span></div><div><div class="fvt">Event-Driven 5-Wave Pipeline</div><div class="fvd">meeting_ended → classify → extract + detect intents + coaching → draft email + tasks + CRM → signal processor → Slack</div></div></div>
    <div class="card v2-card">
      <div class="cbar"><div class="dot dr"></div><div class="dot dy"></div><div class="dot dg"></div><span class="cfn">orchestrator-waves.mermaid</span><div class="zc"><button class="zb" onclick="zD('orch',-0.15)">-</button><span class="zp" id="orch-pct">100%</span><button class="zb" onclick="zD('orch',0.15)">+</button><button class="zb" onclick="rD('orch')">R</button><button class="fsb" onclick="openFS('orch','Orchestrator Waves')">Fullscreen</button></div></div>
      <div class="cbody" id="orch-body"><div class="dstage" id="orch-stage"><div id="orch-container"><div class="loading">Rendering diagram...</div></div></div></div>
    </div>
  </div>

  <div id="fv-memory" class="fv v2-only">
    <div class="fvh"><div class="fvb" style="background:#7e22ce">Agent Memory <span class="v2-badge">V2</span></div><div><div class="fvt">10-Module Event-Sourced Memory System</div><div class="fvd">Deal memory, contact memory with decay, rep memory, commitments, RAG search</div></div></div>
    <div class="card v2-card">
      <div class="cbar"><div class="dot dr"></div><div class="dot dy"></div><div class="dot dg"></div><span class="cfn">agent-memory.mermaid</span><div class="zc"><button class="zb" onclick="zD('mem',-0.15)">-</button><span class="zp" id="mem-pct">100%</span><button class="zb" onclick="zD('mem',0.15)">+</button><button class="zb" onclick="rD('mem')">R</button><button class="fsb" onclick="openFS('mem','Agent Memory')">Fullscreen</button></div></div>
      <div class="cbody" id="mem-body"><div class="dstage" id="mem-stage"><div id="mem-container"><div class="loading">Rendering diagram...</div></div></div></div>
    </div>
  </div>

  <div id="fv-emailsend" class="fv v2-only">
    <div class="fvh"><div class="fvb" style="background:#0891b2">Email Send <span class="v2-badge">V2</span></div><div><div class="fvt">HITL Email Approval + Gmail/O365 Send</div><div class="fvd">Draft → Slack approval (fire-and-forget, tz-aware scheduling) or Control Room deep-link → Gmail signature auto-append → 30s undo</div></div></div>
    <div class="card v2-card">
      <div class="cbar"><div class="dot dr"></div><div class="dot dy"></div><div class="dot dg"></div><span class="cfn">email-send-pipeline.mermaid</span><div class="zc"><button class="zb" onclick="zD('eml',-0.15)">-</button><span class="zp" id="eml-pct">100%</span><button class="zb" onclick="zD('eml',0.15)">+</button><button class="zb" onclick="rD('eml')">R</button><button class="fsb" onclick="openFS('eml','Email Send Pipeline')">Fullscreen</button></div></div>
      <div class="cbody" id="eml-body"><div class="dstage" id="eml-stage"><div id="eml-container"><div class="loading">Rendering diagram...</div></div></div></div>
    </div>
  </div>

  <div id="fv-relgraph" class="fv v2-only">
    <div class="fvh"><div class="fvb" style="background:#15803d">Relationship Graph <span class="v2-badge">V2</span></div><div><div class="fvt">Deal-Contact Intelligence Layer</div><div class="fvd">Role inference → deal_contacts junction → cross-deal stakeholder view → multi-threading score → champion ghost detection</div></div></div>
    <div class="card v2-card">
      <div class="cbar"><div class="dot dr"></div><div class="dot dy"></div><div class="dot dg"></div><span class="cfn">relationship-graph.mermaid</span><div class="zc"><button class="zb" onclick="zD('rg',-0.15)">-</button><span class="zp" id="rg-pct">100%</span><button class="zb" onclick="zD('rg',0.15)">+</button><button class="zb" onclick="rD('rg')">R</button><button class="fsb" onclick="openFS('rg','Relationship Graph')">Fullscreen</button></div></div>
      <div class="cbody" id="rg-body"><div class="dstage" id="rg-stage"><div id="rg-container"><div class="loading">Rendering diagram...</div></div></div></div>
    </div>
  </div>

  <div id="fv-dailylogs" class="fv v2-only">
    <div class="fvh"><div class="fvb" style="background:#b91c1c">Daily Logs <span class="v2-badge">V2</span></div><div><div class="fvt">Agent Audit Trail + Chain Replay</div><div class="fvd">Every orchestrator wave step, email send, fleet agent decision logged with chain_id for full replay</div></div></div>
    <div class="card v2-card">
      <div class="cbar"><div class="dot dr"></div><div class="dot dy"></div><div class="dot dg"></div><span class="cfn">daily-logs.mermaid</span><div class="zc"><button class="zb" onclick="zD('dl',-0.15)">-</button><span class="zp" id="dl-pct">100%</span><button class="zb" onclick="zD('dl',0.15)">+</button><button class="zb" onclick="rD('dl')">R</button><button class="fsb" onclick="openFS('dl','Agent Daily Logs')">Fullscreen</button></div></div>
      <div class="cbody" id="dl-body"><div class="dstage" id="dl-stage"><div id="dl-container"><div class="loading">Rendering diagram...</div></div></div></div>
    </div>
  </div>

  <div id="fv-controlroom" class="fv v2-only">
    <div class="fvh"><div class="fvb" style="background:#6d28d9">Control Room <span class="v2-badge">V2</span></div><div><div class="fvt">Unified Manager Dashboard + HITL Approval</div><div class="fvd">Fleet Pulse + Team Autonomy Matrix + Credit Health + Action Feed + ROI Summary + ApprovalReviewDialog (deep-linked from Slack)</div></div></div>
    <div class="card v2-card">
      <div class="cbar"><div class="dot dr"></div><div class="dot dy"></div><div class="dot dg"></div><span class="cfn">control-room.mermaid</span><div class="zc"><button class="zb" onclick="zD('cr',-0.15)">-</button><span class="zp" id="cr-pct">100%</span><button class="zb" onclick="zD('cr',0.15)">+</button><button class="zb" onclick="rD('cr')">R</button><button class="fsb" onclick="openFS('cr','Control Room')">Fullscreen</button></div></div>
      <div class="cbody" id="cr-body"><div class="dstage" id="cr-stage"><div id="cr-container"><div class="loading">Rendering diagram...</div></div></div></div>
    </div>
  </div>

  <div class="legend">
    <div>
      <div class="lgt">Connections</div>
      <div class="lgi"><svg width="24" height="2"><line x1="0" y1="1" x2="24" y2="1" stroke="#6366f1" stroke-width="1.5"/></svg> Data flow</div>
      <div class="lgi"><svg width="24" height="2"><line x1="0" y1="1" x2="24" y2="1" stroke="#6366f1" stroke-width="1.5" stroke-dasharray="4,3"/></svg> Optional / event-driven</div>
    </div>
    <div>
      <div class="lgt">Node types</div>
      <div class="lgi"><div class="lgc" style="background:#1e1e2e;border:1px solid #6366f1"></div> Subsystem group</div>
      <div class="lgi"><div class="lgc" style="background:#16162a;border:1px solid #3a3a4a"></div> Component</div>
    </div>
    <div>
      <div class="lgt">AI Models</div>
      <div class="lgi"><div class="lgc" style="background:#1a1a2e;border:1px solid #8b5cf6"></div> Anthropic Claude</div>
      <div class="lgi"><div class="lgc" style="background:#1a1a2e;border:1px solid #4285f4"></div> Google Gemini</div>
    </div>
  </div>
</div>

<!-- TAB 2: Copilot Lifecycle -->
<div id="tab-copilot" class="tp v1-content">
  <div class="stl">Copilot Lifecycle</div>
  <div class="sds">Full request/response lifecycle through the copilot system — routing, autonomous execution, skill loading, streaming.</div>

  <div style="margin: 18px 0 12px;">
    <div class="fvh"><div class="fvb" style="background:#6d28d9">Sequence Flow</div><div><div class="fvt">Message Routing Sequence</div><div class="fvd">From user message to streamed response — routing, lazy skill loading, tool iterations</div></div></div>
    <div class="card">
      <div class="cbar"><div class="dot dr"></div><div class="dot dy"></div><div class="dot dg"></div><span class="cfn">copilot-sequence.mermaid</span><div class="zc"><button class="zb" onclick="zD('sq',-0.15)">-</button><span class="zp" id="sq-pct">100%</span><button class="zb" onclick="zD('sq',0.15)">+</button><button class="zb" onclick="rD('sq')">R</button><button class="fsb" onclick="openFS('sq','Copilot Sequence')">Fullscreen</button></div></div>
      <div class="cbody" id="sq-body"><div class="dstage" id="sq-stage"><div id="sq-container"><div class="loading">Rendering diagram...</div></div></div></div>
    </div>
  </div>

  <table class="kt">
    <thead><tr><th>Component</th><th>File</th><th>Role</th><th>Type</th></tr></thead>
    <tbody>
      <tr><td>CopilotContext</td><td>src/lib/contexts/CopilotContext.tsx</td><td>State management, mode routing, sendMessage()</td><td><span class="b bp">Context</span></td></tr>
      <tr><td>copilotRoutingService</td><td>src/lib/services/copilotRoutingService.ts</td><td>3-step skill routing: sequences → triggers → embeddings</td><td><span class="b bb">Service</span></td></tr>
      <tr><td>copilot-autonomous</td><td>supabase/functions/copilot-autonomous/</td><td>Claude Haiku 4.5 native tool_use, streaming SSE</td><td><span class="b bg">Edge Fn</span></td></tr>
      <tr><td>api-copilot</td><td>supabase/functions/api-copilot/</td><td>Gemini 2.5 Flash, 48 response panels, HITL confirm</td><td><span class="b bg">Edge Fn</span></td></tr>
      <tr><td>autonomousExecutor</td><td>src/lib/copilot/agent/autonomousExecutor.ts</td><td>Skill-to-tool conversion, lazy loading, iteration</td><td><span class="b bp">Module</span></td></tr>
      <tr><td>useCopilotChat</td><td>src/lib/hooks/useCopilotChat.ts</td><td>Streaming, tool tracking, progress steps</td><td><span class="b by">Hook</span></td></tr>
    </tbody>
  </table>
</div>

<!-- TAB 3: Recording Pipeline -->
<div id="tab-recording" class="tp v1-content">
  <div class="stl">Recording Pipeline</div>
  <div class="sds">4-phase pipeline: bot deployment → S3 upload with multipart → transcription (AssemblyAI/Gladia) → Claude AI processing.</div>

  <div style="margin: 18px 0 12px;">
    <div class="fvh"><div class="fvb" style="background:#0f766e">Recording Pipeline</div><div><div class="fvt">Full Recording Pipeline — Detailed</div><div class="fvd">All phases with retry logic, dual transcription providers, AI processing</div></div></div>
    <div class="card">
      <div class="cbar"><div class="dot dr"></div><div class="dot dy"></div><div class="dot dg"></div><span class="cfn">recording-pipeline.mermaid</span><div class="zc"><button class="zb" onclick="zD('rp',-0.15)">-</button><span class="zp" id="rp-pct">100%</span><button class="zb" onclick="zD('rp',0.15)">+</button><button class="zb" onclick="rD('rp')">R</button><button class="fsb" onclick="openFS('rp','Recording Pipeline')">Fullscreen</button></div></div>
      <div class="cbody" id="rp-body"><div class="dstage" id="rp-stage"><div id="rp-container"><div class="loading">Rendering diagram...</div></div></div></div>
    </div>
  </div>

  <table class="kt">
    <thead><tr><th>Function</th><th>Trigger</th><th>Purpose</th><th>Phase</th></tr></thead>
    <tbody>
      <tr><td>auto-join-scheduler</td><td>Cron every 2 min</td><td>Deploy MeetingBaaS bot for upcoming meetings</td><td><span class="b bb">1 · Deploy</span></td></tr>
      <tr><td>deploy-recording-bot</td><td>Scheduler call</td><td>MeetingBaaS API — Zoom, Meet, Teams support</td><td><span class="b bb">1 · Deploy</span></td></tr>
      <tr><td>meetingbaas-webhook</td><td>Webhook POST</td><td>Receive bot completion signal, enqueue upload</td><td><span class="b bp">2 · Upload</span></td></tr>
      <tr><td>poll-s3-upload-queue</td><td>Cron</td><td>5MB multipart upload, exponential backoff retry</td><td><span class="b bp">2 · Upload</span></td></tr>
      <tr><td>poll-transcription-queue</td><td>Cron</td><td>AssemblyAI primary, Gladia fallback</td><td><span class="b bg">3 · Transcribe</span></td></tr>
      <tr><td>process-recording</td><td>Transcript ready</td><td>Claude Haiku analysis: summary, highlights, speaker ID</td><td><span class="b by">4 · AI</span></td></tr>
    </tbody>
  </table>
</div>

<!-- TAB 4: Skills System -->
<div id="tab-skills" class="tp v1-content">
  <div class="stl">Skills System</div>
  <div class="sds">30 skills (18 atomic + 12 sequences) defined in SKILL.md files, synced to database, compiled per org with variables resolved, embedded for semantic search.</div>

  <div style="margin: 18px 0 12px;">
    <div class="fvh"><div class="fvb" style="background:#0369a1">Skills System</div><div><div class="fvt">Full Skills Pipeline</div><div class="fvd">Source SKILL.md → sync → platform_skills → compile → organization_skills → runtime RPC</div></div></div>
    <div class="card">
      <div class="cbar"><div class="dot dr"></div><div class="dot dy"></div><div class="dot dg"></div><span class="cfn">skills-full.mermaid</span><div class="zc"><button class="zb" onclick="zD('sf',-0.15)">-</button><span class="zp" id="sf-pct">100%</span><button class="zb" onclick="zD('sf',0.15)">+</button><button class="zb" onclick="rD('sf')">R</button><button class="fsb" onclick="openFS('sf','Skills System')">Fullscreen</button></div></div>
      <div class="cbody" id="sf-body"><div class="dstage" id="sf-stage"><div id="sf-container"><div class="loading">Rendering diagram...</div></div></div></div>
    </div>
  </div>

  <table class="kt">
    <thead><tr><th>Table / RPC</th><th>Purpose</th><th>Notes</th></tr></thead>
    <tbody>
      <tr><td>platform_skills</td><td>Master skill templates with ${variable} placeholders</td><td><span class="b bp">Admin read</span></td></tr>
      <tr><td>organization_skills</td><td>Compiled per-org with variables resolved, is_enabled flag</td><td><span class="b bg">Runtime read</span></td></tr>
      <tr><td>description_embedding</td><td>pgvector 1536-dim embedding of skill description</td><td><span class="b bb">Semantic search</span></td></tr>
      <tr><td>get_organization_skills_for_agent</td><td>RPC returning compiled skills as Claude tool definitions</td><td><span class="b by">All copilot paths</span></td></tr>
      <tr><td>match_skills_by_embedding</td><td>Cosine similarity search, threshold 0.6+</td><td><span class="b bx">Fallback</span></td></tr>
    </tbody>
  </table>
</div>

<!-- TAB 5: Command Centre (V2) -->
<div id="tab-cmdcentre" class="tp v2-only">
  <div class="stl">Command Centre <span class="v2-badge">V2</span></div>
  <div class="sds">Proactive inbox driven by 8 source agents. Items are enriched with live context, scored by AI confidence, then routed through the autonomy gate to CRM, Slack, or user suggestion.</div>

  <div style="margin: 18px 0 12px;">
    <div class="fvh"><div class="fvb" style="background:#7c3aed">Command Centre Sequence <span class="v2-badge">V2</span></div><div><div class="fvt">Full Item Lifecycle — Budget Check to Action</div><div class="fvd">Model routing, enrichment, scoring, autonomy resolution, execution with credit metering</div></div></div>
    <div class="card v2-card">
      <div class="cbar"><div class="dot dr"></div><div class="dot dy"></div><div class="dot dg"></div><span class="cfn">command-centre-pipeline.mermaid</span><div class="zc"><button class="zb" onclick="zD('ccp',-0.15)">-</button><span class="zp" id="ccp-pct">100%</span><button class="zb" onclick="zD('ccp',0.15)">+</button><button class="zb" onclick="rD('ccp')">R</button><button class="fsb" onclick="openFS('ccp','Command Centre Pipeline')">Fullscreen</button></div></div>
      <div class="cbody" id="ccp-body"><div class="dstage" id="ccp-stage"><div id="ccp-container"><div class="loading">Rendering diagram...</div></div></div></div>
    </div>
  </div>
</div>

<!-- TAB 6: Autonomy System (V2) -->
<div id="tab-autonomy" class="tp v2-only">
  <div class="stl">Autonomy System <span class="v2-badge">V2</span></div>
  <div class="sds">4-tier autonomy (disabled → suggest → approve → auto) with resolution chain, policy ceilings, promotion engine, demotion engine, and analytics.</div>

  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 18px;">
    <div>
      <div class="fvh"><div class="fvb" style="background:#059669">Autonomy Resolver <span class="v2-badge">V2</span></div><div><div class="fvt">Policy Resolution Cache</div><div class="fvd">User → Org → Preset → Default, 5 min cache</div></div></div>
      <div class="card v2-card">
        <div class="cbar"><div class="dot dr"></div><div class="dot dy"></div><div class="dot dg"></div><span class="cfn">autonomy-resolver.mermaid</span><div class="zc"><button class="zb" onclick="zD('aur',-0.15)">-</button><span class="zp" id="aur-pct">100%</span><button class="zb" onclick="zD('aur',0.15)">+</button><button class="zb" onclick="rD('aur')">R</button><button class="fsb" onclick="openFS('aur','Autonomy Resolver')">Fullscreen</button></div></div>
        <div class="cbody" id="aur-body" style="height:420px"><div class="dstage" id="aur-stage"><div id="aur-container"><div class="loading">Rendering diagram...</div></div></div></div>
      </div>
    </div>
    <div>
      <div class="fvh"><div class="fvb" style="background:#059669">Tiers &amp; Presets <span class="v2-badge">V2</span></div><div><div class="fvt">4 Tiers + Promotion/Demotion</div><div class="fvd">Trust signals, promotion engine, demotion on violations</div></div></div>
      <div class="card v2-card">
        <div class="cbar"><div class="dot dr"></div><div class="dot dy"></div><div class="dot dg"></div><span class="cfn">autonomy-tiers.mermaid</span><div class="zc"><button class="zb" onclick="zD('au',-0.15)">-</button><span class="zp" id="au-pct">100%</span><button class="zb" onclick="zD('au',0.15)">+</button><button class="zb" onclick="rD('au')">R</button><button class="fsb" onclick="openFS('au','Autonomy Tiers')">Fullscreen</button></div></div>
        <div class="cbody" id="au-body" style="height:420px"><div class="dstage" id="au-stage"><div id="au-container"><div class="loading">Rendering diagram...</div></div></div></div>
      </div>
    </div>
  </div>
</div>

<!-- TAB 7: Proactive Agents (V2) -->
<div id="tab-proactive" class="tp v2-only">
  <div class="stl">Proactive Agents <span class="v2-badge">V2</span></div>
  <div class="sds">Fleet of 8 autonomous agents triggered by cron + events. Each agent enriches with live context, generates assertive messages, routes to Command Centre or Slack.</div>

  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 18px;">
    <div>
      <div class="fvh"><div class="fvb" style="background:#dc2626">Fleet Router <span class="v2-badge">V2</span></div><div><div class="fvt">Agent Fleet Architecture</div><div class="fvd">Triggers, routing, assertive messaging, credit governance</div></div></div>
      <div class="card v2-card">
        <div class="cbar"><div class="dot dr"></div><div class="dot dy"></div><div class="dot dg"></div><span class="cfn">proactive-fleet.mermaid</span><div class="zc"><button class="zb" onclick="zD('pf',-0.15)">-</button><span class="zp" id="pf-pct">100%</span><button class="zb" onclick="zD('pf',0.15)">+</button><button class="zb" onclick="rD('pf')">R</button><button class="fsb" onclick="openFS('pf','Proactive Fleet')">Fullscreen</button></div></div>
        <div class="cbody" id="pf-body" style="height:420px"><div class="dstage" id="pf-stage"><div id="pf-container"><div class="loading">Rendering diagram...</div></div></div></div>
      </div>
    </div>
    <div>
      <div class="fvh"><div class="fvb" style="background:#dc2626">Fleet Detail <span class="v2-badge">V2</span></div><div><div class="fvt">Triggers + Per-Agent Detail</div><div class="fvd">Cron + event triggers, per-agent subgraphs with file sizes</div></div></div>
      <div class="card v2-card">
        <div class="cbar"><div class="dot dr"></div><div class="dot dy"></div><div class="dot dg"></div><span class="cfn">proactive-fleet-detail.mermaid</span><div class="zc"><button class="zb" onclick="zD('pfd',-0.15)">-</button><span class="zp" id="pfd-pct">100%</span><button class="zb" onclick="zD('pfd',0.15)">+</button><button class="zb" onclick="rD('pfd')">R</button><button class="fsb" onclick="openFS('pfd','Fleet Detail')">Fullscreen</button></div></div>
        <div class="cbody" id="pfd-body" style="height:420px"><div class="dstage" id="pfd-stage"><div id="pfd-container"><div class="loading">Rendering diagram...</div></div></div></div>
      </div>
    </div>
  </div>
</div>

<!-- TAB 8: Credit Governance (V2) -->
<div id="tab-credits" class="tp v2-only">
  <div class="stl">Credit Governance <span class="v2-badge">V2</span></div>
  <div class="sds">Every AI call metered through modelRouter → creditLedger → creditBudgetService → fleetThrottle. Hard kill at 100%, Slack alerts at 80%, usage dashboard with per-agent breakdowns.</div>

  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 18px;">
    <div>
      <div class="fvh"><div class="fvb" style="background:#e11d48">Credit Architecture <span class="v2-badge">V2</span></div><div><div class="fvt">Full Credit Governance System</div><div class="fvd">All consumers, model router, ledger, budget enforcement, circuit breakers</div></div></div>
      <div class="card v2-card">
        <div class="cbar"><div class="dot dr"></div><div class="dot dy"></div><div class="dot dg"></div><span class="cfn">credit-governance.mermaid</span><div class="zc"><button class="zb" onclick="zD('cg',-0.15)">-</button><span class="zp" id="cg-pct">100%</span><button class="zb" onclick="zD('cg',0.15)">+</button><button class="zb" onclick="rD('cg')">R</button><button class="fsb" onclick="openFS('cg','Credit Governance')">Fullscreen</button></div></div>
        <div class="cbody" id="cg-body" style="height:420px"><div class="dstage" id="cg-stage"><div id="cg-container"><div class="loading">Rendering diagram...</div></div></div></div>
      </div>
    </div>
    <div>
      <div class="fvh"><div class="fvb" style="background:#e11d48">Credit Flow <span class="v2-badge">V2</span></div><div><div class="fvt">AI Call Lifecycle with Budget Checks</div><div class="fvd">Request → budget check → model select → log → throttle path</div></div></div>
      <div class="card v2-card">
        <div class="cbar"><div class="dot dr"></div><div class="dot dy"></div><div class="dot dg"></div><span class="cfn">credit-flow.mermaid</span><div class="zc"><button class="zb" onclick="zD('cgd',-0.15)">-</button><span class="zp" id="cgd-pct">100%</span><button class="zb" onclick="zD('cgd',0.15)">+</button><button class="zb" onclick="rD('cgd')">R</button><button class="fsb" onclick="openFS('cgd','Credit Flow')">Fullscreen</button></div></div>
        <div class="cbody" id="cgd-body" style="height:420px"><div class="dstage" id="cgd-stage"><div id="cgd-container"><div class="loading">Rendering diagram...</div></div></div></div>
      </div>
    </div>
  </div>
</div>

<!-- TAB 9: Autopilot Engine (V2) -->
<div id="tab-autopilot" class="tp v2-only">
  <div class="stl">Autopilot Engine <span class="v2-badge">V2</span></div>
  <div class="sds">Signal recording → time-decayed confidence scoring → daily evaluation → Slack promotion proposal → autonomy policy update → demotion on undo spikes.</div>

  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 18px;">
    <div>
      <div class="fvh"><div class="fvb" style="background:#0e7490">Autopilot Overview <span class="v2-badge">V2</span></div><div><div class="fvt">Signal Learning Loop</div><div class="fvd">Rubber-stamp guard, time-decay, promotion/demotion cycle</div></div></div>
      <div class="card v2-card">
        <div class="cbar"><div class="dot dr"></div><div class="dot dy"></div><div class="dot dg"></div><span class="cfn">autopilot-overview.mermaid</span><div class="zc"><button class="zb" onclick="zD('apo',-0.15)">-</button><span class="zp" id="apo-pct">100%</span><button class="zb" onclick="zD('apo',0.15)">+</button><button class="zb" onclick="rD('apo')">R</button><button class="fsb" onclick="openFS('apo','Autopilot Overview')">Fullscreen</button></div></div>
        <div class="cbody" id="apo-body" style="height:420px"><div class="dstage" id="apo-stage"><div id="apo-container"><div class="loading">Rendering diagram...</div></div></div></div>
      </div>
    </div>
    <div>
      <div class="fvh"><div class="fvb" style="background:#0e7490">Autopilot Engine Detail <span class="v2-badge">V2</span></div><div><div class="fvt">6-Stage Engine Architecture</div><div class="fvd">Signal recording, DB trigger, daily eval, proposal, demotion, dashboard</div></div></div>
      <div class="card v2-card">
        <div class="cbar"><div class="dot dr"></div><div class="dot dy"></div><div class="dot dg"></div><span class="cfn">autopilot-engine.mermaid</span><div class="zc"><button class="zb" onclick="zD('ape',-0.15)">-</button><span class="zp" id="ape-pct">100%</span><button class="zb" onclick="zD('ape',0.15)">+</button><button class="zb" onclick="rD('ape')">R</button><button class="fsb" onclick="openFS('ape','Autopilot Engine')">Fullscreen</button></div></div>
        <div class="cbody" id="ape-body" style="height:420px"><div class="dstage" id="ape-stage"><div id="ape-container"><div class="loading">Rendering diagram...</div></div></div></div>
      </div>
    </div>
  </div>
</div>

<!-- TAB 10: Orchestrator Waves (V2) -->
<div id="tab-orchestrator" class="tp v2-only">
  <div class="stl">Orchestrator Waves <span class="v2-badge">V2</span></div>
  <div class="sds">Event-driven sequence runner with 5-wave meeting_ended chain, HITL pause/resume, idempotency, 45 adapters, chain depth limits, and dead-letter retry.</div>

  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 18px;">
    <div>
      <div class="fvh"><div class="fvb" style="background:#c2410c">meeting_ended Chain <span class="v2-badge">V2</span></div><div><div class="fvt">5-Wave Post-Meeting Pipeline</div><div class="fvd">Classify → Extract + Detect intents + Coaching → Draft email + Tasks + CRM → Signal processor → Slack</div></div></div>
      <div class="card v2-card">
        <div class="cbar"><div class="dot dr"></div><div class="dot dy"></div><div class="dot dg"></div><span class="cfn">meeting-ended-waves.mermaid</span><div class="zc"><button class="zb" onclick="zD('mew',-0.15)">-</button><span class="zp" id="mew-pct">100%</span><button class="zb" onclick="zD('mew',0.15)">+</button><button class="zb" onclick="rD('mew')">R</button><button class="fsb" onclick="openFS('mew','meeting_ended Waves')">Fullscreen</button></div></div>
        <div class="cbody" id="mew-body" style="height:480px"><div class="dstage" id="mew-stage"><div id="mew-container"><div class="loading">Rendering diagram...</div></div></div></div>
      </div>
    </div>
    <div>
      <div class="fvh"><div class="fvb" style="background:#c2410c">Runner Architecture <span class="v2-badge">V2</span></div><div><div class="fvt">Orchestrator Runner Engine</div><div class="fvd">Idempotency, HITL pause/resume, retry, self-invocation, 45 adapters</div></div></div>
      <div class="card v2-card">
        <div class="cbar"><div class="dot dr"></div><div class="dot dy"></div><div class="dot dg"></div><span class="cfn">orchestrator-runner.mermaid</span><div class="zc"><button class="zb" onclick="zD('orch2',-0.15)">-</button><span class="zp" id="orch2-pct">100%</span><button class="zb" onclick="zD('orch2',0.15)">+</button><button class="zb" onclick="rD('orch2')">R</button><button class="fsb" onclick="openFS('orch2','Orchestrator Runner')">Fullscreen</button></div></div>
        <div class="cbody" id="orch2-body" style="height:480px"><div class="dstage" id="orch2-stage"><div id="orch2-container"><div class="loading">Rendering diagram...</div></div></div></div>
      </div>
    </div>
  </div>

  <table class="kt">
    <thead><tr><th>Component</th><th>File</th><th>Role</th><th>Type</th></tr></thead>
    <tbody>
      <tr><td>agent-orchestrator</td><td>supabase/functions/agent-orchestrator/</td><td>Entry point: runSequence(), resumeSequence(), retry_dead_letters</td><td><span class="b bg">Edge Fn</span></td></tr>
      <tr><td>runner.ts</td><td>supabase/functions/_shared/orchestrator/runner.ts</td><td>Execution engine: step iteration, HITL pause, retry, self-invocation</td><td><span class="b bp">Module</span></td></tr>
      <tr><td>fleetRouter.ts</td><td>supabase/functions/_shared/orchestrator/fleetRouter.ts</td><td>Event → sequence resolution, parallel dispatch</td><td><span class="b bp">Module</span></td></tr>
      <tr><td>45 Adapters</td><td>supabase/functions/_shared/orchestrator/adapters/</td><td>Email, CRM, calendar, proposal, risk, coaching, reengagement, etc. notifySlackSummary no longer duplicates email draft notifications (handled by emailDraftApproval adapter)</td><td><span class="b bb">Adapters</span></td></tr>
      <tr><td>sequence_jobs</td><td>PostgreSQL table</td><td>Job state: paused_at, output, error, chain depth tracking</td><td><span class="b by">Table</span></td></tr>
      <tr><td>hitl_pending_approvals</td><td>PostgreSQL table</td><td>HITL approval queue with resource_type, callback, expiry</td><td><span class="b by">Table</span></td></tr>
    </tbody>
  </table>
</div>

<!-- TAB 11: Email Send Pipeline (V2) -->
<div id="tab-emailpipe" class="tp v2-only">
  <div class="stl">Email Send Pipeline <span class="v2-badge">V2</span></div>
  <div class="sds">End-to-end path from meeting transcription to sent follow-up email. Draft generated in Wave 3, Slack HITL approval (fire-and-forget modals, timezone-aware scheduling, editable To field), in-app review via Control Room deep-link, Gmail signature auto-append, plain-text to HTML conversion, 30s undo window, daily caps, and autonomy signal capture.</div>

  <div style="margin: 18px 0 12px;">
    <div class="fvh"><div class="fvb" style="background:#0891b2">Email Send Flow <span class="v2-badge">V2</span></div><div><div class="fvt">Meeting → Draft → Approve → Send</div><div class="fvd">Complete HITL lifecycle with Slack fire-and-forget modals, Control Room deep-link, Gmail signature, plain-text→HTML, undo, threading, and autonomy learning</div></div></div>
    <div class="card v2-card">
      <div class="cbar"><div class="dot dr"></div><div class="dot dy"></div><div class="dot dg"></div><span class="cfn">email-send-sequence.mermaid</span><div class="zc"><button class="zb" onclick="zD('esq',-0.15)">-</button><span class="zp" id="esq-pct">100%</span><button class="zb" onclick="zD('esq',0.15)">+</button><button class="zb" onclick="rD('esq')">R</button><button class="fsb" onclick="openFS('esq','Email Send Sequence')">Fullscreen</button></div></div>
      <div class="cbody" id="esq-body"><div class="dstage" id="esq-stage"><div id="esq-container"><div class="loading">Rendering diagram...</div></div></div></div>
    </div>
  </div>

  <table class="kt">
    <thead><tr><th>Component</th><th>File</th><th>Role</th><th>Type</th></tr></thead>
    <tbody>
      <tr><td>draft-followup-email</td><td>Wave 3 adapter (emailSend.ts)</td><td>AI-generated follow-up using Acknowledge-Advance framework</td><td><span class="b bg">Adapter</span></td></tr>
      <tr><td>slack-hitl-notification</td><td>supabase/functions/slack-hitl-notification/</td><td>Block Kit message with email preview + 4 action buttons</td><td><span class="b bg">Edge Fn</span></td></tr>
      <tr><td>slack-interactive</td><td>supabase/functions/slack-interactive/index.ts</td><td>Routes Approve/Edit/Schedule/Skip. Fire-and-forget modal submit. Parallel token+validation. Timezone-aware scheduling via Slack tz_offset</td><td><span class="b bg">Edge Fn</span></td></tr>
      <tr><td>hitl-send-followup-email</td><td>supabase/functions/hitl-send-followup-email/</td><td>Receives approval, converts plain-text to HTML, calls google-gmail or ms-graph-email</td><td><span class="b bg">Edge Fn</span></td></tr>
      <tr><td>google-gmail</td><td>supabase/functions/google-gmail/</td><td>Gmail API send with thread-aware In-Reply-To headers. Auto-appends Gmail signature via sendAs API</td><td><span class="b bb">Edge Fn</span></td></tr>
      <tr><td>ApprovalReviewDialog</td><td>src/components/control-room/ApprovalReviewDialog.tsx</td><td>In-app HITL review at /admin/control-room?approval=id. Editable To/Subject/Body. Deep-linked from Slack</td><td><span class="b bp">Component</span></td></tr>
      <tr><td>autopilot_confidence</td><td>PostgreSQL table</td><td>email.send starts at approve tier, signals from HITL actions</td><td><span class="b by">Table</span></td></tr>
    </tbody>
  </table>
</div>

<!-- TAB 12: Relationship Graph (V2) -->
<div id="tab-relgraph" class="tp v2-only">
  <div class="stl">Relationship Graph <span class="v2-badge">V2</span></div>
  <div class="sds">Intelligence layer built on deal_contacts junction table. Role inference from transcripts and email patterns, cross-deal stakeholder queries, multi-threading scores, job change detection, and champion ghost detection.</div>

  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 18px;">
    <div>
      <div class="fvh"><div class="fvb" style="background:#15803d">Graph Data Model <span class="v2-badge">V2</span></div><div><div class="fvt">deal_contacts + contact_org_history</div><div class="fvd">Junction table with role inference, confidence scoring, cross-deal queries</div></div></div>
      <div class="card v2-card">
        <div class="cbar"><div class="dot dr"></div><div class="dot dy"></div><div class="dot dg"></div><span class="cfn">rel-graph-schema.mermaid</span><div class="zc"><button class="zb" onclick="zD('rgs',-0.15)">-</button><span class="zp" id="rgs-pct">100%</span><button class="zb" onclick="zD('rgs',0.15)">+</button><button class="zb" onclick="rD('rgs')">R</button><button class="fsb" onclick="openFS('rgs','Graph Schema')">Fullscreen</button></div></div>
        <div class="cbody" id="rgs-body" style="height:420px"><div class="dstage" id="rgs-stage"><div id="rgs-container"><div class="loading">Rendering diagram...</div></div></div></div>
      </div>
    </div>
    <div>
      <div class="fvh"><div class="fvb" style="background:#15803d">Intelligence Pipeline <span class="v2-badge">V2</span></div><div><div class="fvt">Inference → Scoring → Alerts</div><div class="fvd">Transcript + email role inference, multi-threading, champion ghost detection, job change monitoring</div></div></div>
      <div class="card v2-card">
        <div class="cbar"><div class="dot dr"></div><div class="dot dy"></div><div class="dot dg"></div><span class="cfn">rel-graph-pipeline.mermaid</span><div class="zc"><button class="zb" onclick="zD('rgp',-0.15)">-</button><span class="zp" id="rgp-pct">100%</span><button class="zb" onclick="zD('rgp',0.15)">+</button><button class="zb" onclick="rD('rgp')">R</button><button class="fsb" onclick="openFS('rgp','Graph Intelligence')">Fullscreen</button></div></div>
        <div class="cbody" id="rgp-body" style="height:420px"><div class="dstage" id="rgp-stage"><div id="rgp-container"><div class="loading">Rendering diagram...</div></div></div></div>
      </div>
    </div>
  </div>

  <table class="kt">
    <thead><tr><th>Table / RPC</th><th>Purpose</th><th>Notes</th></tr></thead>
    <tbody>
      <tr><td>deal_contacts</td><td>Junction: deal_id, contact_id, role, confidence, inferred_from, last_active</td><td><span class="b bg">New schema</span></td></tr>
      <tr><td>contact_org_history</td><td>Job change tracking: contact_id, company_id, title, started_at, ended_at</td><td><span class="b bg">New schema</span></td></tr>
      <tr><td>get_cross_deal_stakeholders</td><td>RPC: contacts appearing across multiple open deals with roles</td><td><span class="b bb">New RPC</span></td></tr>
      <tr><td>get_deal_stakeholder_map</td><td>RPC: all contacts on a deal with roles and confidence</td><td><span class="b bb">New RPC</span></td></tr>
      <tr><td>roleInference.ts</td><td>Adapter: transcript-based role classification in Wave 2</td><td><span class="b bp">New adapter</span></td></tr>
      <tr><td>emailRoleInference.ts</td><td>Adapter: CC/BCC/reply authority pattern analysis</td><td><span class="b bp">New adapter</span></td></tr>
    </tbody>
  </table>
</div>

<!-- TAB 13: Agent Memory (V2) -->
<div id="tab-agentmem" class="tp v2-only">
  <div class="stl">Agent Memory <span class="v2-badge">V2</span></div>
  <div class="sds">10-module event-sourced memory system in _shared/memory/. Deal memory, contact memory with time-decay, rep memory, commitment tracking, RAG search. Plus agent_daily_logs audit trail (PRD-03).</div>

  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 18px;">
    <div>
      <div class="fvh"><div class="fvb" style="background:#7e22ce">Memory Modules <span class="v2-badge">V2</span></div><div><div class="fvt">10-File Shared Memory System</div><div class="fvd">Reader, writer, decay, contacts, reps, commitments, taxonomy, types, snapshot, RAG</div></div></div>
      <div class="card v2-card">
        <div class="cbar"><div class="dot dr"></div><div class="dot dy"></div><div class="dot dg"></div><span class="cfn">memory-modules.mermaid</span><div class="zc"><button class="zb" onclick="zD('mem',-0.15)">-</button><span class="zp" id="mem-pct">100%</span><button class="zb" onclick="zD('mem',0.15)">+</button><button class="zb" onclick="rD('mem')">R</button><button class="fsb" onclick="openFS('mem','Memory Modules')">Fullscreen</button></div></div>
        <div class="cbody" id="mem-body" style="height:420px"><div class="dstage" id="mem-stage"><div id="mem-container"><div class="loading">Rendering diagram...</div></div></div></div>
      </div>
    </div>
    <div>
      <div class="fvh"><div class="fvb" style="background:#b91c1c">Agent Daily Logs <span class="v2-badge">V2</span></div><div><div class="fvt">Audit Trail + Chain Replay</div><div class="fvd">agent_daily_logs table, logAgentAction(), orchestrator hooks, 90-day retention</div></div></div>
      <div class="card v2-card">
        <div class="cbar"><div class="dot dr"></div><div class="dot dy"></div><div class="dot dg"></div><span class="cfn">daily-logs.mermaid</span><div class="zc"><button class="zb" onclick="zD('dl',-0.15)">-</button><span class="zp" id="dl-pct">100%</span><button class="zb" onclick="zD('dl',0.15)">+</button><button class="zb" onclick="rD('dl')">R</button><button class="fsb" onclick="openFS('dl','Agent Daily Logs')">Fullscreen</button></div></div>
        <div class="cbody" id="dl-body" style="height:420px"><div class="dstage" id="dl-stage"><div id="dl-container"><div class="loading">Rendering diagram...</div></div></div></div>
      </div>
    </div>
  </div>

  <table class="kt">
    <thead><tr><th>Module / Table</th><th>File</th><th>Role</th><th>Type</th></tr></thead>
    <tbody>
      <tr><td>reader.ts</td><td>supabase/functions/_shared/memory/reader.ts</td><td>Memory recall with relevance scoring</td><td><span class="b bp">Module</span></td></tr>
      <tr><td>writer.ts</td><td>supabase/functions/_shared/memory/writer.ts</td><td>Fire-and-forget memory persistence</td><td><span class="b bp">Module</span></td></tr>
      <tr><td>decay.ts</td><td>supabase/functions/_shared/memory/decay.ts</td><td>Time-decay for contact memory freshness</td><td><span class="b bp">Module</span></td></tr>
      <tr><td>contacts.ts</td><td>supabase/functions/_shared/memory/contacts.ts</td><td>Contact-specific memory operations</td><td><span class="b bp">Module</span></td></tr>
      <tr><td>commitments.ts</td><td>supabase/functions/_shared/memory/commitments.ts</td><td>Track commitments from meetings and emails</td><td><span class="b bp">Module</span></td></tr>
      <tr><td>ragClient.ts</td><td>supabase/functions/_shared/memory/ragClient.ts</td><td>RAG search across memory stores</td><td><span class="b bp">Module</span></td></tr>
      <tr><td>dailyLog.ts</td><td>supabase/functions/_shared/memory/dailyLog.ts</td><td>logAgentAction() — audit trail for all agent actions</td><td><span class="b bg">New module</span></td></tr>
      <tr><td>copilot_memories</td><td>PostgreSQL table</td><td>User-scoped memory with category, confidence, decay</td><td><span class="b by">Table</span></td></tr>
      <tr><td>agent_daily_logs</td><td>PostgreSQL table</td><td>Audit trail: agent_type, action_type, chain_id, wave_number, 90-day retention</td><td><span class="b bg">New table</span></td></tr>
    </tbody>
  </table>
</div>

</main>

<!-- Fullscreen overlay -->
<div class="fso" id="fso">
  <div class="fsh">
    <div class="dot dr"></div><div class="dot dy"></div><div class="dot dg"></div>
    <span class="fstl" id="fstl">Diagram</span>
    <button class="fscl" onclick="closeFS()">Close &nbsp;ESC</button>
  </div>
  <div class="fsbd" id="fsbd">
    <div class="fsst" id="fsst"></div>
  </div>
  <div class="fszb">
    <button class="zb" onclick="zFS(-0.15)">-</button>
    <span class="zp" id="fs-pct">100%</span>
    <button class="zb" onclick="zFS(0.15)">+</button>
    <button class="zb" onclick="rFS()">R</button>
  </div>
</div>

<script>
// ── All diagram text stored as JS strings (bypasses HTML parser entirely) ──────

var DIAGRAMS = {

ov: [
  'flowchart LR',
  '    subgraph USR["User"]',
  '        WEB["app.use60.com"]',
  '        LAND["www.use60.com"]',
  '    end',
  '    subgraph FE["Frontend"]',
  '        SA["Supabase Auth"]',
  '        ZS["Zustand UI State"]',
  '        RQ["React Query Server"]',
  '        PL["Pipeline"]',
  '        CO["Contacts"]',
  '        ME["Meetings"]',
  '        TA["Tasks"]',
  '        CH["Chat Shell"]',
  '        PA["48 Panels"]',
  '        SKB["Skill Builder"]',
  '    end',
  '    subgraph ROUTE["Copilot Routing"]',
  '        MS["sendMessage()"]',
  '        R1["Sequence 0.7+"]',
  '        R2["Skill Trigger 0.5+"]',
  '        R3["Embedding 0.6+"]',
  '        MS --> R1 --> R2 --> R3',
  '    end',
  '    subgraph AUTO["Autonomous Mode - Default"]',
  '        AEF["copilot-autonomous"]',
  '        CAI["Claude Haiku 4.5"]',
  '        EXC["autonomousExecutor"]',
  '        AEF --> CAI --> EXC',
  '    end',
  '    subgraph REG["Regular Mode - Fallback"]',
  '        AC["api-copilot"]',
  '        GM["Gemini 2.5 Flash"]',
  '        AC --> GM',
  '    end',
  '    subgraph SKLS["Skills 30 total"]',
  '        SM["SKILL.md files"]',
  '        SY["sync-skills.ts"]',
  '        PS["platform_skills"]',
  '        OS["organization_skills"]',
  '        EM["Embeddings OpenAI"]',
  '        SM --> SY --> PS --> OS',
  '        PS --> EM',
  '    end',
  '    subgraph SB["Supabase Backend"]',
  '        DC["meetings deals contacts tasks\\ndeal_stage_history\\nstage_id FK schema"]',
  '        EC["Copilot edge functions"]',
  '        ER["Recording edge functions"]',
  '        RT["Realtime"]',
  '    end',
  '    subgraph REC["Recording Pipeline"]',
  '        BD["Bot Deploy MeetingBaaS"]',
  '        S3["S3 Upload 5MB chunks"]',
  '        TR["Transcription AssemblyAI"]',
  '        PR["AI Processing Claude"]',
  '        BD --> S3 --> TR --> PR',
  '    end',
  '    subgraph AIP["AI Providers"]',
  '        AN["Anthropic Claude"]',
  '        GO["Google Gemini"]',
  '        OA["OpenAI Embeddings"]',
  '    end',
  '    subgraph INT["Integrations"]',
  '        FA["Fathom"]',
  '        GC["Google Calendar"]',
  '        SL["Slack"]',
  '        HB["HubSpot"]',
  '        AT["Attio"]',
  '        IN["Instantly"]',
  '    end',
  '    LAND --> WEB',
  '    WEB --> FE',
  '    CH --> ROUTE',
  '    R1 --> AUTO',
  '    R2 --> AUTO',
  '    R3 --> AUTO',
  '    R1 -.-> REG',
  '    OS -->|RPC| ROUTE',
  '    EXC -->|4 tools| EC',
  '    EC --> DC',
  '    ER --> DC',
  '    PR -->|sync| DC',
  '    GC -->|events| BD',
  '    AN --> AEF',
  '    AN -->|analysis| PR',
  '    GO --> AC',
  '    OA --> EM',
  '    FA -->|transcripts| DC',
  '    SL -.->|alerts| EC',
  '    HB -.->|CRM sync| EC',
  '    AT -.->|CRM sync| EC',
  '    IN -.->|campaigns| EC',
  '    AUTO -->|streaming| CH',
  '    REG -->|streaming| CH',
  '    RT --> RQ',
  '    REC -->|ready| ME',
  '    subgraph CMDCTR["Command Centre V2"]',
  '        CCQ["Proactive Inbox"]',
  '        CCE["Enrich Pipeline"]',
  '        CCA["Autonomy Gate"]',
  '        CCQ --> CCE --> CCA',
  '    end',
  '    subgraph FLEET["Proactive Fleet V2"]',
  '        MBR["Morning Brief"]',
  '        EOD["EOD Synthesis"]',
  '        IMP["Meeting Prep"]',
  '        DRK["Deal Risk"]',
  '        REG["Re-Engagement"]',
  '        COC["Coaching"]',
  '        CCI["Competitive Intel"]',
  '        ESG["Email Signals"]',
  '    end',
  '    subgraph SLKCP["Slack Copilot V2"]',
  '        SCV["slack-copilot"]',
  '        ICL["Intent Classifier"]',
  '        ASM["Assertive Messages"]',
  '        SCV --> ICL --> ASM',
  '    end',
  '    subgraph CRGOV["Credit Governance V2"]',
  '        CLGR["creditLedger\\nmeters all AI calls"]',
  '        CBGT["Budget Enforcement\\nuser + org limits"]',
  '        FTHR["Fleet Throttle\\ncircuit breaker at 80%"]',
  '        MROUTE["Model Router\\ncheapest capable model"]',
  '        CLGR --> CBGT --> FTHR',
  '    end',
  '    subgraph ORCH2["Orchestrator V2"]',
  '        ORCHR["agent-orchestrator\\n5-wave meeting_ended chain\\n45 adapters"]',
  '        ORCHH["HITL Pause/Resume\\nhitl_pending_approvals"]',
  '        ORCHR --> ORCHH',
  '    end',
  '    subgraph EMAILP["Email Send Pipeline V2"]',
  '        EDFT["draft-followup-email\\nWave 3"]',
  '        EHITL["Slack HITL Approval\\nApprove Edit Schedule Skip\\nfire-and-forget modals\\ntimezone-aware scheduling"]',
  '        EARD["Control Room Deep-Link\\nApprovalReviewDialog\\neditable To Subject Body"]',
  '        ESEND["hitl-send-followup-email\\nGmail signature auto-append\\nplain-text to HTML\\nGmail + O365"]',
  '        EDFT --> EHITL --> ESEND',
  '        EHITL -.-> EARD --> ESEND',
  '    end',
  '    subgraph AGMEM["Agent Memory V2"]',
  '        AMEM["_shared/memory\\n10 modules\\ndeal contact rep"]',
  '        ADLG["agent_daily_logs\\naudit trail\\nchain replay"]',
  '    end',
  '    subgraph RELGR["Relationship Graph V2"]',
  '        RJNC["deal_contacts\\nrole inference\\nchampion blocker buyer"]',
  '        RMTS["Multi-threading\\njob change\\nghost detection"]',
  '    end',
  '    subgraph CTRLRM["Control Room V2"]',
  '        CRFP["Fleet Pulse"]',
  '        CRAM["Team Autonomy Matrix"]',
  '        CRAF["Action Feed"]',
  '        CRARD["ApprovalReviewDialog\\ndeep-link from Slack HITL"]',
  '    end',
  '    FLEET -->|items| CCQ',
  '    CCA -->|auto| DC',
  '    CCA -->|notify| ASM',
  '    SL -->|events| SCV',
  '    ASM --> SL',
  '    FLEET -.->|metered| CLGR',
  '    AEF -.->|metered| CLGR',
  '    CCE -.->|metered| CLGR',
  '    SCV -.->|metered| CLGR',
  '    FTHR -.->|throttle| FLEET',
  '    MROUTE -.->|route| AIP',
  '    REC -->|meeting_completed| ORCHR',
  '    ORCHR --> EMAILP',
  '    ORCHR --> RELGR',
  '    ORCHR -.->|logs| ADLG',
  '    AMEM --> ORCHR',
  '    ESEND --> SL',
  '    ADLG --> CTRLRM',
  '    CRARD -->|approve| ESEND',
  '    EHITL -.->|deep link| CRARD',
  '    RMTS --> FLEET'
].join('\n'),

fe: [
  'flowchart LR',
  '    subgraph AUTH["Authentication"]',
  '        SA["Supabase Auth - JWT sessions"]',
  '        CL["Clerk - alternative provider"]',
  '    end',
  '    subgraph STATE["State Management"]',
  '        ZS["Zustand - UI State\\norg sidebar modals preferences"]',
  '        RQ["React Query - Server Data\\ncaching invalidation realtime"]',
  '        SL["ServiceLocator - DI container\\nuseServices hook"]',
  '    end',
  '    subgraph PAGES["Core Feature Pages"]',
  '        PIP["Pipeline\\nKanban and table views"]',
  '        CON["Contacts\\nPeople and companies"]',
  '        MTG["Meetings\\nRecordings and AI summary"]',
  '        TSK["Tasks\\nAction items and follow-ups"]',
  '        DRR["Deal Record\\nStage history timeline\\ndeal_stage_history table"]',
  '        SET["Settings\\nIntegrations and Skill builder"]',
  '    end',
  '    subgraph COP["Copilot UI"]',
  '        AS["AssistantShell - main container"]',
  '        ML["Message list - streaming"]',
  '        PN["48 Response Panels\\nDeals Contacts Tasks Meetings"]',
  '        PST["Progress Stepper\\ntool execution steps"]',
  '        SKB["Skill Builder - SKILL.md editor"]',
  '    end',
  '    subgraph HOOKS["Hooks Layer"]',
  '        UC["useCopilotChat\\nstreaming and tool tracking"]',
  '        USS["useServices\\nservice locator access"]',
  '        UT["useToast via Sonner\\nuser feedback"]',
  '    end',
  '    AUTH --> STATE',
  '    PAGES --> STATE',
  '    COP --> STATE',
  '    HOOKS --> STATE',
  '    AS --> ML',
  '    AS --> PN',
  '    AS --> PST',
  '    SET --> SKB'
].join('\n'),

cp: [
  'flowchart LR',
  '    MSG(["User message"])',
  '    subgraph CTX["CopilotContext.sendMessage()"]',
  '        CHK["autonomous mode check"]',
  '    end',
  '    subgraph ROUTING["copilotRoutingService.routeToSkill()"]',
  '        S1["Step 1 - Sequence triggers\\nconfidence 0.7+ agent-sequence category"]',
  '        S2["Step 2 - Skill triggers\\nconfidence 0.5+ standard skills"]',
  '        S3["Step 3 - Semantic fallback\\ncosine 0.6+ pgvector similarity"]',
  '        S1 -->|no match| S2',
  '        S2 -->|no match| S3',
  '    end',
  '    subgraph AUTOM["Autonomous Mode - DEFAULT"]',
  '        AEF["copilot-autonomous edge function"]',
  '        CLD["Claude Haiku 4.5 - native tool_use"]',
  '        T1["list_skills - discover available skills"]',
  '        T2["get_skill - fetch content on demand"]',
  '        T3["execute_action - CRM and skills"]',
  '        T4["resolve_entity - ambiguous names"]',
  '        AEF --> CLD',
  '        CLD --> T1',
  '        CLD --> T2',
  '        CLD --> T3',
  '        CLD --> T4',
  '    end',
  '    subgraph REGM["Regular Mode - Fallback"]',
  '        ACOP["api-copilot edge function"]',
  '        GMN["Gemini 2.5 Flash - function calling"]',
  '        PANS["48 rich response panels"]',
  '        HITL["Preview then Confirm - HITL"]',
  '        ACOP --> GMN --> PANS --> HITL',
  '    end',
  '    subgraph MEM["Memory and Sessions"]',
  '        CM["copilotMemoryService\\nstore recall extract"]',
  '        CS["copilotSessionService\\ncompact at 80k tokens"]',
  '    end',
  '    MSG --> CTX',
  '    CTX -->|autonomous on| ROUTING',
  '    ROUTING -->|skill hint| AUTOM',
  '    CTX -.->|fallthrough| REGM',
  '    MEM --> ROUTING',
  '    AUTOM -->|streaming SSE| RESP(["Response to UI"])',
  '    REGM -->|streaming| RESP'
].join('\n'),

sk: [
  'flowchart LR',
  '    subgraph SRC["Source of Truth"]',
  '        MD["skills/atomic/name/SKILL.md\\nskills/sequences/seq-name/SKILL.md\\n30 total - YAML frontmatter + markdown"]',
  '    end',
  '    subgraph SYNC["Sync Paths"]',
  '        CLI["sync-skills.ts\\nnpm run sync-skills\\nlocal dev and CI"]',
  '        GHW["sync-skills-from-github\\nedge function\\nGitHub push webhook"]',
  '    end',
  '    subgraph PT["platform_skills - Master Templates"]',
  '        PTR["skill_key and category\\ncontent with variable placeholders\\ndescription for embedding generation"]',
  '    end',
  '    subgraph EMBG["Embedding Generation"]',
  '        ES["generateEmbeddings.ts\\nOpenAI text-embedding-3-small\\n1536 dimensions batch processing"]',
  '        GE["generate-embedding edge function\\nruntime query embedding"]',
  '    end',
  '    subgraph OT["organization_skills - Runtime Compiled"]',
  '        OTR["skill_key and is_enabled\\nfrontmatter with variables resolved\\ncontent ready to execute"]',
  '    end',
  '    subgraph RPC["get_organization_skills_for_agent RPC"]',
  '        RPR["Returns per org with is_enabled filter\\nskill_key category frontmatter content"]',
  '    end',
  '    subgraph DISC["3-Step Runtime Discovery"]',
  '        D1["Sequence triggers\\nconfidence 0.7+\\nagent-sequence category"]',
  '        D2["Skill triggers\\nconfidence 0.5+\\nstandard skills"]',
  '        D3["Semantic fallback\\ncosine 0.6+\\nmatch_skills_by_embedding RPC"]',
  '        D1 -->|no match| D2',
  '        D2 -->|no match| D3',
  '    end',
  '    subgraph EXEC["autonomousExecutor.ts - Lazy Loading"]',
  '        E1["initialize()\\nmetadata tier only\\nall keys and frontmatter"]',
  '        E2["executeTool()\\ninstructions tier\\nlazy-loaded on demand"]',
  '        E3["Claude tool definitions\\nnative tool_use format"]',
  '        E1 --> E2 --> E3',
  '    end',
  '    MD --> CLI',
  '    MD --> GHW',
  '    CLI --> PT',
  '    GHW --> PT',
  '    PT --> ES',
  '    ES -->|upsert embedding| PT',
  '    PT -->|compile per org| OT',
  '    OT --> RPC',
  '    RPC --> DISC',
  '    RPC --> EXEC',
  '    GE -->|embed user query| D3'
].join('\n'),

rf: [
  'flowchart LR',
  '    START(["Meeting scheduled\\nGoogle Calendar sync"])',
  '    subgraph P1["Phase 1 - Bot Deployment"]',
  '        SCH["auto-join-scheduler\\ncron every 2 min"]',
  '        BOT["deploy-recording-bot\\nMeetingBaaS API"]',
  '        RCV["Bot recording active"]',
  '        SCH --> BOT --> RCV',
  '    end',
  '    subgraph P2["Phase 2 - S3 Upload"]',
  '        MEND["Meeting ends\\nbot signals complete"]',
  '        POL["poll-s3-upload-queue\\n5MB multipart chunks"]',
  '        UOK["S3 Upload Complete"]',
  '        UFX["Upload Failed"]',
  '        MEND --> POL',
  '        POL -->|success| UOK',
  '        POL -->|error| UFX',
  '        UFX -->|exponential backoff retry| POL',
  '    end',
  '    subgraph P3["Phase 3 - Transcription"]',
  '        WHK["meetingbaas-webhook\\nsignals ready"]',
  '        PTR["poll-transcription-queue"]',
  '        ASS["AssemblyAI - primary"]',
  '        GLA["Gladia - fallback"]',
  '        TRY["Transcript Ready"]',
  '        WHK --> PTR',
  '        PTR --> ASS',
  '        PTR --> GLA',
  '        ASS --> TRY',
  '        GLA --> TRY',
  '    end',
  '    subgraph P4["Phase 4 - AI Processing"]',
  '        PRC["process-recording\\nedge function"]',
  '        CLD["Claude Haiku\\ntranscript analysis"]',
  '        RES["Summary + Highlights\\nAction Items + Speaker ID"]',
  '        PRC --> CLD --> RES',
  '    end',
  '    SYNC["syncRecordingToMeeting()"]',
  '    CRM["CRM Updated"]',
  '    SLK["Slack Notified"]',
  '    THB["Thumbnail Lambda"]',
  '    START --> SCH',
  '    RCV --> MEND',
  '    UOK --> WHK',
  '    TRY --> PRC',
  '    RES --> SYNC',
  '    SYNC --> CRM',
  '    SYNC --> SLK',
  '    SYNC --> THB'
].join('\n'),

be: [
  'flowchart LR',
  '    subgraph AUTH2["Auth Tables"]',
  '        AU["auth.users\\nSupabase managed"]',
  '        ORG["organizations\\nmemberships"]',
  '        US["user_settings\\nAI keys per user\\nno VITE_ prefix"]',
  '    end',
  '    subgraph CRM2["CRM Tables"]',
  '        MT["meetings\\nowner_user_id"]',
  '        DL["deals\\nowner_id\\nstage_id FK to deal_stages"]',
  '        CT["contacts\\nowner_id"]',
  '        TK["tasks\\nassigned_to and owner_id"]',
  '        AC["activities\\nuser_id"]',
  '        DSH["deal_stage_history\\nstage transitions\\nduration tracking"]',
  '    end',
  '    subgraph COPDB["Copilot Tables - user-private"]',
  '        CV["copilot_conversations\\nuser_id - admins cannot read"]',
  '        CM["copilot_memories\\nuser_id"]',
  '        CS["copilot_sessions\\ncompacted at 80k tokens"]',
  '    end',
  '    subgraph SKDB["Skills Tables"]',
  '        PS["platform_skills\\nmaster templates"]',
  '        OS["organization_skills\\ncompiled per org"]',
  '        PE["description_embedding\\npgvector 1536 dimensions"]',
  '    end',
  '    subgraph RLS2["Row Level Security"]',
  '        RL1["Users see own data only"]',
  '        RL2["Admins see org data"]',
  '        RL3["Copilot convos user-private\\nCHECK constraint enforced"]',
  '    end',
  '    subgraph EFG["Edge Functions - Deno runtime"]',
  '        CE1["copilot-autonomous\\nClaude native tool_use"]',
  '        CE2["api-copilot\\nGemini function calling"]',
  '        RE1["auto-join-scheduler cron"]',
  '        RE2["meetingbaas-webhook"]',
  '        RE3["poll queues - cron"]',
  '        RE5["process-recording"]',
  '        UE1["generate-embedding"]',
  '        CORS["corsHelper.ts\\ngetCorsHeaders origin-validated"]',
  '        EAUTH["edgeAuth.ts\\nisServiceRoleAuth\\ndirect key + JWT format"]',
  '    end',
  '    RLS2 --> CRM2',
  '    RLS2 --> COPDB',
  '    AUTH2 --> CRM2',
  '    PS --> OS',
  '    PE --> PS',
  '    CE1 --> CRM2',
  '    CE1 --> COPDB',
  '    CE1 --> SKDB',
  '    RE5 --> CRM2'
].join('\n'),

ai: [
  'flowchart LR',
  '    subgraph ANT["Anthropic Claude"]',
  '        H45["Claude Haiku 4.5\\nnative tool_use"]',
  '        HREC["Claude Haiku\\nRecording analysis"]',
  '    end',
  '    subgraph GGL["Google Gemini"]',
  '        G25["Gemini 2.5 Flash\\nfunction calling"]',
  '    end',
  '    subgraph OAI["OpenAI"]',
  '        TE3["text-embedding-3-small\\n1536 dimensions"]',
  '    end',
  '    subgraph ORT["OpenRouter"]',
  '        OR["Multi-model router\\nper user config\\nWorkflow AI nodes"]',
  '    end',
  '    subgraph USE["Feature Usage"]',
  '        U1["Autonomous Copilot\\ncopilot-autonomous\\nDefault mode"]',
  '        U2["Regular Copilot\\napi-copilot\\n48 rich panels"]',
  '        U3["Skill Embeddings\\nplatform_skills\\ndescription_embedding"]',
  '        U4["Query Embeddings\\ngenerate-embedding\\nsemantic skill search"]',
  '        U5["Recording Analysis\\nprocess-recording\\nsummary and speaker ID"]',
  '        U6["Workflow AI Nodes\\nconfigurable per user"]',
  '        U7["Keys in user_settings\\nNever in VITE_ env vars"]',
  '    end',
  '    H45 --> U1',
  '    G25 --> U2',
  '    TE3 --> U3',
  '    TE3 --> U4',
  '    HREC --> U5',
  '    OR --> U6',
  '    U7 -.-> U1',
  '    U7 -.-> U2',
  '    U7 -.-> U6'
].join('\n'),

ig: [
  'flowchart LR',
  '    subgraph MEET["Meeting Integrations"]',
  '        FTH["Fathom\\nMeeting transcripts\\nauto-indexed for AI"]',
  '        MBS["MeetingBaaS - 60 Notetaker\\nBot-based recording\\npermanent S3 storage"]',
  '        GCL["Google Calendar\\nManual sync\\nevents stored locally"]',
  '    end',
  '    subgraph CRMX["CRM Sync"]',
  '        HBS["HubSpot\\nContacts and deals\\nbidirectional sync"]',
  '        ATT["Attio\\nContacts and deals\\nbidirectional sync"]',
  '    end',
  '    subgraph OUT["Outreach"]',
  '        INS["Instantly\\nEmail campaigns\\nReply detection"]',
  '    end',
  '    subgraph NOTIF["Notifications"]',
  '        SLK2["Slack\\nPipeline alerts\\nWin/loss notifications\\nHITL approvals\\nfire-and-forget modals"]',
  '    end',
  '    subgraph DB3["Platform Database"]',
  '        MTG2["meetings table"]',
  '        CAL2["calendar_events table"]',
  '        CRMT["CRM tables"]',
  '        ACTT["activities table"]',
  '    end',
  '    FTH -->|transcript import| MTG2',
  '    MBS -->|recordings and transcripts| MTG2',
  '    GCL -->|calendar events| CAL2',
  '    HBS -->|contacts and deals| CRMT',
  '    CRMT -->|sync back| HBS',
  '    ATT -->|contacts and deals| CRMT',
  '    CRMT -->|sync back| ATT',
  '    INS -->|campaign status| ACTT',
  '    SLK2 -->|webhooks and alerts| DB3',
  '    DB3 -->|pipeline notifications| SLK2'
].join('\n'),

sq: [
  'sequenceDiagram',
  '    actor User',
  '    participant UI as Copilot UI',
  '    participant Ctx as CopilotContext',
  '    participant Router as copilotRoutingService',
  '    participant EF as copilot-autonomous',
  '    participant RPC as get-agent-skills RPC',
  '    participant DB as organization_skills',
  '    participant Claude as Claude Haiku 4.5',
  '    participant Tools as Tool Handlers',
  '    User->>UI: Send message',
  '    UI->>Ctx: sendMessage()',
  '    Ctx->>Router: routeToSkill(message, orgId)',
  '    Note over Router: 3-step routing sequences 0.7+ skills 0.5+ embeddings 0.6+',
  '    Router-->>Ctx: SkillMatch or null',
  '    Ctx->>EF: POST with skill hint and message',
  '    EF->>RPC: get_organization_skills_for_agent()',
  '    RPC->>DB: SELECT compiled skills for org',
  '    DB-->>RPC: skill rows key frontmatter content',
  '    RPC-->>EF: skills as Claude tool definitions',
  '    EF->>Claude: messages and tools metadata tier',
  '    Note over Claude: Inspects tool definitions',
  '    Claude-->>EF: tool_use get_skill skill_key',
  '    Note over EF: Lazy-load full instructions on demand',
  '    EF->>RPC: Fetch full skill content',
  '    RPC-->>EF: complete skill instructions',
  '    EF->>Claude: tool_result with content',
  '    Claude-->>EF: tool_use execute_action',
  '    EF->>Tools: Run CRM action or fetch data',
  '    Tools-->>EF: action result',
  '    Claude-->>EF: Final text response',
  '    EF-->>Ctx: Streaming chunks via SSE',
  '    Ctx-->>UI: Update messages and progress steps',
  '    UI-->>User: Response displayed'
].join('\n'),

rp: [
  'flowchart LR',
  '    START(["Meeting scheduled - Google Calendar sync"])',
  '    subgraph P1["Phase 1 - Bot Deployment"]',
  '        SCH2["auto-join-scheduler\\ncron every 2 min\\nscans calendar_events"]',
  '        BOT2["deploy-recording-bot\\nMeetingBaaS API\\nZoom Meet Teams"]',
  '        RCV2["Bot recording active\\nmeeting in progress"]',
  '        SCH2 --> BOT2 --> RCV2',
  '    end',
  '    subgraph P2["Phase 2 - S3 Upload"]',
  '        MEND2["Meeting ends\\nbot signals complete"]',
  '        POL2["poll-s3-upload-queue\\n5MB multipart chunks"]',
  '        UOK2["S3 Upload Complete"]',
  '        UFX2["Upload Failed max 3 retries"]',
  '        MEND2 --> POL2',
  '        POL2 -->|success| UOK2',
  '        POL2 -->|error| UFX2',
  '        UFX2 -->|exponential backoff| POL2',
  '    end',
  '    subgraph P3["Phase 3 - Transcription"]',
  '        WHK2["meetingbaas-webhook\\nsignals ready"]',
  '        PTR2["poll-transcription-queue"]',
  '        ASS2["AssemblyAI - primary provider"]',
  '        GLA2["Gladia - fallback provider"]',
  '        TRY2["Transcript Ready"]',
  '        WHK2 --> PTR2',
  '        PTR2 --> ASS2',
  '        PTR2 --> GLA2',
  '        ASS2 --> TRY2',
  '        GLA2 --> TRY2',
  '    end',
  '    subgraph P4["Phase 4 - AI Processing"]',
  '        PRC2["process-recording\\nedge function"]',
  '        CLD2["Claude Haiku\\ntranscript analysis\\nspeaker identification"]',
  '        RES2["Summary and Highlights\\nAction Items and Speaker ID\\nCRM field updates"]',
  '        PRC2 --> CLD2 --> RES2',
  '    end',
  '    SYNC2["syncRecordingToMeeting()"]',
  '    CRM2["CRM Updated\\nmeetings contacts tasks"]',
  '    SLK2["Slack Notified"]',
  '    THB2["Thumbnail - Lambda\\npresigned S3 URL"]',
  '    START --> SCH2',
  '    RCV2 --> MEND2',
  '    UOK2 --> WHK2',
  '    TRY2 --> PRC2',
  '    RES2 --> SYNC2',
  '    SYNC2 --> CRM2',
  '    SYNC2 --> SLK2',
  '    SYNC2 --> THB2'
].join('\n'),

sf: [
  'flowchart LR',
  '    subgraph SRC2["Source of Truth"]',
  '        MD2["skills/atomic/name/SKILL.md\\nskills/sequences/seq-name/SKILL.md\\n30 total - 18 atomic + 12 sequences"]',
  '    end',
  '    subgraph SYNC2["Sync Paths"]',
  '        CLI2["sync-skills.ts\\nnpm run sync-skills\\nlocal dev and CI"]',
  '        GHW2["sync-skills-from-github\\nedge function\\nGitHub push webhook"]',
  '    end',
  '    subgraph PT2["platform_skills - Master Templates"]',
  '        PTR2["skill_key and category\\ncontent with variable placeholders\\ndescription used for embedding"]',
  '    end',
  '    subgraph EMBG2["Embedding Generation"]',
  '        ES2["generateEmbeddings.ts\\nOpenAI text-embedding-3-small\\n1536 dimensions batch processing"]',
  '        GE2["generate-embedding edge function\\nruntime query embedding"]',
  '    end',
  '    subgraph OT2["organization_skills - Runtime Compiled"]',
  '        OTR2["skill_key and is_enabled\\nfrontmatter with variables resolved\\ncontent ready for execution"]',
  '    end',
  '    subgraph RPCL2["get_organization_skills_for_agent RPC"]',
  '        RPR2["Returns per org filtered by is_enabled\\nskill_key category frontmatter content"]',
  '    end',
  '    subgraph DISC2["3-Step Runtime Discovery"]',
  '        D12["Sequence triggers\\nconfidence 0.7+\\nagent-sequence category"]',
  '        D22["Skill triggers\\nconfidence 0.5+\\nstandard skill categories"]',
  '        D32["Semantic fallback\\ncosine 0.6+\\nmatch_skills_by_embedding RPC"]',
  '        D12 -->|no match| D22',
  '        D22 -->|no match| D32',
  '    end',
  '    subgraph EXCT2["autonomousExecutor.ts - Lazy Loading"]',
  '        E12["initialize()\\nmetadata tier\\nall keys and frontmatter"]',
  '        E22["executeTool()\\ninstructions tier\\nlazy-loaded on demand"]',
  '        E32["Claude tool definitions\\nnative tool_use format"]',
  '        E12 --> E22 --> E32',
  '    end',
  '    MD2 --> CLI2',
  '    MD2 --> GHW2',
  '    CLI2 --> PT2',
  '    GHW2 --> PT2',
  '    PT2 --> ES2',
  '    ES2 -->|upsert description_embedding| PT2',
  '    PT2 -->|compile org variables| OT2',
  '    OT2 --> RPCL2',
  '    RPCL2 --> DISC2',
  '    RPCL2 --> EXCT2',
  '    GE2 -->|embed user query| D32'
].join('\n')

// ── V2 Diagrams (feat/always_on branch) ────────────────────────

,cc: [
  'flowchart LR',
  '    subgraph SRC["Source Agents - 8 total"]',
  '        A1["Morning Briefing"]',
  '        A2["EOD Synthesis"]',
  '        A3["Meeting Prep"]',
  '        A4["Deal Risk"]',
  '        A5["Re-Engagement"]',
  '        A6["Coaching"]',
  '        A7["Competitive Intel"]',
  '        A8["Email Signals"]',
  '    end',
  '    subgraph CC["Command Centre Pipeline"]',
  '        INB["Inbox\\n9 item types\\n8 statuses"]',
  '        ENR["cc-enrich\\nCalendar CRM Email\\nPipeline Transcript"]',
  '        PRI["cc-prioritise\\nAI confidence scoring\\npriority ranking"]',
  '        INB --> ENR --> PRI',
  '    end',
  '    subgraph AUT["Autonomy Gate"]',
  '        RES["autonomyResolver\\nUser Org Preset Default"]',
  '        PRI --> RES',
  '    end',
  '    subgraph ACT["Action Paths"]',
  '        EXE["Auto-Execute\\nhigh confidence + auto policy"]',
  '        APR["Approve\\nmedium confidence or approve policy"]',
  '        SUG["Suggest\\nlow confidence or suggest policy"]',
  '        RES -->|auto| EXE',
  '        RES -->|approve| APR',
  '        RES -->|suggest| SUG',
  '    end',
  '    subgraph OUT["Outputs"]',
  '        CRM["CRM Updates"]',
  '        SLK["Slack Assertive Messages\\nAction + Evidence + Escape"]',
  '        TSK["Tasks Created"]',
  '        EML["Email Drafts"]',
  '    end',
  '    subgraph CRED["Credit Governance"]',
  '        CLG["creditLedger\\nmeters enrichment + scoring"]',
  '        CBG["Budget Check\\nbefore each AI call"]',
  '        FTH2["Fleet Throttle\\nskip non-critical if over budget"]',
  '        CLG --> CBG --> FTH2',
  '    end',
  '    SRC --> INB',
  '    ENR -.->|AI call metered| CLG',
  '    PRI -.->|AI call metered| CLG',
  '    FTH2 -.->|throttle low-priority items| INB',
  '    EXE --> OUT',
  '    APR -->|user confirms| OUT',
  '    SUG -->|user acts| OUT'
].join('\n'),

au: [
  'flowchart LR',
  '    subgraph TIERS["4 Autonomy Tiers"]',
  '        T1["disabled\\nAgent cannot act"]',
  '        T2["suggest\\nAgent suggests only"]',
  '        T3["approve\\nAgent drafts user confirms"]',
  '        T4["auto\\nAgent acts user can undo"]',
  '        T1 --> T2 --> T3 --> T4',
  '    end',
  '    subgraph PRESETS["Preset Configurations"]',
  '        PC["Conservative\\nmost actions suggest"]',
  '        PB["Balanced\\nmix of approve and auto"]',
  '        PA["Autonomous\\nmost actions auto"]',
  '    end',
  '    subgraph RESOLVE["Policy Resolution - 5 min cache"]',
  '        R1["1. User Policy\\nper action type override"]',
  '        R2["2. Org Policy\\norganization defaults"]',
  '        R3["3. Preset\\nconservative balanced autonomous"]',
  '        R4["4. Default\\nbuilt-in fallback"]',
  '        R1 -->|not set| R2',
  '        R2 -->|not set| R3',
  '        R3 -->|not set| R4',
  '    end',
  '    subgraph PROMO["Promotion Engine"]',
  '        TS["Trust Signals\\nundo rate approval rate usage"]',
  '        PE["promotionEngine.ts\\nevaluate threshold"]',
  '        SN["Slack Notification\\nautonomy-promotion-notify"]',
  '        TS --> PE -->|threshold met| SN',
  '    end',
  '    subgraph DEMO["Demotion Engine"]',
  '        VIO["Violations\\nfrequent undo rejections"]',
  '        DE["demotionEngine.ts\\nauto-downgrade"]',
  '        VIO --> DE -->|tier down| TIERS',
  '    end',
  '    subgraph ANALYTICS["Autonomy Analytics"]',
  '        AA["autonomy_analytics table\\nactions per tier"]',
  '        AB["autonomy_audit_log\\nall promotions demotions"]',
  '    end',
  '    PRESETS --> RESOLVE',
  '    PE --> ANALYTICS',
  '    DE --> ANALYTICS'
].join('\n'),

pf: [
  'flowchart LR',
  '    subgraph TRIGGER["Triggers"]',
  '        CR["Cron Scheduler"]',
  '        EV["Event Hooks\\nmeeting end deal update"]',
  '    end',
  '    subgraph FLEET["Fleet Router"]',
  '        FR["Route to N agents\\nparallel execution\\ndeduplication"]',
  '    end',
  '    subgraph AGENTS["Agent Fleet"]',
  '        MB["Morning Brief\\npipeline + fleet routes"]',
  '        EOD["EOD Synthesis\\nscorecard + overnight plan"]',
  '        MP["Meeting Prep\\ntype-specific 1:1 QBR standup"]',
  '        DR["Deal Risk\\ntemperature + risk factors"]',
  '        RE["Re-Engagement\\nApollo + Apify signals"]',
  '        CO["Coaching\\nskill progression"]',
  '        CI["Competitive Intel\\nbattlecards + monitoring"]',
  '        ES["Email Signals\\nextraction + classification"]',
  '    end',
  '    subgraph ASSERT["Assertive Messaging"]',
  '        AM["3-Part Pattern"]',
  '        ACT2["Action - past tense verb"]',
  '        EVI["Evidence - trigger + source"]',
  '        ESC["Escape Hatch - tier buttons"]',
  '        AM --> ACT2',
  '        AM --> EVI',
  '        AM --> ESC',
  '    end',
  '    subgraph CRED2["Credit Governance"]',
  '        MR2["Model Router\\ncheapest model per task"]',
  '        FT2["Fleet Throttle\\npause non-critical at 80%"]',
  '        LG2["creditLedger\\nper-agent cost tracking"]',
  '    end',
  '    subgraph DEST["Destinations"]',
  '        CCQ["Command Centre Queue"]',
  '        SLK3["Slack Channels"]',
  '    end',
  '    TRIGGER --> FR',
  '    FR --> FT2',
  '    FT2 -->|budget ok| AGENTS',
  '    FT2 -.->|over budget skip non-critical| DEST',
  '    AGENTS --> MR2',
  '    MR2 -->|cheapest capable model| AGENTS',
  '    AGENTS -.->|metered| LG2',
  '    AGENTS --> CCQ',
  '    AGENTS --> ASSERT',
  '    ASSERT --> SLK3'
].join('\n'),

sc: [
  'flowchart LR',
  '    USR(["Slack User Message"])  ',
  '    subgraph EVENTS["slack-events edge function"]',
  '        EV["Event receiver\\napp_mention + message"]',
  '        TH["Thread detection\\nreply vs new thread"]',
  '        EV --> TH',
  '    end',
  '    subgraph COPILOT["slack-copilot edge function"]',
  '        IC["Intent Classifier\\n8 query types"]',
  '        D1["Deals handler"]',
  '        D2["Contacts handler"]',
  '        D3["Pipeline handler"]',
  '        D4["History handler"]',
  '        D5["Coaching handler"]',
  '        D6["Competitive handler"]',
  '        D7["Actions handler"]',
  '        D8["General handler"]',
  '        IC --> D1',
  '        IC --> D2',
  '        IC --> D3',
  '        IC --> D4',
  '        IC --> D5',
  '        IC --> D6',
  '        IC --> D7',
  '        IC --> D8',
  '    end',
  '    subgraph MEM["Thread Memory"]',
  '        TM["slack_copilot_threads\\ncontext per thread\\n180 line service"]',
  '    end',
  '    subgraph INTER["slack-interactive"]',
  '        AT2["Autonomy toggle handler"]',
  '        CQ["Config question answer"]',
  '        AP["Promotion approval"]',
  '        HITLEM["HITL email modal\\neditable To field\\nfire-and-forget submit\\ntimezone-aware scheduling"]',
  '    end',
  '    USR --> EVENTS',
  '    TH --> COPILOT',
  '    MEM --> COPILOT',
  '    COPILOT -->|Block Kit response| USR',
  '    USR -->|button click| INTER'
].join('\n'),

dm: [
  'flowchart LR',
  '    subgraph SHELL["DemoShell.tsx - /settings/demo"]',
  '        NAV["Act navigation\\n5 acts progressive"]',
  '    end',
  '    subgraph A1["Act 1 - Before 60"]',
  '        PAIN["The Pain\\nmanual CRM no prep\\nlost context"]',
  '    end',
  '    subgraph A2["Act 2 - Onboarding"]',
  '        OB["90-Second Setup\\nauto-advance steps\\ncalendar + Slack + CRM"]',
  '    end',
  '    subgraph A3["Act 3 - Day 1 - 10 Scenes"]',
  '        S1["Morning Brief"]',
  '        S2["Meeting Prep"]',
  '        S3["Live Meeting"]',
  '        S4["Post-Meeting Follow-up"]',
  '        S5["Pipeline Review"]',
  '        S6["Deal Risk Alert"]',
  '        S7["Proposal Generation"]',
  '        S8["CRM Auto-Update"]',
  '        S9["Coaching Insights"]',
  '        S10["EOD Synthesis"]',
  '        S1 --> S2 --> S3 --> S4 --> S5',
  '        S5 --> S6 --> S7 --> S8 --> S9 --> S10',
  '    end',
  '    subgraph A4["Act 4 - Week 2 - Learning"]',
  '        L1["Pattern Recognition"]',
  '        L2["Autonomy Promotion"]',
  '        L3["Relationship Graph"]',
  '        L4["Team Insights"]',
  '    end',
  '    subgraph A5["Act 5 - Month 1 - Full Autonomy"]',
  '        F1["Proactive Re-engagement"]',
  '        F2["Competitive Battlecards"]',
  '        F3["Fleet Dashboard"]',
  '        F4["ROI Report"]',
  '    end',
  '    SHELL --> A1 --> A2 --> A3 --> A4 --> A5'
].join('\n'),

// V2 tab diagrams
ccp: [
  'sequenceDiagram',
  '    participant Agent as Source Agent',
  '    participant CC as Command Centre',
  '    participant Budget as creditBudgetService',
  '    participant Router as modelRouter',
  '    participant Enrich as cc-enrich',
  '    participant Score as cc-prioritise',
  '    participant Ledger as creditLedger',
  '    participant Policy as autonomyResolver',
  '    participant Exec as cc-auto-execute',
  '    participant Slack as Assertive Message',
  '    participant User as User',
  '    Agent->>CC: Emit item (deal_risk meeting_prep etc)',
  '    CC->>Budget: Check remaining credit budget',
  '    alt budget exhausted and item non-critical',
  '        Budget-->>CC: THROTTLED - defer to next cycle',
  '    else budget available',
  '        Budget-->>CC: OK - proceed',
  '    end',
  '    CC->>Router: Select model for enrichment',
  '    Router-->>CC: Cheapest capable model',
  '    CC->>Enrich: Load context loaders',
  '    Note over Enrich: Calendar CRM Email Pipeline Transcript',
  '    Enrich-->>CC: Enriched item with context',
  '    Enrich->>Ledger: Log enrichment AI cost',
  '    CC->>Score: AI confidence scoring',
  '    Score-->>CC: confidence 0-1 and priority rank',
  '    Score->>Ledger: Log scoring AI cost',
  '    CC->>Policy: Resolve autonomy for action type',
  '    Note over Policy: User > Org > Preset > Default',
  '    alt auto policy and high confidence',
  '        Policy-->>Exec: Auto-execute',
  '        Exec->>Slack: Action + Evidence + Undo button',
  '        Slack-->>User: Assertive notification',
  '    else approve policy',
  '        Policy-->>Slack: Draft + Approve button',
  '        Slack-->>User: Approval request',
  '        User->>Exec: Confirm',
  '    else suggest policy',
  '        Policy-->>User: Suggestion card in CC inbox',
  '    end'
].join('\n'),

aur: [
  'flowchart LR',
  '    subgraph INPUT["Action Request"]',
  '        ACT["Action type\\ncreate_task send_email update_deal\\npost_slack generate_proposal"]',
  '    end',
  '    subgraph CACHE["Resolution Cache - 5 min TTL"]',
  '        CK["Cache key\\nuser_id + org_id + action_type"]',
  '    end',
  '    subgraph CHAIN["Resolution Chain"]',
  '        U["User Policy\\nautonomy_policies WHERE user_id"]',
  '        O["Org Policy\\nautonomy_policies WHERE org_id"]',
  '        P["Preset Lookup\\nconservative balanced autonomous"]',
  '        D["Default\\nbuilt-in suggest"]',
  '        U -->|null| O',
  '        O -->|null| P',
  '        P -->|null| D',
  '    end',
  '    subgraph CEIL["Policy Ceilings"]',
  '        MC["Manager Ceiling\\nmax tier per action type"]',
  '        OC["Org Ceiling\\norg-wide max tier"]',
  '    end',
  '    subgraph RESULT["Resolved Policy"]',
  '        EFF["Effective tier\\nmin(resolved ceiling)"]',
  '    end',
  '    ACT --> CK',
  '    CK -->|miss| CHAIN',
  '    CK -->|hit| RESULT',
  '    CHAIN --> CEIL',
  '    CEIL --> RESULT'
].join('\n'),

pfd: [
  'flowchart LR',
  '    subgraph CRON["Cron Triggers"]',
  '        AM["7:00 AM\\nMorning Brief"]',
  '        MID["Throughout Day\\nDeal Risk + Re-Engagement"]',
  '        PM["6:00 PM\\nEOD Synthesis"]',
  '    end',
  '    subgraph EVENT["Event Triggers"]',
  '        ME2["Meeting Ends\\nCoaching + Follow-up"]',
  '        DE2["Deal Updated\\nRisk Recalculation"]',
  '        EM2["Email Received\\nSignal Extraction"]',
  '    end',
  '    subgraph ROUTER["Fleet Router"]',
  '        RT["Parallel Dispatch\\nall eligible agents"]',
  '        DD["Deduplication\\ncross-agent item merge"]',
  '    end',
  '    subgraph MORNING["Morning Brief Agent"]',
  '        MBP["Pipeline analysis\\n590 lines"]',
  '        MBR["Fleet routes\\n162 lines"]',
  '        MBS2["Priority actions"]',
  '    end',
  '    subgraph EOD2["EOD Synthesis Agent"]',
  '        EODS["Day scorecard"]',
  '        EODR["Relationship scoring"]',
  '        EODP["Overnight plan"]',
  '    end',
  '    subgraph MEETP["Meeting Prep Agent"]',
  '        MPC["Type classifier\\n1:1 QBR pipeline standup"]',
  '        MPT["Type templates\\n731 lines"]',
  '        MPI["Internal detector\\n340 lines"]',
  '    end',
  '    subgraph RISK["Deal Risk Agent"]',
  '        DRT["Temperature scoring"]',
  '        DRF["Risk factor detection"]',
  '        DRA["Automated alerts"]',
  '    end',
  '    DEST2["Command Centre"]',
  '    CRON --> ROUTER',
  '    EVENT --> ROUTER',
  '    ROUTER --> MORNING',
  '    ROUTER --> EOD2',
  '    ROUTER --> MEETP',
  '    ROUTER --> RISK',
  '    MORNING --> DD',
  '    EOD2 --> DD',
  '    MEETP --> DD',
  '    RISK --> DD',
  '    DD --> DEST2'
].join('\n'),

// ── Credit Governance diagrams ────────────────────────────────

cg: [
  'flowchart LR',
  '    subgraph CONSUMERS["AI Credit Consumers"]',
  '        FC["Fleet Agents x8\\ncron + event triggered"]',
  '        CP2["Copilot Chat\\nautonomous + regular"]',
  '        CCE2["CC Enrichment\\nAI confidence scoring"]',
  '        SCP["Slack Copilot\\nin-channel queries"]',
  '        REC2["Recording Analysis\\nClaude transcript processing"]',
  '        EMB["Embedding Generation\\nOpenAI skill + query"]',
  '    end',
  '    subgraph ROUTER2["Model Router"]',
  '        MR["modelRouter.ts\\ntask type to model mapping"]',
  '        MH["Haiku - triage classify\\nlowest cost"]',
  '        MS["Sonnet - drafts analysis\\nbalanced"]',
  '        MO["Opus - complex reasoning\\nhighest cost"]',
  '        MG["Gemini Flash - copilot\\nfunction calling"]',
  '        MR --> MH',
  '        MR --> MS',
  '        MR --> MO',
  '        MR --> MG',
  '    end',
  '    subgraph LEDGER["Credit Ledger"]',
  '        CL2["creditLedger.ts\\nlog every AI call"]',
  '        TBL["credit_ledger table\\nuser org provider model\\ntokens cost source_agent"]',
  '        CL2 --> TBL',
  '    end',
  '    subgraph BUDGET["Budget Enforcement"]',
  '        BS["creditBudgetService.ts"]',
  '        UB["User daily and monthly limits"]',
  '        OB2["Org-wide ceiling"]',
  '        BS --> UB',
  '        BS --> OB2',
  '    end',
  '    subgraph GUARD["Circuit Breakers"]',
  '        FT["fleetThrottle.ts\\npause non-critical at 80%"]',
  '        AL["credit-budget-alert\\nSlack at 80% and 100%"]',
  '        KB["Hard kill at 100%\\nonly critical paths proceed"]',
  '    end',
  '    subgraph VIS["Visibility"]',
  '        RU["credit-usage-rollup\\nhourly cron"]',
  '        DASH["Usage Dashboard\\nper agent per model\\ndaily monthly trends"]',
  '        RU --> DASH',
  '    end',
  '    CONSUMERS --> MR',
  '    MR -->|all calls| CL2',
  '    TBL --> BS',
  '    BS -->|over threshold| GUARD',
  '    FT -->|throttle| FC',
  '    TBL --> RU'
].join('\n'),

cgd: [
  'sequenceDiagram',
  '    participant Agent as Any AI Consumer',
  '    participant Router as modelRouter',
  '    participant Provider as AI Provider',
  '    participant Ledger as creditLedger',
  '    participant Budget as creditBudgetService',
  '    participant Throttle as fleetThrottle',
  '    participant Alert as Slack Alert',
  '    Agent->>Router: Request AI call with task type',
  '    Router->>Budget: Check remaining budget',
  '    alt budget exhausted',
  '        Budget-->>Router: DENIED - over limit',
  '        Router-->>Agent: CreditExhaustedError',
  '    else budget available',
  '        Budget-->>Router: OK - proceed',
  '        Router->>Router: Select cheapest capable model',
  '        Note over Router: Haiku for triage and classify\\nSonnet for drafts and analysis\\nGemini for copilot chat',
  '        Router->>Provider: API call with selected model',
  '        Provider-->>Router: Response + usage metadata',
  '        Router->>Ledger: Log tokens model cost source_agent',
  '        Ledger->>Budget: Update running totals',
  '        alt approaching limit 80%',
  '            Budget->>Throttle: Engage fleet throttle',
  '            Throttle->>Throttle: Pause non-critical agents',
  '            Budget->>Alert: Slack warning to user and manager',
  '        end',
  '        Router-->>Agent: AI response',
  '    end'
].join('\n'),


apo: [
  'flowchart LR',
  '    subgraph LOOP["Signal Learning Loop"]',
  '        A["Rep Response\napproved +1.0 / edited +0.3\nrejected -1.0 / undone -2.0\nauto_undone -3.0"]',
  '        B["Rubber-stamp guard\nfast approvals excluded\nemail.send threshold 5000ms"]',
  '        C["autopilot_confidence\ntime-decayed score\n30-day half-life"]',
  '        D["promotion_eligible = true\nwhen score > 0.7\nAND signals >= 10"]',
  '        A --> B --> C --> D',
  '    end',
  '    subgraph EVAL["Daily Evaluation"]',
  '        E["autopilot-evaluate\ndaily cron"]',
  '        F["promotionEngine.ts\n7-step threshold check\nmin signals, clean rate,\nstreak guard, ceiling"]',
  '        G["Slack DM\nscorecard proposal"]',
  '        E --> F --> G',
  '    end',
  '    subgraph RESPONSE["Rep Decision"]',
  '        H["Yes go auto\n→ update autonomy_policies"]',
  '        I["Not yet\n→ 30d cooldown"]',
  '        J["Never\n→ permanent lock"]',
  '        G --> H & I & J',
  '    end',
  '    subgraph DEMOTION["Auto-Demotion"]',
  '        K["demotionEngine.ts\nundo spike detected"]',
  '        L["Revert to approve tier\n+ Slack DM"]',
  '        K --> L',
  '    end',
  '    D --> E',
  '    H -->|"autonomous actions"| K',
  '    L -->|"resets confidence"| C'
].join("\n"),


ape: [
  'flowchart LR',
  '    subgraph S1["1 — Signal Recording  autopilot-record-signal"]',
  '        A1["Approval event\napproved / edited / rejected / expired\nundone / auto_executed / auto_undone"]',
  '        A2["Rubber-stamp guard\ntime_to_respond < threshold = not clean\nemail.send 5000ms  stage change 3000ms  default 2000ms"]',
  '        A3["autopilot_signals\nuser_id  org_id  action_type  signal\ntime_to_respond_ms  edit_distance\nedit_fields  autonomy_tier_at_time"]',
  '        A1 --> A2 --> A3',
  '    end',
  '    subgraph S2["2 — Confidence Recalculation  DB trigger SECURITY DEFINER"]',
  '        B1["refresh_autopilot_confidence()\nfires AFTER INSERT on autopilot_signals"]',
  '        B2["calculateConfidence()\ntime-decay: pow(0.5, daysOld/30)\nnormalised to 0-1  sample factor"]',
  '        B3["autopilot_confidence\nscore  clean_approval_rate  rejection_rate\nundo_rate  last_30_signals  days_active\nrubber_stamp_count  rubber_stamp_rate"]',
  '        B4["promotion_eligible = TRUE\nwhen score > 0.7 AND total_signals >= 10"]',
  '        B1 --> B2 --> B3 --> B4',
  '    end',
  '    subgraph S3["3 — Daily Evaluation  autopilot-evaluate cron"]',
  '        C1["Query autopilot_confidence\nWHERE promotion_eligible = true"]',
  '        C2["evaluatePromotionEligibility()\n7-step check per user-action pair"]',
  '        C3["autopilot_thresholds\nmin_signals  min_clean_approval_rate\nmax_undo_rate  min_days_active\nlast_n_clean streak guard"]',
  '        C4["autopilot_org_settings\nManager ceiling\nmax_tier per action_type"]',
  '        C1 --> C2',
  '        C2 --> C3',
  '        C4 -->|caps max tier| C2',
  '    end',
  '    subgraph S4["4 — Promotion Proposal  sendPromotionProposal"]',
  '        D1["Batch by user\nsingle Slack DM per user"]',
  '        D2["Slack scorecard\nsignals  clean rate  confidence score\ndays active  action type"]',
  '        D3["Yes go auto\nupdate autonomy_policies\neffective tier = auto"]',
  '        D4["Not yet\ncooldown_until = now + 30d"]',
  '        D5["Never\nnever_promote = true"]',
  '        D1 --> D2 --> D3 & D4 & D5',
  '    end',
  '    subgraph S5["5 — Demotion Engine  evaluateDemotionTriggers"]',
  '        E1["Post every auto-executed action"]',
  '        E2["warn — undo rate > 10% in 7d"]',
  '        E3["demote — sustained undo > 8% in 14d"]',
  '        E4["emergency — 3+ undos in 3d\nemail.send — ANY single undo"]',
  '        E5["Revert autonomy_policies\nboost extra_required_signals\nSlack DM to rep"]',
  '        E1 --> E2 & E3 & E4',
  '        E3 & E4 --> E5',
  '    end',
  '    subgraph S6["Dashboard   Controls"]',
  '        F1["AutopilotDashboard\nper-action status  time saved"]',
  '        F2["AutopilotNudgeBanner\nin-copilot nudge  30s poll"]',
  '        F3["AutonomySimulator\n90-day demo at /platform/demo/autonomy"]',
  '        F4["autopilot-admin\nupsert_ceiling  get_team_confidence"]',
  '    end',
  '    A3 --> B1',
  '    B4 --> C1',
  '    C2 -->|candidates| D1',
  '    D3 -->|updates| POL["autonomy_policies"]',
  '    POL -->|governs auto actions| E1',
  '    E5 -->|reverts| POL',
  '    B3 --> F1 & F2',
  '    F4 --> C4'
].join("\n")

// ── PRD V4 Diagrams — Orchestrator, Email, Memory, Relationship, Logs, Control Room ──

,orch: [
  'flowchart LR',
  '    subgraph ENTRY["Entry Points"]',
  '        EV["Event Triggers\\nmeeting_completed deal_updated\\ncontact_enriched activity_logged"]',
  '        CR["Cron Triggers\\nmorning brief EOD\\nhealth refresh"]',
  '        RS["resumeSequence()\\nHITL approval callback"]',
  '    end',
  '    subgraph ROUTER["Fleet Router"]',
  '        FR["fleetRouter.ts\\nevent to sequence resolution"]',
  '        CTX["Context Loading\\n3 tiers: metadata CRM AI\\ndeal stage_id FK resolution"]',
  '        BDG["Cost Budget Gate\\ncreditBudgetService check"]',
  '        FR --> CTX --> BDG',
  '    end',
  '    subgraph RUNNER["runner.ts — Execution Engine"]',
  '        IDEM["Idempotency Check\\nidempotency_key dedup"]',
  '        STEP["Step Iterator\\nsequential with parallel branches"]',
  '        ADAPT["Adapter Dispatch\\n45 adapters"]',
  '        HITL["HITL Pause\\nrequires_approval = true\\npaused_at timestamp"]',
  '        RETRY["Retry Logic\\nMAX_STEP_RETRIES\\nexponential backoff"]',
  '        DL["Dead Letter\\nfailed after max retries"]',
  '        SELF["Self-Invocation\\n2s before timeout\\ncontinue in new isolate"]',
  '        IDEM --> STEP --> ADAPT',
  '        ADAPT -->|needs approval| HITL',
  '        ADAPT -->|error| RETRY',
  '        RETRY -->|exhausted| DL',
  '        STEP -->|approaching 25s timeout| SELF',
  '    end',
  '    subgraph ADAPTERS["Key Adapters — 45 total"]',
  '        AE["emailSend\\ndraft follow-up"]',
  '        AC["calendar\\nfind slots"]',
  '        AP["proposalGenerator\\ngenerate proposal"]',
  '        AR["roleInference\\nclassify attendee roles"]',
  '        AD["dealRisk\\ntemperature scoring"]',
  '        AM["meetingTypeClassifier\\n1:1 QBR standup"]',
  '        AI["detectIntents\\ncommitments buying signals"]',
  '        AS["crmUpdate\\nauto-apply CRM changes"]',
  '    end',
  '    subgraph STATE["State Management"]',
  '        SJ["sequence_jobs\\nstep state output error"]',
  '        HP["hitl_pending_approvals\\nresource_type callback"]',
  '        DLQ["Dead Letter Queue\\nretry via cron"]',
  '    end',
  '    EV --> FR',
  '    CR --> FR',
  '    RS --> RUNNER',
  '    BDG -->|budget ok| RUNNER',
  '    ADAPT --> ADAPTERS',
  '    HITL --> HP',
  '    DL --> DLQ',
  '    STEP --> SJ'
].join('\n'),

orch2: [
  'flowchart LR',
  '    subgraph ENTRY["Entry Points"]',
  '        EV["Event Triggers\\nmeeting_completed deal_updated\\ncontact_enriched activity_logged"]',
  '        CR["Cron Triggers\\nmorning brief EOD\\nhealth refresh"]',
  '        RS["resumeSequence()\\nHITL approval callback"]',
  '    end',
  '    subgraph ROUTER["Fleet Router"]',
  '        FR["fleetRouter.ts\\nevent to sequence resolution"]',
  '        CTX["Context Loading\\n3 tiers: metadata CRM AI"]',
  '        BDG["Cost Budget Gate\\ncreditBudgetService check"]',
  '        FR --> CTX --> BDG',
  '    end',
  '    subgraph RUNNER["runner.ts Execution Engine"]',
  '        IDEM["Idempotency Check\\nidempotency_key dedup"]',
  '        STEP["Step Iterator\\nsequential with parallel branches"]',
  '        ADAPT["Adapter Dispatch\\n45 adapters"]',
  '        HITL["HITL Pause\\nrequires_approval = true\\npaused_at timestamp"]',
  '        RETRY["Retry Logic\\nMAX_STEP_RETRIES\\nexponential backoff"]',
  '        DL2["Dead Letter\\nfailed after max retries"]',
  '        SELF["Self-Invocation\\n2s before timeout\\ncontinue in new isolate"]',
  '        IDEM --> STEP --> ADAPT',
  '        ADAPT -->|needs approval| HITL',
  '        ADAPT -->|error| RETRY',
  '        RETRY -->|exhausted| DL2',
  '        STEP -->|approaching 25s timeout| SELF',
  '    end',
  '    subgraph ADAPTERS["Key Adapters 45 total"]',
  '        AE["emailSend draft follow-up"]',
  '        AC2["calendar find slots"]',
  '        AP2["proposalGenerator"]',
  '        AR2["roleInference"]',
  '        AD2["dealRisk"]',
  '        AM2["meetingTypeClassifier"]',
  '        AI3["detectIntents"]',
  '        AS2["crmUpdate"]',
  '    end',
  '    subgraph STATE["State Management"]',
  '        SJ2["sequence_jobs\\nstep state output error"]',
  '        HP2["hitl_pending_approvals\\nresource_type callback"]',
  '        DLQ2["Dead Letter Queue\\nretry via cron"]',
  '    end',
  '    EV --> FR',
  '    CR --> FR',
  '    RS --> RUNNER',
  '    BDG -->|budget ok| RUNNER',
  '    ADAPT --> ADAPTERS',
  '    HITL --> HP2',
  '    DL2 --> DLQ2',
  '    STEP --> SJ2'
].join('\n'),

mew: [
  'flowchart TB',
  '    MTGEND(["meeting_completed event"])  ',
  '    subgraph W1["Wave 1 — Classify"]',
  '        W1A["meetingTypeClassifier\\n1:1 QBR standup pipeline\\ninternal detector"]',
  '    end',
  '    subgraph W2["Wave 2 — Extract + Analyse"]',
  '        W2A["detect-intents\\ncommitments buying signals\\nschedule_meeting send_proposal"]',
  '        W2B["coaching micro-feedback\\ntalk ratio question quality\\nobjection handling"]',
  '        W2C["roleInference\\nattendee role classification\\nchampion blocker buyer"]',
  '        W2D["agent-relationship-graph\\nupdate relationship edges\\nhealth scoring"]',
  '    end',
  '    subgraph W3["Wave 3 — Draft + Generate"]',
  '        W3A["draft-followup-email\\nAcknowledge-Advance framework\\npersonalised per attendee roles"]',
  '        W3B["suggest-tasks\\naction items from transcript"]',
  '        W3C["crmUpdate\\nauto-update deal fields"]',
  '        W3D["proposalGenerator\\ntriggered by send_proposal intent"]',
  '        W3E["find-available-slots\\ntriggered by schedule_meeting intent"]',
  '    end',
  '    subgraph W4["Wave 4 — Process Signals"]',
  '        W4A["signal-processor\\ndeal temperature change\\nrelationship health delta"]',
  '    end',
  '    subgraph W5["Wave 5 — Notify"]',
  '        W5A["slack-post-meeting\\nmeeting summary to channel"]',
  '        W5B["slack-hitl-notification\\nemail draft approval message\\nApprove and Send Edit Schedule Skip"]',
  '        W5C["slack-deal-alert\\ntemperature or risk change"]',
  '    end',
  '    MTGEND --> W1',
  '    W1 --> W2A & W2B & W2C & W2D',
  '    W2A & W2B --> W3A & W3B & W3C',
  '    W2A -->|schedule_meeting| W3E',
  '    W2A -->|send_proposal| W3D',
  '    W3A & W3B & W3C --> W4A',
  '    W4A --> W5A & W5B & W5C'
].join('\n'),

eml: [
  'flowchart LR',
  '    subgraph DRAFT["Wave 3 — Email Draft"]',
  '        DR["draft-followup-email\\nAcknowledge-Advance framework"]',
  '        CTX["Meeting transcript + attendee roles\\n+ deal memory + contact memory"]',
  '        CTX --> DR',
  '    end',
  '    subgraph HITL["Slack HITL Approval"]',
  '        SN["slack-hitl-notification\\nBlock Kit preview\\neditable To Subject Body"]',
  '        B1["Approve and Send"]',
  '        B2["Edit in Slack modal\\neditable To field"]',
  '        B3["Schedule\\ntimezone-aware via Slack tz_offset"]',
  '        B4["Skip"]',
  '        SN --> B1 & B2 & B3 & B4',
  '    end',
  '    subgraph WEBAPP["In-App Approval"]',
  '        ARD["ApprovalReviewDialog\\n/admin/control-room?approval=id\\neditable To Subject Body"]',
  '        B2 -.->|deep link| ARD',
  '    end',
  '    subgraph SEND["Email Send"]',
  '        RES["resumeSequence()\\norchestrator continues"]',
  '        TXT2HTML["Plain-text to HTML\\nparagraph wrapping\\nnewline to br"]',
  '        HITLF["hitl-send-followup-email\\nroutes by provider"]',
  '        GMAIL["google-gmail\\nGmail API\\nthread-aware In-Reply-To\\nauto-append Gmail signature"]',
  '        MS365["ms-graph-email\\nMicrosoft Graph\\nMail.Send"]',
  '        RES --> HITLF',
  '        HITLF --> TXT2HTML',
  '        TXT2HTML --> GMAIL',
  '        HITLF -->|Microsoft| MS365',
  '    end',
  '    subgraph UNDO["30s Undo Window"]',
  '        Q["Queue delayed send 30s"]',
  '        UB["Slack Undo button"]',
  '        Q --> UB',
  '        UB -->|undo clicked| CANCEL["Cancel send"]',
  '        Q -->|30s elapsed| EXEC["Execute send"]',
  '    end',
  '    subgraph CAP["Safety Guards"]',
  '        DC["Daily send cap per rep\\ndefault 50 configurable"]',
  '        SIG["Gmail signature auto-append\\nfetchGmailSignature via sendAs API\\nHTML and plain-text modes"]',
  '    end',
  '    subgraph LEARN["Autonomy Learning"]',
  '        AP["autopilot_confidence\\nemail.send starts at approve tier"]',
  '        SG["Signals captured\\napprove +1.0 edit +0.3\\nreject -1.0 undo -2.0"]',
  '        PROM["Promotion to auto tier\\nSlack shows Undo instead of Approve"]',
  '        AP --> SG --> PROM',
  '    end',
  '    DR --> SN',
  '    B1 --> RES',
  '    ARD -->|approve| RES',
  '    B4 -->|mark skipped| DONE(["Complete"])',
  '    EXEC --> LEARN',
  '    HITLF --> UNDO',
  '    HITLF --> CAP'
].join('\n'),

esq: [
  'sequenceDiagram',
  '    participant Wave3 as Wave 3 (draft-followup-email)',
  '    participant Orch as Orchestrator Runner',
  '    participant Slack as Slack (hitl-notification)',
  '    participant Rep as Sales Rep',
  '    participant SI as slack-interactive',
  '    participant HITL as hitl-send-followup-email',
  '    participant Gmail as google-gmail',
  '    participant AP as autopilot_confidence',
  '    participant CR as Control Room',
  '    Wave3->>Orch: Draft complete (to, subject, body)',
  '    Orch->>Orch: Set requires_approval = true',
  '    Orch->>Slack: Block Kit message with email preview',
  '    Note over Slack: [Approve and Send] [Edit] [Schedule] [Skip]',
  '    Slack-->>Rep: Notification in Slack channel',
  '    alt Rep clicks Edit in Slack',
  '        Rep->>SI: Opens Slack modal (editable To Subject Body)',
  '        Note over SI: Fire-and-forget modal submission',
  '        Note over SI: Parallel token fetch + approval validation',
  '        SI->>Orch: resumeSequence(edited content)',
  '    else Rep clicks Edit in 60',
  '        Rep->>CR: Deep link /admin/control-room?approval=id',
  '        CR->>CR: ApprovalReviewDialog opens',
  '        CR->>HITL: Approve and Send with edited content',
  '    else Rep clicks Schedule',
  '        Rep->>SI: Opens schedule modal',
  '        Note over SI: Timezone-aware via Slack users.info tz_offset',
  '        SI->>Orch: resumeSequence(scheduled_at in UTC)',
  '    else Rep clicks Approve and Send',
  '        Rep->>SI: Clicks [Approve and Send]',
  '        SI->>Orch: resumeSequence(approval payload)',
  '    end',
  '    Orch->>HITL: Send email with draft content',
  '    HITL->>HITL: Check daily send cap',
  '    HITL->>HITL: Convert plain-text to HTML if needed',
  '    HITL->>HITL: Queue with 30s delay',
  '    HITL->>Slack: Update message with [Undo] button',
  '    Note over HITL: 30 second undo window',
  '    alt Rep clicks Undo within 30s',
  '        Rep->>SI: Clicks [Undo]',
  '        SI->>HITL: Cancel queued send',
  '        HITL->>AP: Record undo signal (-2.0)',
  '        HITL->>Slack: Update to Cancelled',
  '    else 30s elapses',
  '        HITL->>Gmail: Auto-append Gmail signature via sendAs API',
  '        HITL->>Gmail: Send via Gmail API (thread-aware)',
  '        Gmail-->>HITL: Message ID + Thread ID',
  '        HITL->>AP: Record approve signal (+1.0)',
  '        HITL->>Slack: Update to Sent checkmark',
  '    end'
].join('\n'),

rg: [
  'flowchart LR',
  '    subgraph SCHEMA["Schema Layer"]',
  '        DC["deal_contacts\\ndeal_id contact_id role\\nconfidence inferred_from\\nfirst_seen last_active"]',
  '        COH["contact_org_history\\ncontact_id company_id\\ntitle started_at ended_at\\nsource"]',
  '        DHH["deal_health_history\\nexisting health snapshots"]',
  '    end',
  '    subgraph INFER["Role Inference"]',
  '        TRI["Transcript-based\\nWave 2 post-meeting\\nspeaking patterns authority\\nobjection types confidence 0.6-0.9"]',
  '        ERI["Email-based\\nCC BCC reply authority\\nforwarding patterns\\nconfidence 0.4-0.6"]',
  '        MAN["Manual override\\nrep sets role on contact page\\nconfidence 1.0 never overwritten"]',
  '    end',
  '    subgraph INTEL["Graph Intelligence"]',
  '        XD["Cross-deal stakeholder RPC\\ncontacts across multiple deals\\nwith role per deal"]',
  '        MT["Multi-threading score\\nengaged / needed by stage\\nalert when single-threaded"]',
  '        JC["Job change detection\\nApollo periodic check\\nemail domain monitoring"]',
  '        GH["Champion ghost detection\\nlast_active vs threshold\\nchampion_disappeared signal"]',
  '    end',
  '    subgraph AGENTS["Agent Consumers"]',
  '        PREP["Meeting prep agent\\nper-attendee context\\nroles + interaction history"]',
  '        RISK["Deal risk agent\\nchampion engagement\\nmulti-thread score as risk factor"]',
  '        REENG["Re-engagement agent\\njob change = high-priority trigger\\nfull relationship context"]',
  '        DRAFT["Draft follow-up\\npersonalised by attendee roles\\nrelationship strength"]',
  '    end',
  '    TRI --> DC',
  '    ERI --> DC',
  '    MAN --> DC',
  '    DC --> XD & MT & GH',
  '    COH --> JC',
  '    JC --> REENG',
  '    GH --> RISK',
  '    XD --> PREP',
  '    MT --> RISK',
  '    DC --> AGENTS'
].join('\n'),

rgs: [
  'flowchart LR',
  '    subgraph DEALS["deals table"]',
  '        D1["deal_id PK\\nowner_id stage\\npipeline_value"]',
  '    end',
  '    subgraph DC["deal_contacts junction"]',
  '        DC1["deal_id FK\\ncontact_id FK\\nrole enum\\nchampion blocker\\neconomic_buyer influencer\\nend_user technical_evaluator"]',
  '        DC2["confidence float 0-1\\ninferred_from enum\\ntranscript email_pattern\\nmanual enrichment"]',
  '        DC3["first_seen timestamptz\\nlast_active timestamptz"]',
  '    end',
  '    subgraph CONTACTS["contacts table"]',
  '        C1["contact_id PK\\nowner_id name email"]',
  '    end',
  '    subgraph COH["contact_org_history"]',
  '        COH1["contact_id FK\\ncompany_id FK\\ntitle text\\nstarted_at ended_at\\nsource enum"]',
  '    end',
  '    subgraph RPCS["PostgreSQL RPCs"]',
  '        R1["get_cross_deal_stakeholders\\n(contact_id) returns deals with roles"]',
  '        R2["get_deal_stakeholder_map\\n(deal_id) returns contacts with roles"]',
  '    end',
  '    D1 --> DC1',
  '    C1 --> DC1',
  '    DC1 --> DC2 --> DC3',
  '    C1 --> COH1',
  '    DC --> RPCS'
].join('\n'),

rgp: [
  'flowchart LR',
  '    subgraph SOURCES["Inference Sources"]',
  '        TR["Meeting transcript\\nWave 2 roleInference adapter\\nspeaking patterns authority signals"]',
  '        EM["Email patterns\\nemailRoleInference adapter\\nCC BCC reply forwarding"]',
  '        AP["Apollo enrichment\\njob title seniority\\nperiodic refresh"]',
  '        MN["Manual input\\nrep correction on contact page\\nconfidence 1.0"]',
  '    end',
  '    subgraph STORE["deal_contacts"]',
  '        UP["Upsert role\\nupdate confidence and last_active\\nrespect manual overrides"]',
  '    end',
  '    subgraph SCORES["Intelligence Queries"]',
  '        MS["Multi-threading score\\nengaged_contacts / needed\\nby deal stage threshold"]',
  '        GD["Ghost detection\\nchampion last_active vs 21d threshold\\nemit champion_disappeared signal"]',
  '        JCD["Job change\\nApollo title change\\nemail domain change\\ninsert contact_org_history"]',
  '    end',
  '    subgraph ALERTS["Alert Outputs"]',
  '        STA["Single-thread Slack alert\\nwhen score less than 0.5\\nonce per 7d per deal"]',
  '        GHA["Champion ghost alert\\ncommand_centre_item\\nhigh priority"]',
  '        JCA["Job change re-engagement\\nhigh-priority trigger\\norchestrator sequence"]',
  '    end',
  '    TR & EM & AP & MN --> UP',
  '    UP --> MS & GD & JCD',
  '    MS --> STA',
  '    GD --> GHA',
  '    JCD --> JCA'
].join('\n'),

mem: [
  'flowchart LR',
  '    subgraph MODULES["_shared/memory/ — 10 Modules"]',
  '        WR["writer.ts\\nfire-and-forget persistence\\nnever throws on failure"]',
  '        RD2["reader.ts\\nrecall with relevance scoring\\ncontext-aware retrieval"]',
  '        DEC["decay.ts\\ntime-decay for freshness\\ncontact memory half-life"]',
  '        CON["contacts.ts\\ncontact-specific operations\\nper-contact interaction history"]',
  '        REP2["reps.ts\\nrep memory and preferences\\nlearned patterns over time"]',
  '        COM["commitments.ts\\ntrack commitments from meetings\\ndeadlines and follow-ups"]',
  '        TAX["taxonomy.ts\\nmemory categorisation\\ndeal relationship preference"]',
  '        TYP["types.ts\\nTypeScript interfaces\\nAgentMemory MemoryCategory"]',
  '        SNP["snapshot.ts\\npoint-in-time memory snapshots\\ndeal state at moment"]',
  '        RAG["ragClient.ts\\nRAG search across stores\\nsemantic memory retrieval"]',
  '    end',
  '    subgraph TABLE["copilot_memories table"]',
  '        T1["user_id category subject\\ncontent context_summary\\ndeal_id contact_id company_id\\nconfidence source_message_ids\\nlast_accessed_at access_count\\nexpires_at"]',
  '    end',
  '    subgraph CONSUMERS["Memory Consumers"]',
  '        COP["Copilot chat\\npersonalised responses\\nrecall prior conversations"]',
  '        FLEET2["Fleet agents\\ndeal context for risk scoring\\ncontact history for prep"]',
  '        ORCH["Orchestrator\\ndeal memory for proposals\\ncontact memory for emails"]',
  '    end',
  '    WR --> TABLE',
  '    RD2 --> TABLE',
  '    DEC --> TABLE',
  '    RAG --> TABLE',
  '    TABLE --> CONSUMERS'
].join('\n'),

dl: [
  'flowchart LR',
  '    subgraph TABLE2["agent_daily_logs table"]',
  '        C1["id org_id user_id\\nagent_type action_type\\naction_detail JSONB\\ndecision_reasoning text"]',
  '        C2["outcome enum\\nsuccess failed pending\\ncancelled skipped"]',
  '        C3["credit_cost execution_ms\\nchain_id wave_number\\ncreated_at"]',
  '    end',
  '    subgraph MODULE["dailyLog.ts module"]',
  '        LOG["logAgentAction()\\nfire-and-forget\\nnever throws"]',
  '    end',
  '    subgraph HOOKS["Integration Hooks"]',
  '        H1["runner.ts\\nwave step start complete fail"]',
  '        H2["hitl-send-followup-email\\nsend outcome undo skip"]',
  '        H3["emailSend adapter\\ndraft generated"]',
  '        H4["dealRisk adapter\\nrisk assessed"]',
  '        H5["reengagement adapter\\ntrigger fired"]',
  '        H6["preMeeting adapter\\nprep generated"]',
  '    end',
  '    subgraph REPLAY["Chain Replay"]',
  '        CR2["Given chain_id\\nSELECT * ORDER BY wave_number created_at\\nfull step-by-step replay\\nwith timing cost reasoning"]',
  '    end',
  '    subgraph CONSUMERS2["Consumers"]',
  '        CTRL["Control Room Action Feed\\ncross-team stream\\nfilterable expandable"]',
  '        ROI["ROI calculations\\nhours saved metrics\\nfollow-up speed"]',
  '        PRUNE["pg_cron daily 3am UTC\\nDELETE WHERE created_at\\n< NOW - 90 days"]',
  '    end',
  '    LOG --> TABLE2',
  '    HOOKS --> LOG',
  '    TABLE2 --> REPLAY',
  '    TABLE2 --> CONSUMERS2'
].join('\n'),

cr: [
  'flowchart LR',
  '    subgraph ROUTE["Route /admin/control-room"]',
  '        GATE["Admin/Owner RLS gate\\nisUserAdmin() check"]',
  '        QPARAM["?approval=id query param\\ndeep-link from Slack HITL"]',
  '    end',
  '    subgraph HITLREVIEW["HITL Approval Review"]',
  '        ARD["ApprovalReviewDialog\\nopens on ?approval= param\\neditable To Subject Body"]',
  '        FETCH["Fetch hitl_pending_approvals\\nhandle expired not-found already-actioned"]',
  '        APPROVE["Approve and Send\\ncalls hitl-send-followup-email"]',
  '        SKIP["Skip / Reject\\nupdates status directly"]',
  '        ARD --> FETCH',
  '        FETCH --> APPROVE',
  '        FETCH --> SKIP',
  '    end',
  '    subgraph WIDGETS["5 Dashboard Widgets"]',
  '        FP["Fleet Pulse\\n8 agents x status\\nlast run items today\\n7-day error trend\\n60s refetch"]',
  '        TAM["Team Autonomy Matrix\\nreps x action types\\ntier colour coding\\npromotion badges\\n5 min refetch"]',
  '        CH["Credit Health\\ndaily burn vs budget gauge\\nper-agent cost donut\\n30-day trend\\nprojected exhaustion\\n5 min refetch"]',
  '        AF["Action Feed\\ncross-team stream\\nagent_daily_logs primary\\ncommand_centre_items fallback\\nfilter by rep agent type outcome\\nexpandable chain context\\nrealtime subscription"]',
  '        ROI2["ROI Summary\\nhours saved this week\\nmedian follow-up speed\\npipeline coverage percent\\nget_roi_summary RPC"]',
  '    end',
  '    subgraph DATA["Data Sources"]',
  '        SJ2["sequence_jobs\\nfleet agent status"]',
  '        APC["autopilot_confidence\\nautopilot_events"]',
  '        CL3["credit_ledger\\nrollup aggregations"]',
  '        ADL["agent_daily_logs\\nPRD-03"]',
  '        CCI2["command_centre_items\\nfallback source"]',
  '        HPA["hitl_pending_approvals\\nemail draft content"]',
  '    end',
  '    GATE --> WIDGETS',
  '    QPARAM --> ARD',
  '    HPA --> FETCH',
  '    SJ2 --> FP',
  '    APC --> TAM',
  '    CL3 --> CH',
  '    ADL --> AF',
  '    CCI2 -->|fallback| AF',
  '    SJ2 --> ROI2',
  '    ADL --> ROI2'
].join('\n')

}; // end DIAGRAMS


// ── Mermaid setup ──────────────────────────────────────────────
mermaid.initialize({
  startOnLoad: false,
  theme: 'dark',
  themeVariables: {
    primaryColor: '#1e1e2e', primaryBorderColor: '#6366f1',
    primaryTextColor: '#ededed', secondaryColor: '#16162a',
    tertiaryColor: '#1a1a2e', background: '#111111',
    mainBkg: '#1e1e2e', nodeBorder: '#3a3a4a',
    clusterBkg: '#16162a', clusterBorder: '#2a2a3a',
    titleColor: '#ededed', edgeLabelBackground: '#1a1a24',
    lineColor: '#6366f1', textColor: '#ededed',
    fontFamily: "'Inter',-apple-system,sans-serif", fontSize: '13px',
    actorBorder: '#6366f1', actorBkg: '#1e1e2e', actorTextColor: '#ededed',
    signalColor: '#a5b4fc', signalTextColor: '#ededed',
    noteBorderColor: '#8b5cf6', noteBkgColor: '#1e1a2e', noteTextColor: '#ededed',
    activationBorderColor: '#8b5cf6', activationBkgColor: '#1e1a2e',
  }
});

var rendered = {};

async function renderDiagram(key) {
  if (rendered[key]) return;
  var container = document.getElementById(key + '-container');
  if (!container) return;
  var text = DIAGRAMS[key];
  if (!text) return;
  try {
    var result = await mermaid.render('mer-svg-' + key, text);
    container.innerHTML = result.svg;
    if (result.bindFunctions) result.bindFunctions(container);
    rendered[key] = true;
    fitDiagram(key);
  } catch(e) {
    container.innerHTML = '<div class="merr">Error rendering ' + key + ':\n' + e.message + '</div>';
    console.error('Mermaid error [' + key + ']:', e.message, '\n\nDiagram text:\n', text);
  }
}

// Scale diagram to fill its container, never upscaling beyond 100%
function fitDiagram(k) {
  var container = document.getElementById(k + '-container');
  var body = document.getElementById(k + '-body');
  if (!container || !body) return;
  var svg = container.querySelector('svg');
  if (!svg) return;

  // Read natural dimensions from viewBox (available even when element is hidden)
  var svgW, svgH;
  var vb = svg.getAttribute('viewBox');
  if (vb) {
    var parts = vb.trim().split(/[\s,]+/);
    svgW = parseFloat(parts[2]);
    svgH = parseFloat(parts[3]);
  }
  if (!svgW || !svgH) {
    svgW = parseFloat(svg.getAttribute('width')) || 0;
    svgH = parseFloat(svg.getAttribute('height')) || 0;
  }
  if (!svgW || !svgH) return;

  var pad = 56; // 28px stage padding x2
  var bodyW = body.clientWidth  || 900;
  var bodyH = body.clientHeight || 500;
  var scale = Math.min((bodyW - pad) / svgW, (bodyH - pad) / svgH);
  scale = Math.max(0.1, Math.min(scale, 1)); // never upscale beyond 100%

  DS[k] = { s: scale, tx: 0, ty: 0 };
  applyT(k);
}

// Render all diagrams on load
window.addEventListener('DOMContentLoaded', function() {
  Object.keys(DIAGRAMS).forEach(function(k) { renderDiagram(k); });
});

// ── Tab switching ──────────────────────────────────────────────
function switchTab(id) {
  document.querySelectorAll('.tab').forEach(function(t){ t.classList.remove('act'); });
  document.querySelectorAll('.tp').forEach(function(p){ p.classList.remove('act'); });
  document.querySelector('[data-tab="'+id+'"]').classList.add('act');
  document.getElementById('tab-'+id).classList.add('act');
  // Fit all diagrams inside the newly-visible tab panel
  var panel = document.getElementById('tab-'+id);
  if (panel) panel.querySelectorAll('[id$="-container"]').forEach(function(c) {
    var k = c.id.replace('-container',''); fitDiagram(k);
  });
}

// ── Feature pill switching ─────────────────────────────────────
function showF(f) {
  document.querySelectorAll('.pill').forEach(function(p){ p.classList.remove('act'); });
  document.querySelector('[data-f="'+f+'"]').classList.add('act');
  document.querySelectorAll('.fv').forEach(function(v){ v.classList.remove('vis'); });
  var fv = document.getElementById('fv-'+f);
  fv.classList.add('vis');
  // Fit diagrams inside the newly-visible feature view
  fv.querySelectorAll('[id$="-container"]').forEach(function(c) {
    var k = c.id.replace('-container',''); fitDiagram(k);
  });
}

// ── Zoom / pan ─────────────────────────────────────────────────
var DS = {};
['ov','fe','cp','sk','rf','be','ai','ig','sq','rp','sf','cc','au','pf','sc','dm','ccp','aur','pfd','cg','cgd','apo','ape','orch','orch2','mew','eml','esq','rg','rgs','rgp','mem','dl','cr'].forEach(function(k){ DS[k]={s:1,tx:0,ty:0}; });

function applyT(k) {
  var d = DS[k], st = document.getElementById(k+'-stage');
  if (!st) return;
  st.style.transform = 'translate('+d.tx+'px,'+d.ty+'px) scale('+d.s+')';
  var p = document.getElementById(k+'-pct');
  if (p) p.textContent = Math.round(d.s*100)+'%';
}

function zD(k, delta) { DS[k].s = Math.min(4, Math.max(0.2, DS[k].s + delta)); applyT(k); }
function rD(k) { fitDiagram(k); }

['ov','fe','cp','sk','rf','be','ai','ig','sq','rp','sf','cc','au','pf','sc','dm','ccp','aur','pfd','cg','cgd','apo','ape','orch','orch2','mew','eml','esq','rg','rgs','rgp','mem','dl','cr'].forEach(function(k) {
  var el = document.getElementById(k+'-body');
  if (!el) return;
  el.addEventListener('wheel', function(e) {
    e.preventDefault();
    var delta = -e.deltaY * (e.deltaMode === 1 ? 0.05 : 0.0005);
    delta = Math.max(-0.15, Math.min(0.15, delta));
    zD(k, delta);
  }, {passive:false});
  var drag=false, sx=0, sy=0;
  el.addEventListener('mousedown', function(e){ drag=true; sx=e.clientX; sy=e.clientY; el.style.userSelect='none'; });
  window.addEventListener('mousemove', function(e){
    if(!drag) return;
    DS[k].tx+=e.clientX-sx; DS[k].ty+=e.clientY-sy;
    sx=e.clientX; sy=e.clientY; applyT(k);
  });
  window.addEventListener('mouseup', function(){ drag=false; el.style.userSelect=''; });
});

// ── Fullscreen ─────────────────────────────────────────────────
var fsS=1, fsTx=0, fsTy=0;

function openFS(k, title) {
  fsS=1; fsTx=0; fsTy=0;
  var container = document.getElementById(k+'-container');
  var stage = document.getElementById('fsst');
  stage.innerHTML = '';
  if (container) {
    var svg = container.querySelector('svg');
    if (svg) {
      var cl = svg.cloneNode(true);
      cl.style.maxWidth = 'none';
      stage.appendChild(cl);
    }
  }
  document.getElementById('fstl').textContent = title || k;
  document.getElementById('fso').classList.add('open');
  applyFsT();
}

function closeFS() { document.getElementById('fso').classList.remove('open'); document.getElementById('fsst').innerHTML = ''; }
function applyFsT() { document.getElementById('fsst').style.transform='translate('+fsTx+'px,'+fsTy+'px) scale('+fsS+')'; document.getElementById('fs-pct').textContent=Math.round(fsS*100)+'%'; }
function zFS(d) { fsS=Math.min(5,Math.max(0.15,fsS+d)); applyFsT(); }
function rFS() { fsS=1;fsTx=0;fsTy=0; applyFsT(); }

var fsbd=document.getElementById('fsbd');
fsbd.addEventListener('wheel', function(e){ e.preventDefault(); var fd=-e.deltaY*(e.deltaMode===1?0.05:0.0005); fd=Math.max(-0.15,Math.min(0.15,fd)); fsS=Math.min(5,Math.max(0.15,fsS+fd)); applyFsT(); }, {passive:false});
var fsDrag=false, fsSx=0, fsSy=0;
fsbd.addEventListener('mousedown', function(e){ fsDrag=true; fsSx=e.clientX; fsSy=e.clientY; fsbd.style.userSelect='none'; });
window.addEventListener('mousemove', function(e){ if(!fsDrag)return; fsTx+=e.clientX-fsSx; fsTy+=e.clientY-fsSy; fsSx=e.clientX; fsSy=e.clientY; applyFsT(); });
window.addEventListener('mouseup', function(){ fsDrag=false; fsbd.style.userSelect=''; });
window.addEventListener('keydown', function(e){ if(e.key==='Escape') closeFS(); });

// ── V1 / V2 / V2 Only Toggle ────────────────────────────────────
function setVer(ver, btn) {
  document.querySelectorAll('.ver-btn').forEach(function(b){ b.classList.remove('act'); });
  if (btn) btn.classList.add('act');

  // Reset all mode classes
  document.body.classList.remove('show-v2', 'v2-exclusive', 'hl-v2');
  document.getElementById('hl-btn').classList.remove('act');

  if (ver === 'v1') {
    // V1 only — no V2 content shown, V1 content visible (default DOM state)
    fallbackToV1View();
  } else if (ver === 'v2') {
    // V2 — show everything (V1 + V2)
    document.body.classList.add('show-v2');
  } else if (ver === 'v2only') {
    // V2 Only — show V2, hide V1
    document.body.classList.add('show-v2', 'v2-exclusive');
    fallbackToV2View();
  }
}

// When switching to V1, ensure we're not stranded on a V2-only view
function fallbackToV1View() {
  var activeTab = document.querySelector('.tab.act');
  if (activeTab && activeTab.classList.contains('v2-only')) switchTab('system');
  var activePill = document.querySelector('.pill.act');
  if (activePill && activePill.classList.contains('v2-only')) showF('overview');
}

// When switching to V2 Only, ensure we're not stranded on a V1-only view
function fallbackToV2View() {
  var activeTab = document.querySelector('.tab.act');
  if (activeTab && activeTab.classList.contains('v1-content')) switchTab('cmdcentre');
  var activePill = document.querySelector('.pill.act');
  if (activePill && activePill.classList.contains('v1-content')) {
    // Auto-select first V2 pill
    var firstV2Pill = document.querySelector('.pill.v2-only');
    if (firstV2Pill) showF(firstV2Pill.getAttribute('data-f'));
  }
}

function toggleHL() {
  var btn = document.getElementById('hl-btn');
  if (document.body.classList.contains('hl-v2')) {
    document.body.classList.remove('hl-v2');
    btn.classList.remove('act');
  } else {
    // Ensure V2 content is visible (works in both 'v2' and 'v2only' modes)
    if (!document.body.classList.contains('show-v2')) {
      setVer('v2', document.querySelectorAll('.ver-btn')[1]);
    }
    document.body.classList.add('hl-v2');
    btn.classList.add('act');
  }
}

// Default to V2 on load
document.body.classList.add('show-v2');
</script>
</body>
</html>