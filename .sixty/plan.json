{
  "project": {
    "name": "sixty-sales-dashboard",
    "environment": "staging",
    "stack": {
      "framework": "react-vite",
      "database": "supabase",
      "auth": "supabase-auth",
      "email": "aws-ses",
      "deployment": "vercel"
    },
    "createdAt": "2025-01-30T10:00:00Z"
  },
  "features": [
    {
      "id": "onboard-fix",
      "name": "Onboarding & User Management Production Hardening",
      "status": "in_progress",
      "priority": "critical",
      "consultReport": ".sixty/consult/onboarding-production-ready.md",
      "createdAt": "2025-01-30T10:00:00Z",
      "requirements": {
        "emailProvider": "AWS SES",
        "approvalTimeline": "24 hours",
        "rejectionUX": "automatic email notification",
        "duplicateOrgPolicy": "require admin approval"
      }
    },
    {
      "id": "pending-approval-flow",
      "name": "Auto-detect Approval & Dashboard Redirect",
      "status": "pending",
      "priority": "high",
      "prd": null,
      "consultReport": ".sixty/consult/pending-approval-flow.md",
      "createdAt": "2026-02-02T10:30:00Z",
      "description": "Automatically detect when a user's join request is approved and seamlessly redirect them to the dashboard with proper organization context loaded"
    },
    {
      "id": "org-user-removal",
      "name": "Organization User Removal with Rejoin Flow",
      "status": "pending",
      "priority": "high",
      "consultReport": ".sixty/consult/org-user-removal.md",
      "createdAt": "2026-02-02T14:00:00Z",
      "description": "Remove users from org while preserving account/data, redirect to onboarding, rejoin with approval"
    }
  ],
  "stories": [
    {
      "id": "ONBOARD-001",
      "feature": "onboard-fix",
      "title": "Deploy 404 fix to staging Vercel",
      "type": "deployment",
      "status": "pending",
      "priority": 1,
      "dependencies": {
        "stories": [],
        "files": [
          "vercel.json"
        ],
        "schema": []
      },
      "blocks": [
        "ONBOARD-002"
      ],
      "parallelWith": [],
      "acceptance": [
        "vercel.json deployed to staging",
        "/api/admin/invite-user returns 200 (not 404)",
        "Other API routes still functional",
        "Cron jobs still running"
      ],
      "estimatedMinutes": 10,
      "actualMinutes": null,
      "files": [
        "vercel.json"
      ],
      "implementation": {
        "steps": [
          "Commit vercel.json change",
          "Push to staging branch",
          "Wait for Vercel deployment",
          "Test /api/admin/invite-user with curl or Postman"
        ]
      },
      "startedAt": null,
      "completedAt": null
    },
    {
      "id": "ONBOARD-002",
      "feature": "onboard-fix",
      "title": "Add email_status tracking to invitations table",
      "type": "schema",
      "status": "complete",
      "priority": 2,
      "dependencies": {
        "stories": [
          "ONBOARD-001"
        ],
        "files": [],
        "schema": []
      },
      "blocks": [
        "ONBOARD-003",
        "ONBOARD-004"
      ],
      "parallelWith": [],
      "acceptance": [
        "Migration adds email_status enum column (pending, sent, failed, bounced)",
        "Migration adds email_sent_at timestamp column",
        "Migration adds email_error text column",
        "Migration adds resend_count integer column (default 0)",
        "All existing invitations default to 'sent' status"
      ],
      "estimatedMinutes": 15,
      "actualMinutes": 15,
      "files": [
        "supabase/migrations/20260130110000_add_email_tracking_to_invitations.sql"
      ],
      "implementation": {
        "sql": "ALTER TABLE organization_invitations ADD COLUMN email_status text CHECK (email_status IN ('pending', 'sent', 'failed', 'bounced')) DEFAULT 'pending';\nALTER TABLE organization_invitations ADD COLUMN email_sent_at timestamptz;\nALTER TABLE organization_invitations ADD COLUMN email_error text;\nALTER TABLE organization_invitations ADD COLUMN resend_count integer DEFAULT 0;\n-- Update existing rows\nUPDATE organization_invitations SET email_status = 'sent' WHERE email_sent_at IS NULL;"
      },
      "startedAt": "2026-01-30T12:53:00Z",
      "completedAt": "2026-01-30T13:08:00Z"
    },
    {
      "id": "ONBOARD-003",
      "feature": "onboard-fix",
      "title": "Add AWS SES error handling to invite-user API",
      "type": "backend",
      "status": "complete",
      "priority": 3,
      "dependencies": {
        "stories": [
          "ONBOARD-002"
        ],
        "files": [
          "api/admin/invite-user.ts"
        ],
        "schema": [
          "organization_invitations"
        ]
      },
      "blocks": [
        "ONBOARD-004"
      ],
      "parallelWith": [],
      "acceptance": [
        "Catches AWS SES errors when sending email",
        "Updates invitation email_status to 'failed' on error",
        "Stores error message in email_error column",
        "Returns email status in response payload",
        "Logs detailed error for debugging"
      ],
      "estimatedMinutes": 25,
      "actualMinutes": 28,
      "files": [
        "api/admin/invite-user.ts"
      ],
      "implementation": {
        "changes": [
          "Wrap email sending in try-catch",
          "Check SES response for bounce/complaint",
          "Update invitation record with status",
          "Return { emailSent: boolean, emailError?: string } in response"
        ]
      },
      "startedAt": "2026-02-02T15:00:00Z",
      "completedAt": "2026-02-02T15:28:00Z"
    },
    {
      "id": "ONBOARD-004",
      "feature": "onboard-fix",
      "title": "Add email retry logic and resend UI to useUsers hook",
      "type": "frontend",
      "status": "complete",
      "priority": 4,
      "dependencies": {
        "stories": [
          "ONBOARD-003"
        ],
        "files": [
          "src/lib/hooks/useUsers.ts"
        ],
        "schema": []
      },
      "blocks": [],
      "parallelWith": [],
      "acceptance": [
        "Shows 'Email sent successfully' toast when emailSent: true",
        "Shows 'User created but email failed' warning toast when emailSent: false",
        "Warning toast includes 'Resend Email' button",
        "Resend button calls resendInvitation() function",
        "resendInvitation increments resend_count and retries email",
        "Maximum 3 resend attempts enforced"
      ],
      "estimatedMinutes": 30,
      "actualMinutes": 35,
      "files": [
        "src/lib/hooks/useUsers.ts",
        "api/admin/resend-invitation.ts"
      ],
      "implementation": {
        "changes": [
          "Check response.emailSent in inviteUser()",
          "Show appropriate toast based on status",
          "Add resendInvitation(invitationId) function",
          "Call /api/admin/resend-invitation endpoint",
          "Update admin UI to show email status"
        ]
      },
      "startedAt": "2026-02-02T16:00:00Z",
      "completedAt": "2026-02-02T16:35:00Z"
    },
    {
      "id": "ONBOARD-005",
      "feature": "onboard-fix",
      "title": "Create expired invitations cleanup migration",
      "type": "schema",
      "status": "complete",
      "priority": 5,
      "dependencies": {
        "stories": [
          "ONBOARD-001"
        ],
        "files": [],
        "schema": []
      },
      "blocks": [
        "ONBOARD-006"
      ],
      "parallelWith": [
        "ONBOARD-002"
      ],
      "acceptance": [
        "Migration marks invitations >7 days old as 'expired' status",
        "Adds status column if not exists (pending, accepted, expired, cancelled)",
        "Only affects invitations with accepted_at = NULL",
        "Does not delete data (soft expire)",
        "Creates index on (status, created_at) for performance"
      ],
      "estimatedMinutes": 15,
      "actualMinutes": 10,
      "files": [
        "supabase/migrations/20260202093639_expire_old_invitations.sql"
      ],
      "implementation": {
        "sql": "-- Add status if not exists\nALTER TABLE organization_invitations ADD COLUMN IF NOT EXISTS status text CHECK (status IN ('pending', 'accepted', 'expired', 'cancelled')) DEFAULT 'pending';\n-- Expire old invitations\nUPDATE organization_invitations \nSET status = 'expired' \nWHERE accepted_at IS NULL \n  AND created_at < NOW() - INTERVAL '7 days' \n  AND status = 'pending';\n-- Add index\nCREATE INDEX IF NOT EXISTS idx_invitations_status_created ON organization_invitations(status, created_at);"
      },
      "startedAt": "2026-02-02T09:35:00Z",
      "completedAt": "2026-02-02T09:45:00Z"
    },
    {
      "id": "ONBOARD-006",
      "feature": "onboard-fix",
      "title": "Create cleanup-expired-invitations edge function",
      "type": "backend",
      "status": "complete",
      "priority": 6,
      "dependencies": {
        "stories": [
          "ONBOARD-005"
        ],
        "files": [],
        "schema": [
          "organization_invitations"
        ]
      },
      "blocks": [
        "ONBOARD-007"
      ],
      "parallelWith": [],
      "acceptance": [
        "Edge function at supabase/functions/cleanup-expired-invitations/",
        "Marks invitations >7 days old as 'expired'",
        "Returns count of expired invitations",
        "Includes CRON_SECRET validation",
        "Logs summary to console"
      ],
      "estimatedMinutes": 20,
      "actualMinutes": 5,
      "files": [
        "supabase/functions/cleanup-expired-invitations/index.ts"
      ],
      "implementation": {
        "template": "Copy pattern from existing cron functions",
        "logic": "UPDATE organization_invitations SET status = 'expired' WHERE accepted_at IS NULL AND created_at < NOW() - INTERVAL '7 days' AND status = 'pending' RETURNING id"
      },
      "startedAt": "2026-02-02T09:50:00Z",
      "completedAt": "2026-02-02T09:55:00Z"
    },
    {
      "id": "ONBOARD-007",
      "feature": "onboard-fix",
      "title": "Schedule daily cleanup cron in vercel.json",
      "type": "config",
      "status": "complete",
      "priority": 7,
      "dependencies": {
        "stories": [
          "ONBOARD-006"
        ],
        "files": [
          "vercel.json"
        ],
        "schema": []
      },
      "blocks": [],
      "parallelWith": [],
      "acceptance": [
        "Added to vercel.json crons array",
        "Runs at 3 AM daily (0 3 * * *)",
        "Path: /api/cron/cleanup-expired-invitations",
        "Deployed to staging and verified in Vercel dashboard"
      ],
      "estimatedMinutes": 10,
      "actualMinutes": 5,
      "files": [
        "vercel.json"
      ],
      "implementation": {
        "config": "{\n  \"path\": \"/api/cron/cleanup-expired-invitations\",\n  \"schedule\": \"0 3 * * *\"\n}"
      },
      "startedAt": "2026-02-02T09:55:00Z",
      "completedAt": "2026-02-02T10:00:00Z"
    },
    {
      "id": "ONBOARD-008",
      "feature": "onboard-fix",
      "title": "Add processing flag to organization_join_requests table",
      "type": "schema",
      "status": "complete",
      "priority": 8,
      "dependencies": {
        "stories": [
          "ONBOARD-001"
        ],
        "files": [],
        "schema": []
      },
      "blocks": [
        "ONBOARD-009"
      ],
      "parallelWith": [
        "ONBOARD-002",
        "ONBOARD-005"
      ],
      "acceptance": [
        "Migration adds is_processing boolean column (default false)",
        "Migration adds processing_started_at timestamptz column",
        "Creates partial index for active processing rows",
        "All existing rows default to false"
      ],
      "estimatedMinutes": 15,
      "actualMinutes": 15,
      "files": [
        "supabase/migrations/20260130110200_add_processing_flag_to_join_requests.sql"
      ],
      "implementation": {
        "sql": "ALTER TABLE organization_join_requests ADD COLUMN is_processing boolean DEFAULT false;\nALTER TABLE organization_join_requests ADD COLUMN processing_started_at timestamptz;\nCREATE INDEX idx_join_requests_processing ON organization_join_requests(id) WHERE is_processing = true;"
      },
      "startedAt": "2026-02-02T14:30:00Z",
      "completedAt": "2026-02-02T14:45:00Z"
    },
    {
      "id": "ONBOARD-009",
      "feature": "onboard-fix",
      "title": "Update accept_join_request RPC with atomic processing check",
      "type": "backend",
      "status": "complete",
      "priority": 9,
      "dependencies": {
        "stories": [
          "ONBOARD-008"
        ],
        "files": [],
        "schema": [
          "organization_join_requests"
        ]
      },
      "blocks": [],
      "parallelWith": [],
      "acceptance": [
        "RPC atomically checks is_processing = false AND sets to true in single query",
        "Returns error if already processing (concurrent request)",
        "Sets processing_started_at timestamp",
        "Resets is_processing to false on completion or error",
        "Includes timeout protection (auto-reset after 5 minutes)"
      ],
      "estimatedMinutes": 25,
      "actualMinutes": 20,
      "files": [
        "supabase/migrations/20260202095239_update_accept_join_request_with_timeout.sql"
      ],
      "implementation": {
        "pattern": "UPDATE organization_join_requests SET is_processing = true, processing_started_at = NOW() WHERE id = request_id AND (is_processing = false OR processing_started_at < NOW() - INTERVAL '5 minutes') RETURNING id",
        "errorHandling": "IF NOT FOUND THEN RAISE EXCEPTION 'Request is already being processed or does not exist'"
      },
      "startedAt": "2026-02-02T09:52:00Z",
      "completedAt": "2026-02-02T10:12:00Z"
    },
    {
      "id": "ONBOARD-010",
      "feature": "onboard-fix",
      "title": "Add onboarding state persistence to localStorage",
      "type": "frontend",
      "status": "complete",
      "priority": 10,
      "dependencies": {
        "stories": [
          "ONBOARD-001"
        ],
        "files": [
          "src/lib/stores/onboardingV2Store.ts"
        ],
        "schema": []
      },
      "blocks": [
        "ONBOARD-011"
      ],
      "parallelWith": [
        "ONBOARD-003",
        "ONBOARD-006",
        "ONBOARD-009"
      ],
      "acceptance": [
        "Saves onboarding state to localStorage on every step change",
        "Key format: sixty_onboarding_{userId}",
        "Stores: currentStep, domain, website, enrichment, skillConfigs",
        "Does NOT store sensitive data (passwords, tokens)",
        "Clears localStorage on onboarding completion"
      ],
      "estimatedMinutes": 20,
      "actualMinutes": 25,
      "files": [
        "src/lib/stores/onboardingV2Store.ts"
      ],
      "implementation": {
        "changes": [
          "Add persistToLocalStorage() helper function",
          "Call after setCurrentStep(), setDomain(), etc.",
          "Add clearLocalStorage() on completion",
          "Handle JSON parse errors gracefully"
        ]
      },
      "startedAt": "2026-02-02T16:00:00Z",
      "completedAt": "2026-02-02T16:25:00Z"
    },
    {
      "id": "ONBOARD-011",
      "feature": "onboard-fix",
      "title": "Add state restoration on onboarding mount",
      "type": "frontend",
      "status": "complete",
      "priority": 11,
      "dependencies": {
        "stories": [
          "ONBOARD-010"
        ],
        "files": [
          "src/pages/onboarding/v2/OnboardingV2.tsx"
        ],
        "schema": []
      },
      "blocks": [],
      "parallelWith": [],
      "acceptance": [
        "useEffect on mount checks for saved state in localStorage",
        "Validates session is still active before restoring",
        "Restores state to Zustand store if valid",
        "Shows toast: 'Restored your progress' if restored",
        "Clears stale state if session expired"
      ],
      "estimatedMinutes": 20,
      "actualMinutes": 18,
      "files": [
        "src/pages/onboarding/v2/OnboardingV2.tsx"
      ],
      "implementation": {
        "logic": "const savedState = localStorage.getItem(`sixty_onboarding_${userId}`);\nif (savedState && session) {\n  const parsed = JSON.parse(savedState);\n  onboardingStore.restore(parsed);\n  toast.info('Restored your progress');\n}"
      },
      "startedAt": "2026-02-02T16:30:00Z",
      "completedAt": "2026-02-02T16:48:00Z"
    },
    {
      "id": "ONBOARD-012",
      "feature": "onboard-fix",
      "title": "Create AWS SES rejection email template",
      "type": "backend",
      "status": "complete",
      "priority": 12,
      "dependencies": {
        "stories": [
          "ONBOARD-001"
        ],
        "files": [],
        "schema": []
      },
      "blocks": [
        "ONBOARD-013"
      ],
      "parallelWith": [
        "ONBOARD-010"
      ],
      "acceptance": [
        "HTML email template for join request rejection",
        "Includes: organization name, rejection reason, support link",
        "Suggests trying different organization",
        "Professional tone matching brand",
        "Template saved in supabase/functions/_shared/email-templates/"
      ],
      "estimatedMinutes": 20,
      "actualMinutes": 20,
      "files": [
        "supabase/functions/_shared/email-templates/rejection-notification.html"
      ],
      "implementation": {
        "variables": [
          "organizationName",
          "rejectionReason",
          "userFirstName",
          "supportEmail"
        ]
      },
      "startedAt": "2026-01-30T10:00:00Z",
      "completedAt": "2026-01-30T10:20:00Z"
    },
    {
      "id": "ONBOARD-013",
      "feature": "onboard-fix",
      "title": "Add rejection email sending to reject_join_request RPC",
      "type": "backend",
      "status": "complete",
      "priority": 13,
      "dependencies": {
        "stories": [
          "ONBOARD-012"
        ],
        "files": [],
        "schema": [
          "organization_join_requests"
        ]
      },
      "blocks": [
        "ONBOARD-014"
      ],
      "parallelWith": [],
      "acceptance": [
        "RPC calls encharge-send-email edge function on rejection",
        "Uses rejection template from ONBOARD-012",
        "Passes organization name and rejection reason",
        "Non-blocking - continues if email fails",
        "Logs email sending status"
      ],
      "estimatedMinutes": 25,
      "actualMinutes": 25,
      "files": [
        "supabase/migrations/20260202102718_update_reject_join_request_email.sql",
        "supabase/functions/encharge-send-email/index.ts"
      ],
      "implementation": {
        "changes": [
          "Add template_type: 'rejection' to encharge-send-email",
          "Fetch user email and name from join request",
          "Send email after marking request as rejected"
        ]
      },
      "startedAt": "2026-02-02T10:27:00Z",
      "completedAt": "2026-02-02T10:52:00Z"
    },
    {
      "id": "ONBOARD-014",
      "feature": "onboard-fix",
      "title": "Add rejection polling to PendingApprovalStep",
      "type": "frontend",
      "status": "pending",
      "priority": 14,
      "dependencies": {
        "stories": [
          "ONBOARD-013"
        ],
        "files": [
          "src/pages/onboarding/v2/PendingApprovalStep.tsx"
        ],
        "schema": []
      },
      "blocks": [],
      "parallelWith": [],
      "acceptance": [
        "useEffect polls join request status every 10 seconds",
        "Detects when status changes to 'rejected'",
        "Shows rejection message with reason in UI",
        "Displays 'Try Different Organization' button",
        "Button redirects to /onboarding?step=website_input",
        "Stops polling after rejection detected"
      ],
      "estimatedMinutes": 25,
      "actualMinutes": null,
      "files": [
        "src/pages/onboarding/v2/PendingApprovalStep.tsx"
      ],
      "implementation": {
        "polling": "useInterval(() => checkJoinRequestStatus(), 10000)",
        "ui": "Show alert with rejection reason and action button"
      },
      "startedAt": null,
      "completedAt": null
    },
    {
      "id": "ONBOARD-015",
      "feature": "onboard-fix",
      "title": "Add similar_to_org_id and pending_approval to organizations table",
      "type": "schema",
      "status": "pending",
      "priority": 15,
      "dependencies": {
        "stories": [
          "ONBOARD-001"
        ],
        "files": [],
        "schema": []
      },
      "blocks": [
        "ONBOARD-016"
      ],
      "parallelWith": [
        "ONBOARD-008",
        "ONBOARD-012"
      ],
      "acceptance": [
        "Migration adds similar_to_org_id UUID column (nullable, FK to organizations)",
        "Migration adds requires_admin_approval boolean (default false)",
        "Migration adds approval_status enum (pending, approved, rejected)",
        "Migration adds approved_by UUID column (FK to profiles)",
        "Creates index on approval_status for filtering"
      ],
      "estimatedMinutes": 15,
      "actualMinutes": null,
      "files": [
        "supabase/migrations/YYYYMMDD_add_org_approval_fields.sql"
      ],
      "implementation": {
        "sql": "ALTER TABLE organizations ADD COLUMN similar_to_org_id uuid REFERENCES organizations(id);\nALTER TABLE organizations ADD COLUMN requires_admin_approval boolean DEFAULT false;\nALTER TABLE organizations ADD COLUMN approval_status text CHECK (approval_status IN ('pending', 'approved', 'rejected'));\nALTER TABLE organizations ADD COLUMN approved_by uuid REFERENCES profiles(id);\nCREATE INDEX idx_orgs_approval_status ON organizations(approval_status) WHERE requires_admin_approval = true;"
      },
      "startedAt": null,
      "completedAt": null
    },
    {
      "id": "ONBOARD-016",
      "feature": "onboard-fix",
      "title": "Update createOrganizationFromManualData to require approval for similar orgs",
      "type": "frontend",
      "status": "pending",
      "priority": 16,
      "dependencies": {
        "stories": [
          "ONBOARD-015"
        ],
        "files": [
          "src/lib/stores/onboardingV2Store.ts"
        ],
        "schema": [
          "organizations"
        ]
      },
      "blocks": [
        "ONBOARD-017"
      ],
      "parallelWith": [],
      "acceptance": [
        "When similar org found (similarity > 0.7), sets requires_admin_approval: true",
        "Sets similar_to_org_id to matched organization ID",
        "Sets approval_status to 'pending'",
        "Creates organization in pending state",
        "Shows user 'Pending admin review' message"
      ],
      "estimatedMinutes": 25,
      "actualMinutes": null,
      "files": [
        "src/lib/stores/onboardingV2Store.ts"
      ],
      "implementation": {
        "changes": [
          "Add check after fuzzy org search",
          "If match found, set approval fields",
          "Show different UI for pending approval state"
        ]
      },
      "startedAt": null,
      "completedAt": null
    },
    {
      "id": "ONBOARD-017",
      "feature": "onboard-fix",
      "title": "Create org approval notification email",
      "type": "backend",
      "status": "pending",
      "priority": 17,
      "dependencies": {
        "stories": [
          "ONBOARD-016"
        ],
        "files": [],
        "schema": []
      },
      "blocks": [],
      "parallelWith": [],
      "acceptance": [
        "Email template for notifying org admin of new org creation",
        "Includes: new org name, similar org name, user details",
        "Link to admin dashboard to approve/reject",
        "Template saved in email-templates folder",
        "Sent when org created with requires_admin_approval: true"
      ],
      "estimatedMinutes": 20,
      "actualMinutes": null,
      "files": [
        "supabase/functions/_shared/email-templates/org-approval-request.html",
        "src/lib/stores/onboardingV2Store.ts"
      ],
      "implementation": {
        "trigger": "After organization insert, call encharge-send-email with template_type: 'org_approval'"
      },
      "startedAt": null,
      "completedAt": null
    },
    {
      "id": "ONBOARD-018",
      "feature": "onboard-fix",
      "title": "Create invite_attempts tracking table",
      "type": "schema",
      "status": "pending",
      "priority": 18,
      "dependencies": {
        "stories": [
          "ONBOARD-001"
        ],
        "files": [],
        "schema": []
      },
      "blocks": [
        "ONBOARD-019"
      ],
      "parallelWith": [
        "ONBOARD-015"
      ],
      "acceptance": [
        "Table: invite_attempts (id, admin_id, invited_email, organization_id, attempted_at)",
        "Creates index on (admin_id, attempted_at) for rate limiting queries",
        "Creates index on (organization_id, attempted_at) for domain limits",
        "Includes foreign keys to profiles and organizations"
      ],
      "estimatedMinutes": 15,
      "actualMinutes": null,
      "files": [
        "supabase/migrations/YYYYMMDD_create_invite_attempts_table.sql"
      ],
      "implementation": {
        "sql": "CREATE TABLE invite_attempts (\n  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n  admin_id uuid REFERENCES profiles(id) NOT NULL,\n  invited_email text NOT NULL,\n  organization_id uuid REFERENCES organizations(id),\n  attempted_at timestamptz DEFAULT NOW(),\n  success boolean DEFAULT false\n);\nCREATE INDEX idx_invite_attempts_admin ON invite_attempts(admin_id, attempted_at);\nCREATE INDEX idx_invite_attempts_org ON invite_attempts(organization_id, attempted_at);"
      },
      "startedAt": null,
      "completedAt": null
    },
    {
      "id": "ONBOARD-019",
      "feature": "onboard-fix",
      "title": "Add rate limiting to invite-user API",
      "type": "backend",
      "status": "pending",
      "priority": 19,
      "dependencies": {
        "stories": [
          "ONBOARD-018"
        ],
        "files": [
          "api/admin/invite-user.ts"
        ],
        "schema": [
          "invite_attempts"
        ]
      },
      "blocks": [],
      "parallelWith": [],
      "acceptance": [
        "Checks invite_attempts for admin in last 24 hours",
        "Returns 429 error if >10 invites per admin per day",
        "Checks invite_attempts for organization in last 24 hours",
        "Returns 429 error if >50 invites per org per day",
        "Error message shows limit and reset time",
        "Logs rate limit violations"
      ],
      "estimatedMinutes": 30,
      "actualMinutes": null,
      "files": [
        "api/admin/invite-user.ts"
      ],
      "implementation": {
        "queries": [
          "SELECT COUNT(*) FROM invite_attempts WHERE admin_id = $1 AND attempted_at > NOW() - INTERVAL '24 hours'",
          "SELECT COUNT(*) FROM invite_attempts WHERE organization_id = $2 AND attempted_at > NOW() - INTERVAL '24 hours'"
        ],
        "errorResponse": "{ error: 'Rate limit exceeded. You can send 10 more invitations in 8 hours.' }"
      },
      "startedAt": null,
      "completedAt": null
    },
    {
      "id": "PEND-001",
      "feature": "pending-approval-flow",
      "title": "Create useApprovalDetection hook for centralized approval checking",
      "type": "frontend",
      "status": "complete",
      "priority": 20,
      "dependencies": {
        "stories": [],
        "files": [
          "src/lib/supabase/clientV2.ts"
        ],
        "schema": [
          "organization_join_requests",
          "organization_memberships"
        ]
      },
      "blocks": [
        "PEND-002",
        "PEND-003",
        "PEND-006"
      ],
      "parallelWith": [],
      "acceptance": [
        "Hook queries organization_join_requests for pending request",
        "Hook queries organization_memberships to detect if user was added",
        "Returns { isApproved, membership, isPending, error }",
        "Hook is reusable across multiple components"
      ],
      "estimatedMinutes": 15,
      "actualMinutes": 12,
      "files": [
        "src/lib/hooks/useApprovalDetection.ts"
      ],
      "implementation": {
        "approach": "Create React Query hook that checks both tables",
        "keyDecisions": [
          "Use React Query for automatic caching and refetching",
          "Check organization_memberships first (source of truth)",
          "Fall back to organization_join_requests check",
          "Return clear status object"
        ],
        "references": [
          "src/lib/services/joinRequestService.ts (existing patterns)",
          "src/lib/hooks/queries/ (query patterns)"
        ]
      },
      "designRef": null,
      "ticketId": null,
      "startedAt": "2026-02-02T14:30:00Z",
      "completedAt": "2026-02-02T14:42:00Z"
    },
    {
      "id": "PEND-002",
      "feature": "pending-approval-flow",
      "title": "Add automatic polling to PendingApprovalStep component",
      "type": "frontend",
      "status": "complete",
      "priority": 21,
      "dependencies": {
        "stories": [
          "PEND-001"
        ],
        "files": [
          "src/pages/onboarding/v2/PendingApprovalStep.tsx",
          "src/lib/hooks/useApprovalDetection.ts"
        ],
        "schema": []
      },
      "blocks": [
        "PEND-003"
      ],
      "parallelWith": [],
      "acceptance": [
        "Polls every 5 seconds using useApprovalDetection hook",
        "Shows subtle 'Checking status...' indicator during polls",
        "Clears interval on component unmount",
        "Clears interval when approval detected or request cancelled"
      ],
      "estimatedMinutes": 20,
      "actualMinutes": 18,
      "files": [
        "src/pages/onboarding/v2/PendingApprovalStep.tsx"
      ],
      "implementation": {
        "approach": "Add useEffect with setInterval for polling",
        "keyDecisions": [
          "5-second interval balances UX and server load",
          "Use React Query's refetch capability",
          "Clean up interval properly to prevent memory leaks",
          "Show non-intrusive polling indicator"
        ],
        "references": [
          "src/lib/stores/onboardingV2Store.ts:870-961 (enrichment polling pattern)"
        ]
      },
      "designRef": null,
      "ticketId": null,
      "startedAt": "2026-02-02T15:00:00Z",
      "completedAt": "2026-02-02T15:18:00Z"
    },
    {
      "id": "PEND-003",
      "feature": "pending-approval-flow",
      "title": "Implement organization context refresh on approval detection",
      "type": "frontend",
      "status": "complete",
      "priority": 22,
      "dependencies": {
        "stories": [
          "PEND-001",
          "PEND-002"
        ],
        "files": [
          "src/pages/onboarding/v2/PendingApprovalStep.tsx",
          "src/lib/contexts/OrgContext.tsx"
        ],
        "schema": []
      },
      "blocks": [
        "PEND-004"
      ],
      "parallelWith": [],
      "acceptance": [
        "Calls loadOrganizations() from OrgContext when approval detected",
        "Waits for organizations to load before navigation",
        "Automatically switches to newly joined organization using switchOrg()",
        "Updates profile_status to 'active' in profiles table"
      ],
      "estimatedMinutes": 25,
      "actualMinutes": 28,
      "files": [
        "src/pages/onboarding/v2/PendingApprovalStep.tsx"
      ],
      "implementation": {
        "approach": "Use OrgContext methods to refresh and switch organization",
        "keyDecisions": [
          "Use existing loadOrganizations() from OrgContext (line 95-196)",
          "Wait for load completion before redirect to avoid race condition",
          "Auto-select the newly joined org (from pendingJoinRequest.orgId)",
          "Update profile_status to prevent future redirects"
        ],
        "references": [
          "src/lib/contexts/OrgContext.tsx:95-196 (loadOrganizations)",
          "src/pages/auth/AcceptJoinRequest.tsx:80-91 (org refresh pattern)"
        ]
      },
      "designRef": null,
      "ticketId": null,
      "startedAt": "2026-02-02T15:30:00Z",
      "completedAt": "2026-02-02T15:58:00Z"
    },
    {
      "id": "PEND-004",
      "feature": "pending-approval-flow",
      "title": "Mark onboarding complete on approval",
      "type": "frontend",
      "status": "complete",
      "priority": 23,
      "dependencies": {
        "stories": [
          "PEND-003"
        ],
        "files": [
          "src/pages/onboarding/v2/PendingApprovalStep.tsx"
        ],
        "schema": [
          "user_onboarding_progress"
        ]
      },
      "blocks": [],
      "parallelWith": [
        "PEND-005"
      ],
      "acceptance": [
        "Updates user_onboarding_progress.onboarding_step to 'complete'",
        "Sets onboarding_completed_at timestamp",
        "Uses upsert with onConflict: 'user_id'",
        "Prevents redirect back to onboarding after dashboard loads"
      ],
      "estimatedMinutes": 10,
      "actualMinutes": 8,
      "files": [
        "src/pages/onboarding/v2/PendingApprovalStep.tsx"
      ],
      "implementation": {
        "approach": "Copy pattern from AcceptJoinRequest page",
        "keyDecisions": [
          "Mark complete BEFORE navigation to dashboard",
          "Use same upsert pattern as AcceptJoinRequest (lines 92-101)",
          "Handle errors gracefully (log but don't block navigation)"
        ],
        "references": [
          "src/pages/auth/AcceptJoinRequest.tsx:92-101"
        ]
      },
      "designRef": null,
      "ticketId": null,
      "startedAt": "2026-02-02T16:00:00Z",
      "completedAt": "2026-02-02T16:08:00Z"
    },
    {
      "id": "PEND-005",
      "feature": "pending-approval-flow",
      "title": "Add visual feedback during approval detection and dashboard loading",
      "type": "frontend",
      "status": "complete",
      "priority": 24,
      "dependencies": {
        "stories": [
          "PEND-003"
        ],
        "files": [
          "src/pages/onboarding/v2/PendingApprovalStep.tsx"
        ],
        "schema": []
      },
      "blocks": [],
      "parallelWith": [
        "PEND-004"
      ],
      "acceptance": [
        "Shows 'Checking approval status...' with spinner during polls",
        "Shows success animation when approval detected",
        "Shows 'Loading your dashboard...' during org context refresh",
        "Smooth transition to dashboard with no error messages"
      ],
      "estimatedMinutes": 15,
      "actualMinutes": 18,
      "files": [
        "src/pages/onboarding/v2/PendingApprovalStep.tsx"
      ],
      "implementation": {
        "approach": "Add state-based UI feedback components",
        "keyDecisions": [
          "Use existing Loader2 component from lucide-react",
          "Show subtle indicator (not intrusive)",
          "Success animation using Framer Motion (if time permits)",
          "Clear messaging for each state"
        ],
        "references": [
          "src/pages/onboarding/v2/ (existing loading patterns)"
        ]
      },
      "designRef": null,
      "ticketId": null,
      "startedAt": "2026-02-02T16:00:00Z",
      "completedAt": "2026-02-02T16:18:00Z"
    },
    {
      "id": "PEND-006",
      "feature": "pending-approval-flow",
      "title": "Fix error handling to distinguish approved vs cancelled requests",
      "type": "frontend",
      "status": "complete",
      "priority": 25,
      "dependencies": {
        "stories": [
          "PEND-001"
        ],
        "files": [
          "src/pages/onboarding/v2/PendingApprovalStep.tsx"
        ],
        "schema": []
      },
      "blocks": [],
      "parallelWith": [],
      "acceptance": [
        "When join request not found, checks organization_memberships first",
        "If membership exists → user was approved → proceed to dashboard flow",
        "If no membership → request was cancelled → show cancellation message",
        "Removes confusing 'log in' prompt for approved users"
      ],
      "estimatedMinutes": 15,
      "actualMinutes": 18,
      "files": [
        "src/pages/onboarding/v2/PendingApprovalStep.tsx"
      ],
      "implementation": {
        "approach": "Update checkApprovalStatus logic to check memberships",
        "keyDecisions": [
          "Check organization_memberships BEFORE showing error",
          "Use useApprovalDetection hook for consistent logic",
          "Different error messages for different scenarios",
          "Remove 'Please log in' message (user is already authenticated)"
        ],
        "references": [
          "src/pages/onboarding/v2/PendingApprovalStep.tsx:172-226 (updated checkApprovalStatus)"
        ]
      },
      "designRef": null,
      "ticketId": null,
      "startedAt": "2026-02-02T16:00:00Z",
      "completedAt": "2026-02-02T16:18:00Z"
    },
    {
      "id": "PEND-007",
      "feature": "pending-approval-flow",
      "title": "Apply same polling logic to PendingApprovalPage",
      "type": "frontend",
      "status": "complete",
      "priority": 26,
      "dependencies": {
        "stories": [
          "PEND-001",
          "PEND-002",
          "PEND-003",
          "PEND-004"
        ],
        "files": [
          "src/pages/auth/PendingApprovalPage.tsx",
          "src/lib/hooks/useApprovalDetection.ts"
        ],
        "schema": []
      },
      "blocks": [],
      "parallelWith": [],
      "acceptance": [
        "Uses same useApprovalDetection hook",
        "Same polling interval (5 seconds)",
        "Same approval detection and redirect logic",
        "Redirects to /dashboard (not /onboarding) since user completed onboarding"
      ],
      "estimatedMinutes": 10,
      "actualMinutes": 12,
      "files": [
        "src/pages/auth/PendingApprovalPage.tsx"
      ],
      "implementation": {
        "approach": "Copy patterns from PendingApprovalStep to PendingApprovalPage",
        "keyDecisions": [
          "Reuse all logic from PEND-001 through PEND-004",
          "Key difference: redirect to /dashboard not /onboarding/complete",
          "Skip onboarding completion step (already completed)",
          "Maintain consistency in UX between both pages"
        ],
        "references": [
          "src/pages/auth/PendingApprovalPage.tsx (current implementation)",
          "src/pages/onboarding/v2/PendingApprovalStep.tsx (after previous stories)"
        ]
      },
      "designRef": null,
      "ticketId": null,
      "startedAt": "2026-02-02T16:20:00Z",
      "completedAt": "2026-02-02T16:32:00Z"
    },
    {
      "id": "PEND-008",
      "feature": "pending-approval-flow",
      "title": "Update onboarding progress when join request is approved",
      "type": "backend",
      "status": "complete",
      "priority": 27,
      "dependencies": {
        "stories": [],
        "files": [],
        "schema": [
          "organization_join_requests",
          "user_onboarding_progress"
        ]
      },
      "blocks": [],
      "parallelWith": [
        "PEND-009"
      ],
      "acceptance": [
        "approve_join_request RPC updates user_onboarding_progress atomically",
        "Sets onboarding_step to 'complete' when membership is created",
        "Sets onboarding_completed_at timestamp",
        "Uses upsert with onConflict: 'user_id'",
        "Prevents approved users from being redirected back to onboarding"
      ],
      "estimatedMinutes": 20,
      "actualMinutes": 15,
      "files": [
        "supabase/migrations/20260202093644_update_approve_join_request_complete_onboarding.sql"
      ],
      "implementation": {
        "approach": "Modify approve_join_request RPC to update both tables atomically",
        "keyDecisions": [
          "Update happens in same transaction as membership creation",
          "Mark onboarding complete BEFORE deleting join request",
          "Handle case where user_onboarding_progress doesn't exist yet",
          "Don't fail approval if onboarding update fails (log warning)"
        ],
        "sql": "-- Inside approve_join_request RPC, after creating membership:\nINSERT INTO user_onboarding_progress (user_id, onboarding_step, onboarding_completed_at)\nVALUES (p_user_id, 'complete', NOW())\nON CONFLICT (user_id) DO UPDATE\nSET onboarding_step = 'complete', onboarding_completed_at = NOW();",
        "references": [
          "supabase/migrations/20260117000002_add_organization_join_requests.sql (current approve_join_request RPC)",
          "src/pages/auth/AcceptJoinRequest.tsx:92-101 (onboarding completion pattern)"
        ]
      },
      "designRef": null,
      "ticketId": null,
      "startedAt": "2026-02-02T09:36:00Z",
      "completedAt": "2026-02-02T09:37:24Z"
    },
    {
      "id": "PEND-009",
      "feature": "pending-approval-flow",
      "title": "Cleanup auto-created placeholder organizations",
      "type": "frontend",
      "status": "pending",
      "priority": 28,
      "dependencies": {
        "stories": [
          "PEND-003"
        ],
        "files": [
          "src/pages/onboarding/v2/PendingApprovalStep.tsx",
          "src/lib/stores/onboardingV2Store.ts"
        ],
        "schema": [
          "organizations",
          "organization_memberships"
        ]
      },
      "blocks": [],
      "parallelWith": [
        "PEND-008"
      ],
      "acceptance": [
        "When user joins existing org, deletes auto-created placeholder orgs",
        "Only deletes orgs where user is sole owner",
        "Only deletes orgs with generic names like 'Test' or '{firstName}'s Organization'",
        "Checks that org has no other members before deletion",
        "Logs deletion for debugging"
      ],
      "estimatedMinutes": 25,
      "actualMinutes": null,
      "files": [
        "src/pages/onboarding/v2/PendingApprovalStep.tsx"
      ],
      "implementation": {
        "approach": "Add cleanup logic to approval detection handler",
        "keyDecisions": [
          "Run cleanup after successful org switch but before navigation",
          "Use existing pattern from onboardingV2Store.ts lines 748-776",
          "Delete organization_memberships first, then organizations",
          "Non-blocking - don't fail approval if cleanup fails"
        ],
        "logic": "// 1. Query user's organizations where they are owner\n// 2. Filter to orgs with <=1 members and generic names\n// 3. Delete memberships then delete organization\n// 4. Log results to console",
        "references": [
          "src/lib/stores/onboardingV2Store.ts:748-776 (existing cleanup pattern)"
        ]
      },
      "designRef": null,
      "ticketId": null,
      "startedAt": null,
      "completedAt": null
    },
    {
      "id": "PEND-010",
      "feature": "pending-approval-flow",
      "title": "Fix ProtectedRoute to check membership status",
      "type": "frontend",
      "status": "pending",
      "priority": 29,
      "dependencies": {
        "stories": [
          "PEND-008"
        ],
        "files": [
          "src/components/routing/ProtectedRoute.tsx"
        ],
        "schema": [
          "organization_memberships"
        ]
      },
      "blocks": [],
      "parallelWith": [],
      "acceptance": [
        "ProtectedRoute queries organization_memberships when checking access",
        "Allows dashboard access if user has ANY active membership",
        "Only redirects to pending_approval if profile_status is pending AND no memberships exist",
        "Improves UX for users with multiple orgs",
        "Prevents approved members from seeing pending screen"
      ],
      "estimatedMinutes": 20,
      "actualMinutes": null,
      "files": [
        "src/components/routing/ProtectedRoute.tsx"
      ],
      "implementation": {
        "approach": "Add membership check to routing logic",
        "keyDecisions": [
          "Check memberships BEFORE checking profile_status",
          "Cache membership query result to avoid repeated calls",
          "Trust organization_memberships as source of truth",
          "Profile_status becomes fallback check only"
        ],
        "pseudocode": "// 1. Query organization_memberships for current user\n// 2. If any memberships exist -> allow access\n// 3. Else if profile_status === 'pending_approval' -> redirect to pending\n// 4. Else -> allow access (default)",
        "references": [
          "src/components/routing/ProtectedRoute.tsx (current implementation)",
          "src/lib/contexts/OrgContext.tsx (membership loading patterns)"
        ]
      },
      "designRef": null,
      "ticketId": null,
      "startedAt": null,
      "completedAt": null
    },
    {
      "id": "ORGREM-001",
      "feature": "org-user-removal",
      "title": "Add member_status column to organization_memberships",
      "type": "schema",
      "status": "complete",
      "priority": 27,
      "dependencies": {
        "stories": [],
        "files": [],
        "schema": []
      },
      "blocks": [
        "ORGREM-003",
        "ORGREM-007",
        "ORGREM-009"
      ],
      "parallelWith": [
        "ORGREM-002",
        "ORGREM-008"
      ],
      "acceptance": [
        "Migration adds member_status enum ('active', 'removed') column",
        "Migration adds removed_at timestamptz column",
        "Migration adds removed_by UUID column (FK to profiles)",
        "All existing memberships default to 'active' status",
        "Creates index on (org_id, member_status) for filtering"
      ],
      "estimatedMinutes": 30,
      "actualMinutes": 12,
      "files": [
        "supabase/migrations/YYYYMMDD_add_member_status_to_memberships.sql"
      ],
      "startedAt": "2026-02-02T09:38:57.644Z",
      "completedAt": "2026-02-02T09:50:57.644Z"
    },
    {
      "id": "ORGREM-002",
      "feature": "org-user-removal",
      "title": "Create rejoin_requests table schema",
      "type": "schema",
      "status": "complete",
      "priority": 28,
      "dependencies": {
        "stories": [],
        "files": [],
        "schema": [
          "organization_memberships"
        ]
      },
      "blocks": [
        "ORGREM-005",
        "ORGREM-006"
      ],
      "parallelWith": [
        "ORGREM-001",
        "ORGREM-008"
      ],
      "acceptance": [
        "Table: rejoin_requests (id, org_id, user_id, status, requested_at, actioned_by, actioned_at)",
        "Status enum: 'pending', 'approved', 'rejected'",
        "Unique index on (org_id, user_id) WHERE status='pending'",
        "Foreign keys to organizations and profiles tables",
        "RLS policies: users see own requests, org admins see org requests"
      ],
      "estimatedMinutes": 30,
      "actualMinutes": 15,
      "files": [
        "supabase/migrations/YYYYMMDD_create_rejoin_requests_table.sql"
      ],
      "startedAt": "2026-02-02T09:39:31.746Z",
      "completedAt": "2026-02-02T09:39:31.746Z"
    },
    {
      "id": "ORGREM-003",
      "feature": "org-user-removal",
      "title": "Create remove_user_from_org RPC function",
      "type": "backend",
      "status": "complete",
      "priority": 29,
      "dependencies": {
        "stories": [
          "ORGREM-001"
        ],
        "files": [],
        "schema": [
          "organization_memberships"
        ]
      },
      "blocks": [
        "ORGREM-004",
        "ORGREM-013"
      ],
      "parallelWith": [
        "ORGREM-005"
      ],
      "acceptance": [
        "RPC validates caller is org admin or owner",
        "RPC checks user is not the last owner (prevents orphan org)",
        "Updates member_status to 'removed' (no deletion)",
        "Sets removed_at timestamp and removed_by to caller ID",
        "Returns success with { success: true, userId }",
        "Returns error if last owner or not admin"
      ],
      "estimatedMinutes": 25,
      "actualMinutes": 20,
      "files": [
        "supabase/migrations/YYYYMMDD_create_remove_user_from_org_rpc.sql"
      ],
      "startedAt": "2026-02-02T09:40:26.103Z",
      "completedAt": "2026-02-02T09:40:26.103Z"
    },
    {
      "id": "ORGREM-004",
      "feature": "org-user-removal",
      "title": "Create send_user_removal_email edge function",
      "type": "backend",
      "status": "complete",
      "priority": 30,
      "dependencies": {
        "stories": [
          "ORGREM-003",
          "ORGREM-011"
        ],
        "files": [
          "supabase/functions/encharge-send-email/index.ts"
        ],
        "schema": []
      },
      "blocks": [],
      "parallelWith": [
        "ORGREM-012"
      ],
      "acceptance": [
        "Edge function at supabase/functions/send-removal-email/",
        "Calls encharge-send-email with template_type: 'member_removed'",
        "Includes org name, admin contact, rejoin URL in variables",
        "Non-blocking - logs error but doesn't throw",
        "Returns { emailSent: boolean, error?: string }"
      ],
      "estimatedMinutes": 35,
      "actualMinutes": 25,
      "files": [
        "supabase/functions/send-removal-email/index.ts"
      ],
      "startedAt": "2026-02-02T09:55:22.423Z",
      "completedAt": "2026-02-02T09:55:22.423Z"
    },
    {
      "id": "ORGREM-005",
      "feature": "org-user-removal",
      "title": "Create request_rejoin RPC function",
      "type": "backend",
      "status": "complete",
      "priority": 31,
      "dependencies": {
        "stories": [
          "ORGREM-002"
        ],
        "files": [],
        "schema": [
          "rejoin_requests",
          "organization_memberships"
        ]
      },
      "blocks": [
        "ORGREM-014"
      ],
      "parallelWith": [
        "ORGREM-003"
      ],
      "acceptance": [
        "RPC checks member_status='removed' for caller in org",
        "Prevents duplicate pending requests (unique constraint)",
        "Inserts rejoin_request with status='pending'",
        "Returns request ID and success status",
        "Returns error if user not removed or already has pending request"
      ],
      "estimatedMinutes": 25,
      "actualMinutes": 20,
      "files": [
        "supabase/migrations/YYYYMMDD_create_request_rejoin_rpc.sql"
      ],
      "startedAt": "2026-02-02T09:52:29.683Z",
      "completedAt": "2026-02-02T09:52:29.683Z"
    },
    {
      "id": "ORGREM-006",
      "feature": "org-user-removal",
      "title": "Create approve_rejoin_request RPC function",
      "type": "backend",
      "status": "complete",
      "priority": 32,
      "dependencies": {
        "stories": [
          "ORGREM-002",
          "ORGREM-005"
        ],
        "files": [],
        "schema": [
          "rejoin_requests",
          "organization_memberships"
        ]
      },
      "blocks": [
        "ORGREM-015"
      ],
      "parallelWith": [],
      "acceptance": [
        "RPC validates caller is org admin",
        "Updates member_status='active' in organization_memberships",
        "Marks rejoin_request as 'approved' with actioned_by/actioned_at",
        "Sends confirmation email (optional, non-blocking)",
        "Returns success with user_id and org_id",
        "Handles race conditions (request already processed)"
      ],
      "estimatedMinutes": 20,
      "actualMinutes": 20,
      "files": [
        "supabase/migrations/YYYYMMDD_create_approve_rejoin_rpc.sql"
      ],
      "startedAt": "2026-02-02T09:52:29.683Z",
      "completedAt": "2026-02-02T09:52:29.683Z"
    },
    {
      "id": "ORGREM-007",
      "feature": "org-user-removal",
      "title": "Update RLS policies for removed members",
      "type": "backend",
      "status": "complete",
      "priority": 33,
      "dependencies": {
        "stories": [
          "ORGREM-001"
        ],
        "files": [],
        "schema": [
          "deals",
          "contacts",
          "activities",
          "meetings",
          "tasks"
        ]
      },
      "blocks": [],
      "parallelWith": [
        "ORGREM-008"
      ],
      "acceptance": [
        "RLS policies on deals/contacts/activities allow SELECT for removed members",
        "RLS policies PREVENT UPDATE/DELETE for removed members",
        "Test: Removed user can view their old records but not edit"
      ],
      "estimatedMinutes": 30,
      "actualMinutes": 25,
      "files": [
        "supabase/migrations/YYYYMMDD_update_rls_for_removed_users.sql"
      ],
      "startedAt": "2026-02-02T09:52:29.683Z",
      "completedAt": "2026-02-02T09:52:29.683Z"
    },
    {
      "id": "ORGREM-008",
      "feature": "org-user-removal",
      "title": "Add removed_user_redirect flag to profiles",
      "type": "schema",
      "status": "complete",
      "priority": 34,
      "dependencies": {
        "stories": [],
        "files": [],
        "schema": [
          "profiles"
        ]
      },
      "blocks": [
        "ORGREM-009"
      ],
      "parallelWith": [
        "ORGREM-001",
        "ORGREM-002",
        "ORGREM-007"
      ],
      "acceptance": [
        "Migration adds redirect_to_onboarding boolean column (default false)",
        "Used by auth middleware to detect removed users",
        "Set to true when user removed from last/only org",
        "Cleared when user completes onboarding flow"
      ],
      "estimatedMinutes": 20,
      "actualMinutes": 10,
      "files": [
        "supabase/migrations/YYYYMMDD_add_removed_redirect_flag.sql"
      ],
      "startedAt": "2026-02-02T09:39:31.746Z",
      "completedAt": "2026-02-02T09:39:31.746Z"
    },
    {
      "id": "ORGREM-009",
      "feature": "org-user-removal",
      "title": "Implement removal detection in auth middleware",
      "type": "backend",
      "status": "complete",
      "priority": 35,
      "dependencies": {
        "stories": [
          "ORGREM-008",
          "ORGREM-001"
        ],
        "files": [
          "src/lib/contexts/AuthContext.tsx"
        ],
        "schema": [
          "organization_memberships",
          "profiles"
        ]
      },
      "blocks": [
        "ORGREM-010"
      ],
      "parallelWith": [],
      "acceptance": [
        "Auth context checks redirect_to_onboarding flag on load",
        "If true, redirects to /onboarding/removed-user route",
        "Also checks if user has NO active memberships",
        "Returns { user, isRemoved: boolean, hasActiveOrg: boolean }",
        "Runs on every auth state change"
      ],
      "estimatedMinutes": 35,
      "actualMinutes": 30,
      "files": [
        "src/lib/contexts/AuthContext.tsx"
      ],
      "startedAt": "2026-02-02T09:55:22.423Z",
      "completedAt": "2026-02-02T09:55:22.423Z"
    },
    {
      "id": "ORGREM-010",
      "feature": "org-user-removal",
      "title": "Add redirect handler for removed users",
      "type": "frontend",
      "status": "complete",
      "priority": 36,
      "dependencies": {
        "stories": [
          "ORGREM-009"
        ],
        "files": [
          "src/App.tsx"
        ],
        "schema": []
      },
      "blocks": [
        "ORGREM-014"
      ],
      "parallelWith": [],
      "acceptance": [
        "Route: /onboarding/removed-user added to router",
        "useEffect detects isRemoved flag from auth",
        "Redirects to route on detection",
        "Route shows removal message and rejoin option",
        "Clears redirect_to_onboarding after user sees page"
      ],
      "estimatedMinutes": 20,
      "actualMinutes": 15,
      "files": [
        "src/App.tsx",
        "src/pages/onboarding/v2/RemovedUserStep.tsx"
      ],
      "startedAt": "2026-02-02T09:55:22.423Z",
      "completedAt": "2026-02-02T09:55:22.423Z"
    },
    {
      "id": "ORGREM-011",
      "feature": "org-user-removal",
      "title": "Create member_removed email template in DB",
      "type": "backend",
      "status": "complete",
      "priority": 37,
      "dependencies": {
        "stories": [],
        "files": [],
        "schema": [
          "waitlist_email_templates"
        ]
      },
      "blocks": [
        "ORGREM-004"
      ],
      "parallelWith": [
        "ORGREM-012"
      ],
      "acceptance": [
        "Insert into waitlist_email_templates with type='member_removed'",
        "Subject: 'You have been removed from {{org_name}}'",
        "HTML body with: org_name, admin_email, rejoin_url variables",
        "Professional tone matching brand",
        "Suggests rejoin or join different org"
      ],
      "estimatedMinutes": 20,
      "actualMinutes": 15,
      "files": [
        "supabase/migrations/YYYYMMDD_add_member_removed_template.sql"
      ],
      "startedAt": "2026-02-02T09:40:26.103Z",
      "completedAt": "2026-02-02T09:40:26.103Z"
    },
    {
      "id": "ORGREM-012",
      "feature": "org-user-removal",
      "title": "Create rejection email template for rejoin requests",
      "type": "backend",
      "status": "complete",
      "priority": 38,
      "dependencies": {
        "stories": [],
        "files": [],
        "schema": [
          "waitlist_email_templates"
        ]
      },
      "blocks": [],
      "parallelWith": [
        "ORGREM-011",
        "ORGREM-004"
      ],
      "acceptance": [
        "Insert template with type='rejoin_rejected'",
        "Subject: 'Your request to rejoin {{org_name}} was declined'",
        "HTML body with: org_name, rejection_reason, support_link",
        "Suggests trying different organization",
        "Professional, empathetic tone"
      ],
      "estimatedMinutes": 25,
      "actualMinutes": 15,
      "files": [
        "supabase/migrations/YYYYMMDD_add_rejoin_rejected_template.sql"
      ],
      "startedAt": "2026-02-02T09:40:26.103Z",
      "completedAt": "2026-02-02T09:40:26.103Z"
    },
    {
      "id": "ORGREM-013",
      "feature": "org-user-removal",
      "title": "Add Remove User button/modal in TeamMembersPage",
      "type": "frontend",
      "status": "pending",
      "priority": 39,
      "dependencies": {
        "stories": [
          "ORGREM-003",
          "ORGREM-004"
        ],
        "files": [
          "src/pages/settings/TeamMembersPage.tsx"
        ],
        "schema": []
      },
      "blocks": [],
      "parallelWith": [
        "ORGREM-014"
      ],
      "acceptance": [
        "Update existing removal code (lines 298-328) to call RPC",
        "ConfirmDialog variant='destructive' with clear warning",
        "Dialog explains: keeps account & data, user can rejoin",
        "Calls remove_user_from_org RPC on confirm",
        "Triggers send_user_removal_email edge function after success",
        "Toast: 'User removed successfully. They will be notified via email.'",
        "Invalidates org-members query cache"
      ],
      "estimatedMinutes": 30,
      "actualMinutes": null,
      "files": [
        "src/pages/settings/TeamMembersPage.tsx"
      ],
      "startedAt": null,
      "completedAt": null
    },
    {
      "id": "ORGREM-014",
      "feature": "org-user-removal",
      "title": "Build You were removed onboarding screen",
      "type": "frontend",
      "status": "complete",
      "priority": 40,
      "dependencies": {
        "stories": [
          "ORGREM-010",
          "ORGREM-005"
        ],
        "files": [],
        "schema": []
      },
      "blocks": [],
      "parallelWith": [
        "ORGREM-013"
      ],
      "acceptance": [
        "Page: /onboarding/removed-user (RemovedUserStep.tsx)",
        "Shows: 'You were removed from [OrgName]'",
        "Displays: Admin contact info (if available)",
        "CTA: 'Request to Rejoin' button → calls request_rejoin RPC",
        "Secondary: 'Choose Different Organization' → /onboarding?step=org_selection",
        "Toast on successful rejoin request submission",
        "Explains admin must approve before access restored"
      ],
      "estimatedMinutes": 35,
      "actualMinutes": 30,
      "files": [
        "src/pages/onboarding/v2/RemovedUserStep.tsx"
      ],
      "startedAt": "2026-02-02T09:55:22.423Z",
      "completedAt": "2026-02-02T09:55:22.423Z"
    },
    {
      "id": "ORGREM-015",
      "feature": "org-user-removal",
      "title": "Create admin rejoin approval interface",
      "type": "frontend",
      "status": "pending",
      "priority": 41,
      "dependencies": {
        "stories": [
          "ORGREM-006",
          "ORGREM-002"
        ],
        "files": [
          "src/pages/settings/TeamMembersPage.tsx"
        ],
        "schema": [
          "rejoin_requests"
        ]
      },
      "blocks": [],
      "parallelWith": [
        "ORGREM-016"
      ],
      "acceptance": [
        "New tab: 'Rejoin Requests' in TeamMembersPage",
        "Table showing: user email, requested_at, status",
        "Action buttons: Approve (green), Reject (red) with reason textarea",
        "Badge showing count of pending requests",
        "Approve calls approve_rejoin_request RPC",
        "Reject sends rejection email with optional admin notes",
        "Real-time updates via React Query refetch"
      ],
      "estimatedMinutes": 45,
      "actualMinutes": null,
      "files": [
        "src/pages/settings/TeamMembersPage.tsx",
        "src/components/settings/RejoinRequestsTab.tsx"
      ],
      "startedAt": null,
      "completedAt": null
    },
    {
      "id": "ORGREM-016",
      "feature": "org-user-removal",
      "title": "Add member status badge in org members list",
      "type": "frontend",
      "status": "pending",
      "priority": 42,
      "dependencies": {
        "stories": [
          "ORGREM-001"
        ],
        "files": [
          "src/pages/settings/TeamMembersPage.tsx"
        ],
        "schema": []
      },
      "blocks": [],
      "parallelWith": [
        "ORGREM-015"
      ],
      "acceptance": [
        "Member list shows member_status badge next to each user",
        "Badge: 'Removed' in red for member_status='removed'",
        "Shows removed_at date on hover tooltip",
        "Filter/sort options: 'Show removed members' toggle",
        "Removed members appear dimmed/grayed out in list",
        "Shows 'Pending rejoin' indicator if request exists"
      ],
      "estimatedMinutes": 15,
      "actualMinutes": null,
      "files": [
        "src/pages/settings/TeamMembersPage.tsx"
      ],
      "startedAt": null,
      "completedAt": null
    },
    {
      "id": "ORGREM-017",
      "feature": "org-user-removal",
      "title": "Write integration tests for removal flow",
      "type": "test",
      "status": "pending",
      "priority": 43,
      "dependencies": {
        "stories": [
          "ORGREM-003",
          "ORGREM-009",
          "ORGREM-013"
        ],
        "files": [],
        "schema": []
      },
      "blocks": [],
      "parallelWith": [
        "ORGREM-018",
        "ORGREM-019"
      ],
      "acceptance": [
        "Playwright test: Admin removes user from org",
        "Test: Removed user sees removal screen on next login",
        "Test: Removed user can view but not edit their old records (RLS)",
        "Test: Data shows 'created by removed user' label",
        "Test: Removed user receives email notification",
        "Uses test org with 2+ admins to avoid last-owner issue"
      ],
      "estimatedMinutes": 40,
      "actualMinutes": null,
      "files": [
        "tests/e2e/org-user-removal.spec.ts"
      ],
      "startedAt": null,
      "completedAt": null
    },
    {
      "id": "ORGREM-018",
      "feature": "org-user-removal",
      "title": "Write tests for rejoin request flow",
      "type": "test",
      "status": "pending",
      "priority": 44,
      "dependencies": {
        "stories": [
          "ORGREM-005",
          "ORGREM-006",
          "ORGREM-015"
        ],
        "files": [],
        "schema": []
      },
      "blocks": [],
      "parallelWith": [
        "ORGREM-017",
        "ORGREM-019"
      ],
      "acceptance": [
        "Test: Removed user creates rejoin request",
        "Test: Admin approves rejoin request",
        "Test: User regains access after approval",
        "Test: Admin rejects with reason → user receives email",
        "Test: Duplicate request prevention (unique constraint)",
        "Test: Rejoin request appears in admin UI"
      ],
      "estimatedMinutes": 30,
      "actualMinutes": null,
      "files": [
        "tests/e2e/rejoin-request-flow.spec.ts"
      ],
      "startedAt": null,
      "completedAt": null
    },
    {
      "id": "ORGREM-019",
      "feature": "org-user-removal",
      "title": "Test edge cases and error handling",
      "type": "test",
      "status": "pending",
      "priority": 45,
      "dependencies": {
        "stories": [
          "ORGREM-003",
          "ORGREM-006"
        ],
        "files": [],
        "schema": []
      },
      "blocks": [],
      "parallelWith": [
        "ORGREM-017",
        "ORGREM-018"
      ],
      "acceptance": [
        "Test: Cannot remove last owner (RPC returns error)",
        "Test: Cannot remove self (frontend prevents)",
        "Test: Concurrent removal/rejoin requests handled gracefully",
        "Test: RLS edge cases with removed users in shared deals",
        "Test: Email delivery failures logged but don't block flow",
        "Test: Network timeouts during RPC calls handled"
      ],
      "estimatedMinutes": 25,
      "actualMinutes": null,
      "files": [
        "tests/e2e/removal-edge-cases.spec.ts"
      ],
      "startedAt": null,
      "completedAt": null
    }
  ],
  "execution": {
    "totalStories": 48,
    "completedStories": 22,
    "currentFeature": "onboard-fix",
    "parallelGroups": [
      {
        "group": 1,
        "stories": [
          "ONBOARD-002",
          "ONBOARD-005",
          "ONBOARD-008"
        ],
        "reason": "Independent schema migrations, no conflicts",
        "timeSaved": "30 minutes"
      },
      {
        "group": 2,
        "stories": [
          "ONBOARD-003",
          "ONBOARD-006",
          "ONBOARD-009",
          "ONBOARD-010"
        ],
        "reason": "Different files, all depend on ONBOARD-001 completion",
        "timeSaved": "45 minutes"
      },
      {
        "group": 3,
        "stories": [
          "ONBOARD-012",
          "ONBOARD-015",
          "ONBOARD-018"
        ],
        "reason": "Independent schema + template work",
        "timeSaved": "20 minutes"
      },
      {
        "group": 4,
        "stories": [
          "PEND-008",
          "PEND-009"
        ],
        "reason": "Backend RPC update and frontend cleanup can run in parallel",
        "timeSaved": "20 minutes"
      },
      {
        "group": 4,
        "stories": [
          "ORGREM-001",
          "ORGREM-002",
          "ORGREM-008"
        ],
        "reason": "Independent schema migrations, no conflicts",
        "timeSaved": "20 minutes"
      },
      {
        "group": 5,
        "stories": [
          "ORGREM-011",
          "ORGREM-012"
        ],
        "reason": "Email template insertions, can run in parallel",
        "timeSaved": "15 minutes"
      },
      {
        "group": 6,
        "stories": [
          "ORGREM-003",
          "ORGREM-005"
        ],
        "reason": "Independent RPC functions, no file overlap",
        "timeSaved": "10 minutes"
      },
      {
        "group": 7,
        "stories": [
          "ORGREM-013",
          "ORGREM-014"
        ],
        "reason": "Frontend components with no file conflicts",
        "timeSaved": "15 minutes"
      },
      {
        "group": 8,
        "stories": [
          "ORGREM-015",
          "ORGREM-016"
        ],
        "reason": "Both UI updates to TeamMembersPage, different sections",
        "timeSaved": "10 minutes"
      },
      {
        "group": 9,
        "stories": [
          "ORGREM-017",
          "ORGREM-018",
          "ORGREM-019"
        ],
        "reason": "Independent test suites, can run in parallel",
        "timeSaved": "10 minutes"
      }
    ],
    "estimatedTotalMinutes": 1065,
    "estimatedWithParallel": 805,
    "lastUpdated": "2026-02-02T16:32:00Z"
  }
}
