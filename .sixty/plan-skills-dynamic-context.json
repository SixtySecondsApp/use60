{
  "feature": {
    "id": "skills-dynamic-context",
    "name": "Dynamic Context, Tool Awareness & Shared References for Skills",
    "status": "pending",
    "prd": ".claude/skills_improve.md",
    "createdAt": "2026-02-11T00:00:00Z",
    "summary": "Thread org variables + available tools through all skills via shared reference documents that get dynamically inlined at compile time. When a new tool or variable is added, update one doc and recompile — all skills get it automatically."
  },

  "architecture": {
    "approach": "Create a _platform-references meta-skill holding shared docs (available-tools.md, org-variables.md, capabilities.md). Skills include them with @_platform-references/doc-name syntax. The compiler resolves @skill-key/doc-title references by fetching from skill_documents and inlining content. Combined with context_profile for org variable injection and auto-recompile on context changes.",

    "components": [
      "_platform-references meta-skill with shared tool/variable docs",
      "@reference resolution in compile-organization-skills",
      "Reference doc loading in agentSkillExecutor + autonomousExecutor",
      "context_profile frontmatter field + parser update",
      "Context block generator in compile-organization-skills",
      "DB migration: needs_recompile column + trigger + cron",
      "refresh-organization-skills update for context-change detection",
      "Skill body updates (all skills get @references + context_profile)",
      ".claude/skills/ auto-sync in sync-skills.ts",
      "Sync + verify"
    ],

    "keyDecisions": [
      "Shared docs live in a _platform-references meta-skill — not a new table, leverages existing skill_documents",
      "@skill-key/doc-title syntax resolved at compile time — inlined into compiled_content before variable substitution",
      "Skills include only what they need: @_platform-references/capabilities.md maps requires_capabilities to specific execute_action tools",
      "Context profiles (sales/research/communication/full) control which org variables each skill receives",
      "The context block is injected ABOVE the skill body during compilation, so the AI reads it as background context",
      "Only ${company_name} is used inline in skill bodies — everything else comes from context block or shared refs",
      "needs_recompile boolean column — trigger sets it on context change, cron clears it after recompile",
      "Adding a new tool = update available-tools.md + recompile = all skills see it instantly",
      "Integration skills (ai-ark-*, apify-*) get their own capability-specific tool refs, not the full catalog"
    ]
  },

  "stories": [
    {
      "id": "SCTX-001",
      "feature": "skills-dynamic-context",
      "title": "Add context_profile to skill frontmatter spec and parser",
      "type": "schema",
      "status": "pending",
      "priority": 1,

      "description": "Add a `context_profile` field to the skill frontmatter metadata spec. Update the skillParser.ts to extract and pass it through to platform_skills.frontmatter. Update the SKILL_FRONTMATTER_GUIDE.md with the new field spec. Valid profiles: 'sales', 'research', 'communication', 'full'. Default: 'full' if not specified.",

      "dependencies": {
        "stories": [],
        "files": ["scripts/lib/skillParser.ts"],
        "schema": ["platform_skills"]
      },
      "blocks": ["SCTX-002", "SCTX-006", "SCTX-007", "SCTX-008", "SCTX-009", "SCTX-010"],
      "parallelWith": ["SCTX-003", "SCTX-004"],

      "acceptance": [
        "skillParser.ts extracts context_profile from metadata and includes it in frontmatter JSONB",
        "SKILL_FRONTMATTER_GUIDE.md documents the new field with valid values and default behavior",
        "sync-skills dry run succeeds with no errors"
      ],

      "estimatedMinutes": 15,
      "files": [
        "scripts/lib/skillParser.ts",
        "docs/copilot/SKILL_FRONTMATTER_GUIDE.md"
      ]
    },

    {
      "id": "SCTX-002",
      "feature": "skills-dynamic-context",
      "title": "Build context block generator and inject into compilation pipeline",
      "type": "backend",
      "status": "pending",
      "priority": 2,

      "description": "In compile-organization-skills/index.ts:\n\n1. Define CONTEXT_PROFILES map:\n   - sales: company_name, company_bio, products, value_propositions, competitors, icp, ideal_customer_profile, brand_voice, case_studies, customer_logos, pain_points\n   - research: company_name, company_bio, products, competitors, industry, target_market, tech_stack, pain_points, employee_count, company_size\n   - communication: company_name, brand_voice, products, case_studies, customer_logos, value_propositions\n   - full: ALL keys from organization_context\n\n2. Create generateContextBlock(context, profile) function:\n   - Takes org context object + profile name\n   - Returns markdown string: '## Organization Context (Auto-Generated)\\n\\n**Company**: ...\\n**Products**: ...' etc.\n   - Format arrays as comma-separated lists, objects as sub-bullets\n   - Skip null/undefined/empty values\n   - Add disclaimer: '> This context is auto-generated from your organization settings. Update at Settings > Organization.'\n\n3. Modify compileSkillDocument() to:\n   - Read context_profile from frontmatter.metadata.context_profile (default: 'full')\n   - Generate context block\n   - Prepend to compiled content before variable interpolation\n\n4. Store context_hash (MD5 of JSON.stringify(context)) in organization_skills via updated save RPC.",

      "dependencies": {
        "stories": ["SCTX-001"],
        "files": ["supabase/functions/compile-organization-skills/index.ts"],
        "schema": ["organization_skills", "organization_context"]
      },
      "blocks": ["SCTX-011"],
      "parallelWith": [],

      "acceptance": [
        "generateContextBlock produces well-formatted markdown for each profile type",
        "Compiled skills include '## Organization Context' section with real org data",
        "Empty/null context values are omitted (no 'undefined' in output)",
        "Profile 'full' includes all available context keys",
        "Preview action shows the context block without saving"
      ],

      "estimatedMinutes": 30,
      "files": [
        "supabase/functions/compile-organization-skills/index.ts"
      ]
    },

    {
      "id": "SCTX-003",
      "feature": "skills-dynamic-context",
      "title": "DB migration: needs_recompile column + context change trigger",
      "type": "schema",
      "status": "pending",
      "priority": 3,

      "description": "Create a Supabase migration that:\n\n1. Adds `needs_recompile boolean DEFAULT false` column to `organization_skills` table\n2. Adds `context_hash text` column to `organization_skills` table (stores hash of org context at compile time)\n3. Creates trigger function `mark_org_skills_for_recompile()` that sets `needs_recompile = true` for all active org skills when organization_context changes\n4. Creates trigger `trg_org_context_changed` on `organization_context` table (AFTER INSERT OR UPDATE OR DELETE) that calls the function\n5. Updates `get_skills_needing_recompile` RPC to also return rows where `needs_recompile = true`",

      "dependencies": {
        "stories": [],
        "files": [],
        "schema": ["organization_skills", "organization_context"]
      },
      "blocks": ["SCTX-004", "SCTX-005"],
      "parallelWith": ["SCTX-001"],

      "acceptance": [
        "Migration runs without errors on development DB",
        "Updating a row in organization_context sets needs_recompile=true for all org skills",
        "Inserting a new org context row sets needs_recompile=true",
        "Deleting an org context row sets needs_recompile=true",
        "get_skills_needing_recompile returns both version-stale AND needs_recompile=true rows"
      ],

      "estimatedMinutes": 20,
      "files": [
        "supabase/migrations/20260211_skills_auto_recompile.sql"
      ]
    },

    {
      "id": "SCTX-004",
      "feature": "skills-dynamic-context",
      "title": "Update refresh-organization-skills to handle context-change recompilation",
      "type": "backend",
      "status": "pending",
      "priority": 4,

      "description": "Update refresh-organization-skills/index.ts to:\n\n1. In the `refresh_pending` action, also process skills where `needs_recompile = true` (already handled by updated RPC from SCTX-003)\n2. After successful recompilation, set `needs_recompile = false` and update `context_hash`\n3. Add a new action `refresh_context_changed` that specifically processes context-change recompilations (separate from version-stale)\n4. Update the `status` action to report context-change pending count separately\n5. Ensure the compile call includes context block generation (uses same pipeline as compile-organization-skills)",

      "dependencies": {
        "stories": ["SCTX-003"],
        "files": ["supabase/functions/refresh-organization-skills/index.ts"],
        "schema": ["organization_skills"]
      },
      "blocks": ["SCTX-005"],
      "parallelWith": [],

      "acceptance": [
        "refresh_pending processes both version-stale and context-change skills",
        "After recompile, needs_recompile is reset to false",
        "status action reports context_change_pending count",
        "Recompiled skills include the Organization Context block"
      ],

      "estimatedMinutes": 25,
      "files": [
        "supabase/functions/refresh-organization-skills/index.ts"
      ]
    },

    {
      "id": "SCTX-005",
      "feature": "skills-dynamic-context",
      "title": "Add pg_cron job for periodic skill recompilation",
      "type": "schema",
      "status": "pending",
      "priority": 5,

      "description": "Create a migration that adds a pg_cron job to periodically invoke refresh-organization-skills with action=refresh_pending. Run every 5 minutes. Follow the existing pattern from auto-join-scheduler cron. The cron calls the edge function via pg_net http_post (or use the existing cron-to-edge-function pattern in the codebase). Include an enable/disable mechanism.",

      "dependencies": {
        "stories": ["SCTX-003", "SCTX-004"],
        "files": [],
        "schema": []
      },
      "blocks": [],
      "parallelWith": [],

      "acceptance": [
        "pg_cron job is created and scheduled every 5 minutes",
        "Job invokes refresh-organization-skills edge function with action=refresh_pending",
        "Job can be disabled via cron.unschedule or a config flag",
        "Migration includes rollback (DROP cron job)"
      ],

      "estimatedMinutes": 15,
      "files": [
        "supabase/migrations/20260211_skills_recompile_cron.sql"
      ]
    },

    {
      "id": "SCTX-006",
      "feature": "skills-dynamic-context",
      "title": "Update Deal Management skills with context_profile and body references",
      "type": "content",
      "status": "pending",
      "priority": 6,

      "description": "Update 4 Deal Management skills:\n- deal-map-builder\n- deal-next-best-actions\n- deal-rescue-plan\n- deal-slippage-diagnosis\n\nFor each skill:\n1. Add `context_profile: sales` to metadata in frontmatter\n2. Replace generic 'your company/product' language with 'your organization' or reference 'the Organization Context above'\n3. Add ${company_name} inline ONLY where the company name must appear literally (competitive framing, titles)\n4. Update required_context to include 'company_name' if not already present\n5. Do NOT add hardcoded variable references for products, ICP, etc. — those come from the context block",

      "dependencies": {
        "stories": ["SCTX-001"],
        "files": [],
        "schema": []
      },
      "blocks": ["SCTX-011"],
      "parallelWith": ["SCTX-007", "SCTX-008", "SCTX-009", "SCTX-010"],

      "acceptance": [
        "All 4 skills have context_profile: sales in metadata",
        "No hardcoded generic 'your company' language remains — replaced with context-aware references",
        "${company_name} used inline only where necessary",
        "Skills validate with npm run validate-skills"
      ],

      "estimatedMinutes": 20,
      "files": [
        "skills/atomic/deal-map-builder/SKILL.md",
        "skills/atomic/deal-next-best-actions/SKILL.md",
        "skills/atomic/deal-rescue-plan/SKILL.md",
        "skills/atomic/deal-slippage-diagnosis/SKILL.md"
      ]
    },

    {
      "id": "SCTX-007",
      "feature": "skills-dynamic-context",
      "title": "Update Meeting Intelligence skills with context_profile and body references",
      "type": "content",
      "status": "pending",
      "priority": 6,

      "description": "Update 5 Meeting Intelligence skills:\n- meeting-command-center-plan\n- meeting-digest-truth-extractor\n- meeting-prep-brief\n- post-meeting-followup-drafter\n- post-meeting-followup-pack-builder\n\nFor each skill:\n1. Add `context_profile: full` to metadata (meetings need broad context for prep)\n2. Replace generic language with references to 'the Organization Context above'\n3. Add ${company_name} inline where needed\n4. Ensure meeting prep skills reference products, competitors, case studies from context block for talking points",

      "dependencies": {
        "stories": ["SCTX-001"],
        "files": [],
        "schema": []
      },
      "blocks": ["SCTX-011"],
      "parallelWith": ["SCTX-006", "SCTX-008", "SCTX-009", "SCTX-010"],

      "acceptance": [
        "All 5 skills have context_profile: full in metadata",
        "Meeting prep skills reference org products/competitors/case studies via context block",
        "Skills validate with npm run validate-skills"
      ],

      "estimatedMinutes": 25,
      "files": [
        "skills/atomic/meeting-command-center-plan/SKILL.md",
        "skills/atomic/meeting-digest-truth-extractor/SKILL.md",
        "skills/atomic/meeting-prep-brief/SKILL.md",
        "skills/atomic/post-meeting-followup-drafter/SKILL.md",
        "skills/atomic/post-meeting-followup-pack-builder/SKILL.md"
      ]
    },

    {
      "id": "SCTX-008",
      "feature": "skills-dynamic-context",
      "title": "Update Follow-up & Communication skills with context_profile and body references",
      "type": "content",
      "status": "pending",
      "priority": 6,

      "description": "Update 3 Follow-up & Communication skills:\n- followup-reply-drafter\n- followup-triage\n- event-followup-analyzer\n\nFor each skill:\n1. Add `context_profile: communication` to metadata\n2. Replace generic tone/voice references with 'Use the brand voice and tone from Organization Context'\n3. Add ${company_name} inline for email signatures and competitive framing\n4. Reference case studies and value props from context block for follow-up content",

      "dependencies": {
        "stories": ["SCTX-001"],
        "files": [],
        "schema": []
      },
      "blocks": ["SCTX-011"],
      "parallelWith": ["SCTX-006", "SCTX-007", "SCTX-009", "SCTX-010"],

      "acceptance": [
        "All 3 skills have context_profile: communication in metadata",
        "Brand voice references point to context block, not hardcoded values",
        "Skills validate with npm run validate-skills"
      ],

      "estimatedMinutes": 15,
      "files": [
        "skills/atomic/followup-reply-drafter/SKILL.md",
        "skills/atomic/followup-triage/SKILL.md",
        "skills/atomic/event-followup-analyzer/SKILL.md"
      ]
    },

    {
      "id": "SCTX-009",
      "feature": "skills-dynamic-context",
      "title": "Update Lead, Research & Enrichment skills with context_profile and body references",
      "type": "content",
      "status": "pending",
      "priority": 6,

      "description": "Update 6 Lead/Research/Enrichment skills:\n- lead-qualification\n- lead-research\n- company-analysis\n- company-research\n- competitor-intel\n- sales-enrich\n\nFor each skill:\n1. Add `context_profile: research` to metadata (except lead-qualification which gets 'sales')\n2. Replace 'your ICP/product/company' with references to Organization Context\n3. lead-qualification: reference ICP criteria from context block for scoring calibration\n4. competitor-intel: reference org products and value props from context block for battlecard generation\n5. Add ${company_name} inline for competitive positioning and ICP fit assessment",

      "dependencies": {
        "stories": ["SCTX-001"],
        "files": [],
        "schema": []
      },
      "blocks": ["SCTX-011"],
      "parallelWith": ["SCTX-006", "SCTX-007", "SCTX-008", "SCTX-010"],

      "acceptance": [
        "All 6 skills have appropriate context_profile in metadata",
        "lead-qualification references ICP criteria from context block",
        "competitor-intel references products and value props from context block",
        "Skills validate with npm run validate-skills"
      ],

      "estimatedMinutes": 25,
      "files": [
        "skills/atomic/lead-qualification/SKILL.md",
        "skills/atomic/lead-research/SKILL.md",
        "skills/atomic/company-analysis/SKILL.md",
        "skills/atomic/company-research/SKILL.md",
        "skills/atomic/competitor-intel/SKILL.md",
        "skills/atomic/sales-enrich/SKILL.md"
      ]
    },

    {
      "id": "SCTX-010",
      "feature": "skills-dynamic-context",
      "title": "Update Planning, Utility & Outreach skills with context_profile and body references",
      "type": "content",
      "status": "pending",
      "priority": 6,

      "description": "Update 6 Planning/Utility/Outreach skills:\n- daily-brief-planner\n- daily-focus-planner\n- pipeline-focus-task-planner\n- objection-to-playbook\n- sales-sequence\n- proposal-generator\n- search-documentation\n\nFor each skill:\n1. Add appropriate context_profile:\n   - daily-brief-planner, daily-focus-planner: 'full'\n   - pipeline-focus-task-planner: 'sales'\n   - objection-to-playbook: 'sales'\n   - sales-sequence: 'communication'\n   - proposal-generator: 'sales'\n   - search-documentation: 'full'\n2. sales-sequence: Reference brand voice and products from context block for tone calibration\n3. objection-to-playbook: Reference competitors and value props from context block\n4. proposal-generator: Reference products, case studies, and value props from context block",

      "dependencies": {
        "stories": ["SCTX-001"],
        "files": [],
        "schema": []
      },
      "blocks": ["SCTX-011"],
      "parallelWith": ["SCTX-006", "SCTX-007", "SCTX-008", "SCTX-009"],

      "acceptance": [
        "All 7 skills have appropriate context_profile in metadata",
        "sales-sequence references brand voice from context block",
        "objection-to-playbook references competitors from context block",
        "Skills validate with npm run validate-skills"
      ],

      "estimatedMinutes": 25,
      "files": [
        "skills/atomic/daily-brief-planner/SKILL.md",
        "skills/atomic/daily-focus-planner/SKILL.md",
        "skills/atomic/pipeline-focus-task-planner/SKILL.md",
        "skills/atomic/objection-to-playbook/SKILL.md",
        "skills/atomic/sales-sequence/SKILL.md",
        "skills/atomic/proposal-generator/SKILL.md",
        "skills/atomic/search-documentation/SKILL.md"
      ]
    },

    {
      "id": "SCTX-012",
      "feature": "skills-dynamic-context",
      "title": "Create _platform-references meta-skill with shared tool/variable docs",
      "type": "content",
      "status": "pending",
      "priority": 3,

      "description": "Create the `_platform-references` meta-skill directory and shared reference documents:\n\n**Directory**: `skills/atomic/_platform-references/`\n- `SKILL.md` — Minimal meta-skill (category: system, is_active: true, no triggers, description: 'Shared reference documents for tool catalogs, org variables, and capability mappings')\n\n**Reference Docs**:\n\n1. `references/available-tools.md` — Complete tool catalog (source: copilot_adapters/types.ts)\n   - 52 execute_action sub-actions grouped by domain:\n     - CRM Data (8): get_contact, get_lead, get_deal, get_pipeline_summary, get_pipeline_deals, get_pipeline_forecast, get_contacts_needing_attention, get_company_status\n     - Meetings (6): get_meetings, get_booking_stats, get_meeting_count, get_next_meeting, get_meetings_for_period, get_time_breakdown\n     - Email (2): search_emails, draft_email\n     - CRM Updates (2): update_crm, send_notification\n     - Enrichment (2): enrich_contact, enrich_company\n     - Skills (3): invoke_skill, run_skill, run_sequence\n     - Tasks (2): create_task, list_tasks\n     - Activities (1): create_activity\n     - Lead Tables (2): search_leads_create_table, enrich_table_column\n     - Ops Tables CRUD (4): list_ops_tables, get_ops_table, create_ops_table, delete_ops_table\n     - Ops Data (4): add_ops_column, get_ops_table_data, add_ops_rows, update_ops_cell\n     - Ops AI (3): ai_query_ops_table, ai_transform_ops_column, get_enrichment_status\n     - Ops Rules (2): create_ops_rule, list_ops_rules\n     - Ops Integrations (3): sync_ops_hubspot, sync_ops_attio, push_ops_to_instantly\n     - Ops Insights (1): get_ops_insights\n   - Plus: gemini_research tool, resolve_entity tool\n   - For each action: name, key parameters, return shape, requires_confirmation (yes/no)\n\n2. `references/org-variables.md` — Complete variable catalog (source: platformSkillService.ts)\n   - 30 variables in 7 groups:\n     - Company Identity (6): company_name, domain, tagline, description, industry, employee_count\n     - Products (3): products, main_product, value_propositions\n     - Market Intel (4): competitors, primary_competitor, target_market, icp_summary\n     - Additional Intel (5): tech_stack, key_people, pain_points, buying_signals, customer_logos\n     - Brand Voice (6): brand_tone, words_to_avoid, key_phrases, writing_style_name, writing_style_tone, writing_style_examples\n     - ICP (4): icp_company_profile, icp_buyer_persona, qualification_criteria, disqualification_criteria\n     - Copilot (2): copilot_personality, copilot_greeting\n   - ${variable} placeholder syntax, pipe modifiers (|upper, |lower, |join, |count, |first)\n   - Context profile table: which profiles include which variables\n\n3. `references/capabilities.md` — Capability-to-tool mapping\n   - Maps `requires_capabilities` frontmatter values to specific execute_action sub-actions:\n     - crm → get_contact, get_lead, get_deal, get_pipeline_summary, get_pipeline_deals, get_pipeline_forecast, get_contacts_needing_attention, get_company_status, update_crm\n     - email → search_emails, draft_email\n     - calendar → get_meetings, get_next_meeting, get_meetings_for_period, get_booking_stats, get_meeting_count, get_time_breakdown\n     - tasks → create_task, list_tasks\n     - enrichment → enrich_contact, enrich_company\n     - notifications → send_notification\n     - ops_tables → list_ops_tables, get_ops_table, create_ops_table, delete_ops_table, add_ops_column, get_ops_table_data, add_ops_rows, update_ops_cell, ai_query_ops_table, ai_transform_ops_column\n     - skills → invoke_skill, run_skill, run_sequence",

      "dependencies": {
        "stories": [],
        "files": ["supabase/functions/_shared/copilot_adapters/types.ts", "src/lib/services/platformSkillService.ts"],
        "schema": []
      },
      "blocks": ["SCTX-013", "SCTX-016"],
      "parallelWith": ["SCTX-001", "SCTX-003"],

      "acceptance": [
        "_platform-references/SKILL.md exists with valid frontmatter (category: system, is_active: true)",
        "available-tools.md documents all 52 execute_action sub-actions with parameters and return types",
        "org-variables.md documents all 30 context variables with types and context profile membership",
        "capabilities.md maps all 8 capability values to their specific tool actions",
        "npm run validate-skills passes for _platform-references"
      ],

      "estimatedMinutes": 30,
      "files": [
        "skills/atomic/_platform-references/SKILL.md",
        "skills/atomic/_platform-references/references/available-tools.md",
        "skills/atomic/_platform-references/references/org-variables.md",
        "skills/atomic/_platform-references/references/capabilities.md"
      ]
    },

    {
      "id": "SCTX-013",
      "feature": "skills-dynamic-context",
      "title": "Add @reference resolution to compile-organization-skills compiler",
      "type": "backend",
      "status": "pending",
      "priority": 4,

      "description": "Add a `resolveReferences()` step to the compilation pipeline in `compile-organization-skills/index.ts`.\n\nCurrent pipeline (in compileSkillDocument, line ~366):\n1. Extract context_profile from frontmatter\n2. generateContextBlock(context, profile)\n3. Prepend context block to content\n4. compileTemplate() — ${variable} substitution\n5. Return compiled result\n\nNew pipeline:\n1. Extract context_profile from frontmatter\n2. generateContextBlock(context, profile)\n3. Prepend context block to content\n4. **resolveReferences(content, supabase)** — NEW\n5. compileTemplate() — ${variable} substitution\n6. Return compiled result\n\n`resolveReferences()` implementation:\n```typescript\nasync function resolveReferences(content: string, supabase: SupabaseClient): Promise<string> {\n  const refPattern = /@([a-z0-9_-]+)\\/([a-z0-9_.-]+)/g;\n  const matches = [...content.matchAll(refPattern)];\n  if (matches.length === 0) return content;\n\n  // Batch fetch: collect unique skill keys\n  const skillKeys = [...new Set(matches.map(m => m[1]))];\n  const { data: skills } = await supabase\n    .from('platform_skills')\n    .select('id, skill_key')\n    .in('skill_key', skillKeys);\n\n  if (!skills?.length) return content;\n  const skillMap = new Map(skills.map(s => [s.skill_key, s.id]));\n\n  // Batch fetch: collect all doc titles\n  for (const [fullMatch, skillKey, docTitleRaw] of matches) {\n    const title = docTitleRaw.replace(/\\.md$/, '');\n    const skillId = skillMap.get(skillKey);\n    if (!skillId) continue;\n\n    const { data: doc } = await supabase\n      .from('skill_documents')\n      .select('content')\n      .eq('skill_id', skillId)\n      .eq('title', title)\n      .maybeSingle();\n\n    if (doc?.content) {\n      content = content.replace(fullMatch, doc.content);\n    }\n  }\n  return content;\n}\n```\n\nNote: resolveReferences runs BEFORE compileTemplate so that inlined reference content can itself contain ${variables} that get substituted.\n\nThe supabase client is available in the compilation context — pass it through from the handler.",

      "dependencies": {
        "stories": ["SCTX-012", "SCTX-002"],
        "files": ["supabase/functions/compile-organization-skills/index.ts"],
        "schema": ["platform_skills", "skill_documents"]
      },
      "blocks": ["SCTX-011"],
      "parallelWith": ["SCTX-014", "SCTX-015"],

      "acceptance": [
        "@skill-key/doc-title patterns in skill bodies are resolved to actual document content",
        "Missing references are silently skipped (no errors)",
        "Resolved content can itself contain ${variables} that get substituted",
        "Batch fetching minimizes DB round-trips",
        "Skills without @references compile exactly as before (no regression)"
      ],

      "estimatedMinutes": 25,
      "files": [
        "supabase/functions/compile-organization-skills/index.ts"
      ]
    },

    {
      "id": "SCTX-014",
      "feature": "skills-dynamic-context",
      "title": "Add reference document loading to agentSkillExecutor",
      "type": "backend",
      "status": "pending",
      "priority": 5,

      "description": "In `supabase/functions/_shared/agentSkillExecutor.ts`, after loading the skill content from organization_skills, also load skill-specific reference documents and append them.\n\nThe shared `@_platform-references/` docs are already inlined at compile time by the compiler (SCTX-013). But skill-specific references (like `scoring-frameworks.md` for lead-qualification) should also be available at execution time.\n\nAfter loading skill content:\n```typescript\n// Load skill-specific reference docs\nconst { data: refs } = await supabase\n  .from('skill_documents')\n  .select('title, content')\n  .eq('skill_id', skillId)\n  .eq('doc_type', 'reference');\n\nif (refs?.length) {\n  skillContent += '\\n\\n---\\n## Reference Documents\\n';\n  for (const ref of refs) {\n    skillContent += `\\n### ${ref.title}\\n${ref.content}\\n`;\n  }\n}\n```\n\nNote: This is for runtime execution, not compilation. The executor already has the supabase client and skill_id available.",

      "dependencies": {
        "stories": [],
        "files": ["supabase/functions/_shared/agentSkillExecutor.ts"],
        "schema": ["skill_documents"]
      },
      "blocks": ["SCTX-011"],
      "parallelWith": ["SCTX-013", "SCTX-015"],

      "acceptance": [
        "Skill execution includes skill-specific reference docs appended to content",
        "Reference docs are formatted with ### headers for each document",
        "Skills without reference docs execute exactly as before",
        "No duplicate loading of @_platform-references docs (those are already compiled in)"
      ],

      "estimatedMinutes": 15,
      "files": [
        "supabase/functions/_shared/agentSkillExecutor.ts"
      ]
    },

    {
      "id": "SCTX-015",
      "feature": "skills-dynamic-context",
      "title": "Add reference document loading to autonomousExecutor",
      "type": "frontend",
      "status": "pending",
      "priority": 5,

      "description": "In `src/lib/copilot/agent/autonomousExecutor.ts`, when loading skill content for execution (in the skillToTool or skill execution path), also fetch and append skill-specific reference documents.\n\nSame pattern as SCTX-014 but client-side. The autonomousExecutor already queries organization_skills — extend to also query skill_documents for the skill's platform_skill_id.\n\nUses the supabase client from the service locator.",

      "dependencies": {
        "stories": [],
        "files": ["src/lib/copilot/agent/autonomousExecutor.ts"],
        "schema": ["skill_documents"]
      },
      "blocks": ["SCTX-011"],
      "parallelWith": ["SCTX-013", "SCTX-014"],

      "acceptance": [
        "Autonomous skill execution includes skill-specific reference docs",
        "Skills without reference docs execute exactly as before",
        "Reference loading doesn't break the skillToTool() conversion"
      ],

      "estimatedMinutes": 15,
      "files": [
        "src/lib/copilot/agent/autonomousExecutor.ts"
      ]
    },

    {
      "id": "SCTX-016",
      "feature": "skills-dynamic-context",
      "title": "Add @_platform-references includes to all skill bodies",
      "type": "content",
      "status": "pending",
      "priority": 7,

      "description": "For each of the ~56 skills, add the appropriate `@_platform-references/` include lines to their SKILL.md body.\n\nRules:\n- ALL skills get `@_platform-references/org-variables.md` (org context awareness)\n- Skills with `requires_capabilities` in frontmatter get `@_platform-references/capabilities.md` (maps their capabilities to specific tools)\n- Skills that call tools directly (deal-*, meeting-*, pipeline-*, task-*, email-related) also get `@_platform-references/available-tools.md`\n- Pure prompt template skills (no tool calls) only get org-variables\n- Integration skills (ai-ark-*, apify-*) get capabilities.md only (their tools are API-specific, not execute_action)\n- Meta skills (_platform-references, output-format-selector) get nothing\n\nPlacement: Add a section near the top of the skill body, after any ## Role/Context section:\n```markdown\n## Available Context & Tools\n@_platform-references/org-variables.md\n@_platform-references/capabilities.md\n```\n\nThis is a bulk content update across all skill files. Group by batch for efficiency.",

      "dependencies": {
        "stories": ["SCTX-012", "SCTX-001"],
        "files": [],
        "schema": []
      },
      "blocks": ["SCTX-011"],
      "parallelWith": ["SCTX-013", "SCTX-014", "SCTX-015"],

      "acceptance": [
        "All skills with requires_capabilities include @_platform-references/capabilities.md",
        "All skills include @_platform-references/org-variables.md",
        "Include lines are placed consistently near the top of skill bodies",
        "Meta/system skills are excluded from includes",
        "npm run validate-skills passes for all skills"
      ],

      "estimatedMinutes": 30,
      "files": [
        "skills/atomic/*/SKILL.md",
        "skills/sequences/*/SKILL.md"
      ]
    },

    {
      "id": "SCTX-017",
      "feature": "skills-dynamic-context",
      "title": "Add .claude/skills auto-sync to sync-skills.ts",
      "type": "tooling",
      "status": "pending",
      "priority": 6,

      "description": "Add a `syncClaudeSkills()` function at the end of main() in `scripts/sync-skills.ts`.\n\nFor each `skills/atomic/*/SKILL.md`, mirror to `.claude/skills/*/SKILL.md`. Also mirror `references/` subdirectories.\n\nSkip `_platform-references` (not a Claude Code skill — it's a system meta-skill).\n\nThis keeps `.claude/skills/` (Claude Code's skill directory) in sync with `skills/atomic/` (the source of truth for the platform).\n\nCurrently 19 atomic skills are missing from `.claude/skills/`.",

      "dependencies": {
        "stories": [],
        "files": ["scripts/sync-skills.ts"],
        "schema": []
      },
      "blocks": ["SCTX-011"],
      "parallelWith": ["SCTX-012", "SCTX-013"],

      "acceptance": [
        "Running sync-skills mirrors all atomic skills to .claude/skills/",
        "_platform-references is excluded from .claude/skills/ mirror",
        "references/ subdirectories are also mirrored",
        "Existing .claude/skills/ content is overwritten with source of truth from skills/atomic/"
      ],

      "estimatedMinutes": 15,
      "files": [
        "scripts/sync-skills.ts"
      ]
    },

    {
      "id": "SCTX-018",
      "feature": "skills-dynamic-context",
      "title": "Add inputs/outputs frontmatter to skills missing them",
      "type": "content",
      "status": "pending",
      "priority": 7,

      "description": "For each skill missing `inputs` or `outputs` in frontmatter, add structured declarations based on what the skill body expects and returns.\n\nPriority: skills used by `autonomousExecutor.ts` which reads `inputs` to build Claude tool schemas via `skillToTool()`.\n\n~20 skills missing inputs, ~34 missing outputs. Focus on the most-used skills first:\n- deal-next-best-actions: inputs (deal_id or deal_name), outputs (action_plan)\n- meeting-prep-brief: inputs (meeting_id or contact_name), outputs (brief)\n- lead-qualification: inputs (contact_id or lead_info), outputs (score, recommendation)\n- company-research: inputs (company_name or domain), outputs (report)\n- daily-brief-planner: inputs (date?), outputs (brief)\n- followup-reply-drafter: inputs (thread_id or email_context), outputs (draft_email)\n\nFormat per SKILL_FRONTMATTER_GUIDE.md:\n```yaml\ninputs:\n  - name: deal_id\n    type: string\n    required: false\n    description: The deal ID to analyze\noutputs:\n  - name: action_plan\n    type: object\n    description: Ranked list of next best actions\n```",

      "dependencies": {
        "stories": ["SCTX-001"],
        "files": [],
        "schema": []
      },
      "blocks": ["SCTX-011"],
      "parallelWith": ["SCTX-016", "SCTX-006", "SCTX-007", "SCTX-008", "SCTX-009", "SCTX-010"],

      "acceptance": [
        "Top 20 most-used skills have inputs defined in frontmatter",
        "Top 20 most-used skills have outputs defined in frontmatter",
        "Input types match what autonomousExecutor.ts expects for skillToTool()",
        "npm run validate-skills passes"
      ],

      "estimatedMinutes": 25,
      "files": [
        "skills/atomic/*/SKILL.md"
      ]
    },

    {
      "id": "SCTX-011",
      "feature": "skills-dynamic-context",
      "title": "Full sync, compile, deploy, and verify end-to-end",
      "type": "verification",
      "status": "pending",
      "priority": 10,

      "description": "Final verification of the complete dynamic context + shared references system:\n\n1. Run `npm run validate-skills` — all skills must pass (including _platform-references)\n2. Run `npm run sync-skills:dry` — preview changes\n3. Run `npm run sync-skills` — sync all skills + reference docs to staging DB\n4. Deploy updated edge functions to staging:\n   - `compile-organization-skills` (has @reference resolution)\n   - `refresh-organization-skills` (has context-change handling)\n   - `copilot-autonomous` (shares agentSkillExecutor with ref loading)\n   - `api-copilot` (shares agentSkillExecutor with ref loading)\n5. Run migration on staging (needs_recompile column + trigger + cron)\n6. Trigger recompilation for a test org\n7. Verify compiled skill in organization_skills:\n   - Has '## Organization Context' block with real org data\n   - Has inlined content from @_platform-references/ (tool catalog, variables)\n   - No unresolved @references remain\n8. Verify skill execution:\n   - Skill-specific reference docs load at runtime\n   - Compiled tool catalog is present in skill content\n9. Verify context change triggers needs_recompile = true\n10. Run `npm run sync-skills` on production DB\n11. Deploy to production",

      "dependencies": {
        "stories": ["SCTX-002", "SCTX-005", "SCTX-006", "SCTX-007", "SCTX-008", "SCTX-009", "SCTX-010", "SCTX-013", "SCTX-014", "SCTX-015", "SCTX-016", "SCTX-017", "SCTX-018"],
        "files": [],
        "schema": []
      },
      "blocks": [],
      "parallelWith": [],

      "acceptance": [
        "validate-skills passes for all skills including _platform-references",
        "sync-skills completes without errors on both staging and production",
        "Compiled skills contain inlined tool catalog from @_platform-references/available-tools.md",
        "Compiled skills contain inlined variable docs from @_platform-references/org-variables.md",
        "Organization Context block appears in compiled skills with real org data",
        "Edge functions deploy to staging and production successfully",
        "Context change triggers needs_recompile flag",
        "Skill execution loads skill-specific reference docs at runtime",
        ".claude/skills/ is in sync with skills/atomic/"
      ],

      "estimatedMinutes": 30,
      "files": []
    }
  ],

  "execution": {
    "totalStories": 18,
    "estimatedMinutes": 360,
    "estimatedHours": "5.5-6.5",

    "parallelGroups": [
      {
        "name": "Foundation (3-way parallel)",
        "stories": ["SCTX-001", "SCTX-003", "SCTX-012"],
        "description": "Frontmatter spec + DB migration + shared reference docs can all proceed in parallel"
      },
      {
        "name": "Compiler & Refresh Pipeline (sequential)",
        "stories": ["SCTX-002", "SCTX-004", "SCTX-005", "SCTX-013"],
        "description": "Context block generator → refresh update → cron → @reference resolution. Sequential because each builds on previous."
      },
      {
        "name": "Executor Updates (2-way parallel)",
        "stories": ["SCTX-014", "SCTX-015"],
        "description": "agentSkillExecutor + autonomousExecutor reference loading. Independent of each other, can parallel with SCTX-013."
      },
      {
        "name": "Skill Content Updates (7-way parallel)",
        "stories": ["SCTX-006", "SCTX-007", "SCTX-008", "SCTX-009", "SCTX-010", "SCTX-016", "SCTX-018"],
        "description": "All skill batch updates (context profiles, @references, inputs/outputs) can run in parallel once SCTX-001 + SCTX-012 are done."
      },
      {
        "name": "Tooling",
        "stories": ["SCTX-017"],
        "description": ".claude/skills auto-sync. Independent, can run anytime."
      },
      {
        "name": "Final Verification",
        "stories": ["SCTX-011"],
        "description": "Full sync, compile, deploy, and verify. Runs last after all other stories complete."
      }
    ],

    "criticalPath": "SCTX-012 → SCTX-013 → SCTX-011 (shared refs through compiler to verification)",
    "secondaryCriticalPath": "SCTX-001 → SCTX-002 → SCTX-013 → SCTX-011 (context profiles through compiler to verification)",
    "skillsAffected": "All ~56 skills (shared reference includes + context profiles)",
    "newFiles": 4,
    "modifiedEdgeFunctions": 3,
    "modifiedScripts": 1
  },

  "contextProfiles": {
    "sales": {
      "description": "Deal management, pipeline, qualification, proposals",
      "variables": ["company_name", "company_bio", "products", "value_propositions", "competitors", "icp", "ideal_customer_profile", "brand_voice", "case_studies", "customer_logos", "pain_points"],
      "skills": ["deal-map-builder", "deal-next-best-actions", "deal-rescue-plan", "deal-slippage-diagnosis", "pipeline-focus-task-planner", "objection-to-playbook", "lead-qualification", "proposal-generator"]
    },
    "research": {
      "description": "Company intelligence, lead research, competitive analysis",
      "variables": ["company_name", "company_bio", "products", "competitors", "industry", "target_market", "tech_stack", "pain_points", "employee_count", "company_size"],
      "skills": ["company-analysis", "company-research", "competitor-intel", "lead-research", "sales-enrich"]
    },
    "communication": {
      "description": "Email drafting, follow-ups, outreach, tone-sensitive content",
      "variables": ["company_name", "brand_voice", "products", "case_studies", "customer_logos", "value_propositions"],
      "skills": ["followup-reply-drafter", "followup-triage", "event-followup-analyzer", "sales-sequence"]
    },
    "full": {
      "description": "All available context — meeting prep, daily planning, search",
      "variables": "ALL keys from organization_context",
      "skills": ["meeting-command-center-plan", "meeting-digest-truth-extractor", "meeting-prep-brief", "post-meeting-followup-drafter", "post-meeting-followup-pack-builder", "daily-brief-planner", "daily-focus-planner", "search-documentation"]
    }
  },

  "sharedReferences": {
    "metaSkill": "_platform-references",
    "docs": {
      "available-tools.md": "Complete catalog of 52 execute_action sub-actions + gemini_research + resolve_entity",
      "org-variables.md": "All 30 organization context variables with types, profiles, and ${} syntax",
      "capabilities.md": "Maps requires_capabilities values to specific execute_action sub-actions"
    },
    "resolutionSyntax": "@skill-key/doc-title (e.g., @_platform-references/available-tools.md)",
    "resolvedAt": "compile-time by compile-organization-skills",
    "updateWorkflow": "Edit shared doc → run sync-skills → trigger recompile → all skills updated"
  }
}
