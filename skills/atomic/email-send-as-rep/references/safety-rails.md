# Email Send-as-Rep: Safety Rails

This document defines the non-negotiable safety rules for the email-send-as-rep skill. These rules are absolute. They cannot be relaxed by configuration, admin override, user preference, or edge case reasoning. If a rule in this document conflicts with a feature request, this document wins.

## 1. Human-in-the-Loop Approval Matrix

### What Requires Approval

Everything. Every email sent through this skill requires explicit human approval.

| Scenario | Requires Approval? | Notes |
|----------|-------------------|-------|
| New email to a contact | YES | Always |
| Reply to existing thread | YES | Always |
| Follow-up from a sequence | YES | Always |
| Re-send after edit | YES | Always |
| Scheduled email at send time | YES (pre-approved) | Approval given at scheduling time |
| Email generated by another skill | YES | Content approval != send approval |
| Email with rep-provided body | YES | Even if they wrote every word |
| Test email to self | YES | No exceptions means no exceptions |
| Email to internal team member | YES | This skill is for external sends; internal emails go through normal email client |
| Bulk/batch emails | NOT SUPPORTED | This skill does not support bulk sending |
| Auto-triggered emails | NOT SUPPORTED | No event-based auto-send |

### What Counts as Approval

An approval is valid ONLY when ALL of the following are true:

1. **Explicit action** -- the rep clicked a "Send" button or typed "Confirm"/"Send" in copilot chat
2. **Authenticated identity** -- the approval is tied to the rep's Slack user ID or copilot session
3. **Specific to this email** -- the approval references the exact email (by approval_id or body_hash)
4. **Not expired** -- the approval was given within the last 30 minutes
5. **Not previously used** -- each approval_id can only be consumed once

The following do NOT count as approval:

- A general instruction like "send all my follow-ups" (too broad, not specific)
- An approval for a different email (wrong approval_id)
- An approval older than 30 minutes (expired)
- An approval from a different user (wrong identity)
- Silence or inaction (absence of rejection is not approval)
- A "yes" in a different conversational context (must be in response to a specific preview)

### Approval Integrity Checks

Before consuming an approval, verify:

```
1. approval_record.status == 'pending' (not already consumed)
2. approval_record.expires_at > NOW() (not expired)
3. approval_record.user_id == requesting_user_id (correct user)
4. approval_record.body_hash == current_body_hash (email wasn't modified after approval)
5. approval_record.action_type == 'email_send_approval' (correct action type)
```

If the body was modified after approval (hash mismatch), the approval is INVALID. The rep must re-approve the modified version. This prevents a scenario where the email is changed between approval and send.

## 2. Daily Send Limits

### Default Limits

| Tier | Daily Limit | Applies To |
|------|-------------|------------|
| Default | 50 emails/day | All users unless overridden |
| Elevated | 100 emails/day | Configured per-user by org admin |
| Maximum | 200 emails/day | Hard ceiling, cannot be exceeded even by admin |

The 200/day maximum is a hard architectural limit. It exists to protect sender reputation and prevent abuse regardless of configuration. Even if an admin sets a user's limit to 500, the system caps at 200.

### Limit Enforcement

```
ON each send attempt:
  current_count = COUNT(sent_emails WHERE user_id = rep AND sent_date = TODAY)
  IF current_count >= user_daily_limit:
    REJECT with "Daily send limit reached"
    DO NOT queue for later
    INFORM user of limit and reset time
  IF current_count >= 200:
    REJECT unconditionally (hard ceiling)
```

### Limit Configuration

Org admins can adjust limits via Settings > Email > Send Limits:

- **Per-user limits** -- set different limits for different reps
- **Org-wide default** -- change the default from 50 for all users
- **Cannot exceed 200** -- the UI prevents setting limits above 200
- **Limit changes take effect immediately** -- lowering a limit mid-day does not unsend emails
- **Limit resets at midnight** in the user's configured timezone

### Limit Visibility

Reps can see their remaining sends:
- In the email composition preview: "You have [X] sends remaining today"
- In Settings > Email: daily send usage chart
- In Slack approval messages: send count included in the footer

## 3. Quiet Hours Enforcement

### How Quiet Hours Work

Reps can configure quiet hours -- times when they don't want emails sent from their account. This is a soft gate: the rep is informed and can override.

### Default Quiet Hours

No quiet hours are configured by default. Reps set their own via Settings > Email > Quiet Hours.

### Quiet Hours Behavior

```
IF current_time is within quiet_hours:
  DO NOT send automatically
  PRESENT options to rep:
    1. "Schedule for [quiet_hours_end]" -- queue for delivery when quiet hours end
    2. "Send anyway" -- override quiet hours for this email only
    3. "Cancel" -- do not send
  LOG the override if rep chooses option 2
```

### Quiet Hours vs Scheduled Sends

If a rep schedules an email for a time that falls within their quiet hours:
- Warn at scheduling time: "This is scheduled for [time], which is within your quiet hours. Send anyway?"
- If approved, the email sends at the scheduled time regardless of quiet hours
- The approval at scheduling time serves as the override

### Recipient Timezone Awareness

Quiet hours are about the REP's preferences, not the recipient's timezone. However, the system should warn if sending to a recipient whose timezone suggests it's outside business hours:
- "Note: It's [time] in [recipient's timezone]. You might want to schedule this for their morning."
- This is a suggestion, not a gate. The rep decides.

## 4. OAuth Scope Requirements

### Required Scopes

| Provider | Required Scope | Purpose |
|----------|---------------|---------|
| Gmail | `https://www.googleapis.com/auth/gmail.send` | Send emails |
| Gmail | `https://www.googleapis.com/auth/gmail.readonly` | Read threads for replies |
| Office 365 | `Mail.Send` | Send emails |
| Office 365 | `Mail.Read` | Read threads for replies |

### Scope Verification

Before every send attempt, verify the stored token has the required scopes:

```
1. Decode the OAuth token (or check stored scope list)
2. Verify gmail.send (or Mail.Send) is present
3. If missing, DO NOT attempt to send
4. Inform rep: "Your email connection is missing send permissions"
5. Provide reconnection link with correct scopes
```

### Re-Authorization Flow

When a token is expired or missing scopes:

1. **Detect** -- token refresh fails or scope check fails
2. **Store state** -- save the composed email in `pending_emails` table
3. **Redirect** -- send rep to OAuth re-authorization with correct scopes
4. **Resume** -- after re-auth, offer to resume the pending send
5. **Expire** -- pending emails expire after 24 hours if not resumed

The rep should never lose their composed email due to an OAuth issue. The email is preserved until re-auth completes or 24 hours pass.

### Token Storage Security

- OAuth tokens are encrypted at rest in the database
- Refresh tokens are stored separately with additional encryption
- Tokens are never logged in plaintext
- Tokens are never included in error messages or audit records
- Token scopes are logged (they're not secret), but the token value itself is never logged

## 5. Undo Window Mechanics

### How the Undo Window Works

After the rep clicks "Send Now":

```
T+0s:   Rep clicks "Send Now"
        Slack message updates: "Sending in 30 seconds... [Cancel Send]"
        Timer starts
T+0-30s: Cancel window is OPEN
        If rep clicks "Cancel Send":
          Cancel the send
          Update Slack: "Email cancelled. Not sent."
          Log: cancelled_during_undo
          STOP
T+30s:  Cancel window CLOSES
        Execute the actual API send call
        Update Slack: "Sent at [time] to [recipient]"
        Remove all buttons
```

### Why 30 Seconds

- Long enough to catch "wrong recipient" or "wait, I need to change something"
- Short enough to not annoy reps who are sure
- Standard in email clients (Gmail uses 5-30s configurable)
- We default to 30s because AI-composed emails deserve more review time

### Undo Window Configuration

- Default: 30 seconds
- Minimum: 10 seconds (cannot be disabled entirely)
- Maximum: 120 seconds
- Configurable per-user in Settings > Email > Undo Window

The undo window cannot be set to 0. A minimum 10-second window is always enforced. This is a safety rail, not a preference.

### Undo During Network Issues

If the 30-second window passes but the send API call fails:
- The email has NOT been sent (the undo effectively happened automatically)
- Inform the rep of the failure
- Do not auto-retry without re-approval if more than 5 minutes have passed

## 6. Audit Trail Requirements

### What Is Logged

Every email send attempt generates an audit record, regardless of outcome:

| Field | Always Logged | Notes |
|-------|--------------|-------|
| `user_id` | YES | The rep whose account is used |
| `recipient_email` | YES | The To address |
| `cc_emails` | YES | CC addresses (if any) |
| `bcc_emails` | YES | BCC addresses (if any) |
| `subject` | YES | Full subject line |
| `body_hash` | YES | SHA-256 hash of the body (NOT the body itself) |
| `body_plaintext` | NO | Never stored in audit (see PII rules below) |
| `thread_id` | YES | If reply, the thread ID |
| `sent_message_id` | YES (if sent) | The provider's message ID |
| `sent_at` | YES (if sent) | Timestamp of actual send |
| `approved_by` | YES | User ID of the approver |
| `approved_at` | YES | Timestamp of approval |
| `approval_channel` | YES | 'slack' or 'copilot_chat' |
| `approval_latency_seconds` | YES | Time between preview and approval |
| `undo_window_used` | YES | Whether cancel was clicked during undo |
| `delivery_status` | YES | sent, cancelled, failed, expired |
| `failure_reason` | YES (if failed) | Error details (sanitized) |
| `send_method` | YES | gmail_api or office365_api |
| `composition_source` | YES | ai_generated, rep_provided, template, rep_edited |
| `daily_send_count` | YES | Send count at time of this send |
| `created_at` | YES | Audit record creation timestamp |
| `org_id` | YES | Organization identifier |

### What Is NOT Logged

- Email body plaintext (hashed only)
- OAuth tokens or refresh tokens
- Email signatures (contain personal contact info)
- Attachment contents (hashed only, if attachments are added in v2)
- Recipient personal details beyond email address

### Audit Retention

- Audit records are retained for 2 years minimum
- After 2 years, records are archived but not deleted
- Archived records can be retrieved by admin request
- No automated deletion of audit records

### Audit Access

| Role | Can View |
|------|----------|
| Rep (self) | Their own send history, including all audit fields |
| Org Admin | All reps' send history within their org |
| Platform Admin | All audit records (for security investigation) |
| Other reps | Nothing. Audit records are private to the sender. |

Audit access is itself logged -- who viewed what audit records, when.

## 7. Abuse Prevention

### Rate Limiting (Beyond Daily Limits)

In addition to daily send limits, enforce burst rate limiting:

| Window | Maximum | Purpose |
|--------|---------|---------|
| Per minute | 5 emails | Prevent rapid-fire sending |
| Per 10 minutes | 15 emails | Prevent sustained bursts |
| Per hour | 30 emails | Prevent hourly abuse |
| Per day | 50-200 (configurable) | Overall daily cap |

If a burst limit is hit, apply a cooldown:
- 1-minute limit hit: 60-second cooldown
- 10-minute limit hit: 5-minute cooldown
- Hourly limit hit: 30-minute cooldown

### Anomaly Detection

Flag unusual sending patterns for admin review:

| Pattern | Flag Level | Action |
|---------|-----------|--------|
| Sending at unusual hours (vs rep's history) | INFO | Log only |
| 2x the rep's average daily sends | WARNING | Notify admin |
| 3x the rep's average daily sends | ALERT | Notify admin, require admin approval for further sends |
| Sending to 10+ new recipients in an hour | WARNING | Notify admin |
| Multiple bounces in a short period | ALERT | Temporarily suspend sends, notify admin |
| Sending to competitors' domains | INFO | Log for admin review |
| Rapid approve-without-reading (< 2s between preview and approve) | WARNING | Log pattern, consider if approval is meaningful |

### Admin Override Capability

Org admins can:
- Suspend a specific user's send capability
- Lower a user's daily limit immediately
- Review audit logs for any user in their org
- Set org-wide send limits

Org admins cannot:
- Approve emails on behalf of a rep (approval is identity-bound)
- Access email body content (only hashes and metadata)
- Raise limits above the 200/day hard ceiling
- Disable the approval requirement

## 8. Thread Integrity Rules

### Never Break Threading

Email threading depends on headers being correct. Incorrect headers cause replies to appear as new emails in the recipient's inbox, which is confusing and unprofessional.

Rules:
1. **In-Reply-To** must contain the Message-ID of the specific message being replied to
2. **References** must contain all Message-IDs in the thread chain, space-separated
3. **Subject** must match the thread subject with `Re: ` prefix (do not stack multiple `Re: `)
4. **Thread-ID** (Gmail-specific) must be preserved for Gmail-to-Gmail threading

### Never Forge Headers

Do not fabricate, modify, or omit email headers to achieve a desired behavior:

- Do not set a fake Message-ID
- Do not set a From address different from the authenticated sender
- Do not set a Reply-To that differs from the From unless the rep explicitly configured it
- Do not modify Date headers
- Do not add X-headers that impersonate other email systems

### Thread Loading Requirements

Before composing a reply:
1. Fetch the complete thread from the email provider
2. Verify the thread_id matches an actual thread in the rep's mailbox
3. Extract the correct Message-ID from the last message for In-Reply-To
4. Build the complete References chain
5. If any thread data is missing or corrupt, warn the rep and offer to send as a new email instead

## 9. PII Handling in Logs

### The Core Rule

Email body content is NEVER stored in plaintext in audit logs, error logs, telemetry, or any logging system. The body is hashed (SHA-256) and only the hash is stored.

### What Constitutes PII in This Context

- Email body content (contains recipient's information, deal details, etc.)
- Email signatures (contain phone numbers, addresses)
- Attachment contents
- CC/BCC patterns that reveal organizational structure
- Thread content (contains historical conversation)

### Hashing Strategy

```
body_hash = SHA256(normalize(body))

Where normalize():
1. Strip leading/trailing whitespace
2. Normalize line endings to \n
3. Remove email signature (hash body only, not signature)
4. Lowercase (for consistent hashing regardless of case changes)
```

The hash allows:
- Verifying an email wasn't tampered with between approval and send
- Detecting duplicate sends (same body to same recipient)
- Audit trail integrity (can verify what was approved matches what was sent)

The hash does NOT allow:
- Reconstructing the email body
- Searching audit logs by email content
- Reading what was sent without access to the email provider

### Error Log Sanitization

When logging errors, sanitize all PII:

```
BAD:  "Failed to send email: body='Hi John, here's the pricing...' to='john@company.com'"
GOOD: "Failed to send email: body_hash='abc123' to='j***@company.com' error='SMTP_TIMEOUT'"
```

Error logs may contain:
- Body hashes
- Partially masked email addresses (for debugging)
- Error codes and messages from the email provider
- Timestamp and user_id

Error logs must NOT contain:
- Full email body
- Full email addresses (mask partially)
- OAuth tokens or credentials
- Full thread content

### Telemetry Data

Telemetry (for performance monitoring) may include:
- Send latency (time from API call to response)
- Approval latency (time from preview to approval)
- Body size in bytes (not the body itself)
- Success/failure rates
- Provider (Gmail vs O365)

Telemetry must NOT include any content or PII.

## 10. Emergency Stop Mechanism

### Per-User Disable

An org admin can immediately disable email sending for a specific user:

```
user_email_settings:
  email_send_enabled: false
  disabled_by: admin_user_id
  disabled_at: timestamp
  disabled_reason: "Suspicious activity detected"
```

When disabled:
- All pending approvals are expired immediately
- No new emails can be composed or sent
- The rep is notified via Slack: "Email sending has been temporarily disabled for your account. Contact your admin."
- Existing scheduled emails are held (not sent)

### Per-Org Disable

A platform admin can disable email sending for an entire organization:

```
organization_settings:
  email_send_enabled: false
  disabled_by: platform_admin_id
  disabled_at: timestamp
  disabled_reason: "Security investigation"
```

When disabled at org level:
- All users in the org are affected
- All pending approvals are expired
- Org admin is notified
- Setting overrides any per-user settings

### Re-Enable Process

1. Admin (org or platform) navigates to Settings > Email > Send Status
2. Reviews the disable reason and any investigation notes
3. Clicks "Re-enable email sending"
4. Confirms with a reason: "Investigation complete, no abuse found"
5. Email sending is immediately re-enabled
6. All users are notified via Slack
7. Previously scheduled emails are NOT auto-sent (must be re-approved)

### Automatic Disable Triggers

The system automatically disables email sending for a user if:

| Trigger | Action | Re-enable |
|---------|--------|-----------|
| 5+ bounces in 1 hour | Auto-disable user | Admin re-enable required |
| 10+ bounces in 1 day | Auto-disable user | Admin re-enable required |
| OAuth token revoked by provider | Auto-disable user | Re-auth required |
| Account flagged by email provider | Auto-disable org | Platform admin investigation required |
| 3x anomaly alerts in 24 hours | Auto-disable user | Admin review required |

### Emergency Stop vs Pause

- **Emergency stop** (admin action): Immediately kills all sending, expires pending approvals
- **Pause** (user action): Rep can pause their own sending via Settings. Pending approvals are preserved. They can resume at any time without admin involvement.

Both are logged in the audit trail.

## Summary of Non-Negotiable Rules

1. Every email requires explicit, specific, authenticated human approval
2. Approval expires after 30 minutes
3. The undo window is always at least 10 seconds
4. Daily send limit hard ceiling is 200
5. Email body is never stored in plaintext in logs
6. OAuth tokens are never logged
7. Thread headers must be accurate (never forged, never fabricated)
8. Admins cannot approve emails on behalf of reps
9. The approval requirement cannot be disabled
10. Emergency stop is always available and takes effect immediately
